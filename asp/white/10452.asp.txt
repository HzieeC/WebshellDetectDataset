<%@LANGUAGE="VBSCRIPT" CODEPAGE="936"%>
<!--#include file="inc/conndb.asa"-->
<!--#include file="inc/function.asp"-->
<!--#include file="inc/jle_sub.asp"-->
<%
PageShowSize = 10            '每页显示多少个页
MyPageSize   = 40        '每页显示多少条
	
If Not IsNumeric(Request("Curpage")) Or IsEmpty(Request("Curpage")) Or Request("Curpage") <=0 Then
MyPage=1
Else
MyPage=Int(Abs(Request("Curpage")))
End if
%>
<%
comurl=Cstr(Request.ServerVariables("HTTP_REFERER"))
If IsAdmin<>9 Then 
response.write backmsg("您不是管理员或者尚未登录","UserMng.asp")
End If 
Page_WebTitle="管理中心-"&TieBa_Name
now_where="管理中心"
currWZ=now_where
navright=" "

'启用模板类
BoardListStr=BoardList(BoardID)
set getTemplate = new Cls_Template
shtml=getTemplate("ddp_head")
'页面全局变量、普通变量替换
shtml=replace(shtml,"$Page_WebTitle$",Page_WebTitle)
shtml=replace(shtml,"$Page_Author$",Page_Author)
shtml=replace(shtml,"$Page_Keywords$",Page_Keywords)
shtml=replace(shtml,"$Page_Description$",Page_Description)
shtml=replace(shtml,"$kdhLink$",dhLink())
shtml=replace(shtml,"$topmenu$",topmenu())
shtml=replace(shtml,"$bar_FriendLink$",FriendLink())
shtml=replace(shtml,"$BoardListStr$",BoardListStr)
shtml=replace(shtml,"$now_where$",now_where)
shtml=replace(shtml,"$NavRight$",NavRight)
response.write shtml
	response.write ("")
	%>
    
<div id="subadmin">
  <ul>
    <li><A HREF="AdminManage.asp?Action=sitemanage1">基本设置</A></li>
     
    <li><A HREF="AdminManage.asp?Action=boardlists">分类管理</A></li>
    
    <li><A HREF="AdminManage.asp?Action=friendlink">友情链接</A></li>
    
    <li><A HREF="AdminManage.asp?Action=k114link">都市114</A></li>
 
    <li><A HREF="AdminManage.asp?Action=jletxt2">免责申明</A></li>
    <li><A HREF="AdminManage.asp?Action=jletxt3">广告服务</A></li>
    
    <li><A HREF="AdminManage.asp?Action=jletxt5">帮助信息</A></li>
    
<li><A HREF="AdminManage.asp?Action=RepairBBS">数据修复</A></li>
    <li><a href="AdminManage.asp?Action=dbak">数据库</a></li>
    <li><A HREF="AdminManage.asp?Action=dustBin">回收站</A></li>
    <li><A HREF="AdminManage.asp?Action=ddpPlus">插件管理</A></li>
    <li><A HREF="AdminManage.asp?Action=attach">附件管理</A></li>
  </ul>
</div>

<%	response.write ("")%>

<%
Dim Action
Dim i
Dim flg
    Action=Checkstr(Request.QueryString("Action"))
	Select Case Action
        Case "boardedit"
            Call BoardLists()
        Case "boardsave"
		    Call BoardSave()
		Case "boardlists"
		    Call boardlists()
		Case "boardup"
		    Call boardup()
		Case "boarddown"
		    Call boarddown()
		Case "boarddel"
		    Call boarddel()
		Case "stopip"
		    Call stopip()
		Case "userList"
		    Call UserList()
		Case "dustBin"
		    Call dustBin()
		Case "ReList"
		    Call ReList()
		Case "friendlink"
		    Call friendlink()
		Case "dhlink1"
		    Call dhlink1()
		Case "topmenu1"
		    Call topmenu1()
		Case "k114link"
		    Call k114link()
		Case "topmenu"
		    Call topmenu()
		Case "sitemanage1"
			Call sitemanage1()
		Case "sitemanage2"
			Call sitemanage2()
		Case "dbak"
			Call dbak()
		Case "attach"
			Call attach()
		Case "ddpPlus"
			Call ddpPlus()
		Case "RepairBBS"
			Call RepairBBS()
		Case "jletxt1"
			Call jletxt1()
		Case "jletxt2"
			Call jletxt2()
		Case "jletxt3"
			Call jletxt3()
	    Case "jletxt4"
			Call jletxt4()
		Case "jletxt5"
			Call jletxt5()
		Case Else 
			Call sitemanage1()
    End Select
	response.write ("<br><br>")

shtml=getTemplate("ddp_foot")
shtml=replace(shtml,"$SQLQueryNums$",SQLQueryNums)
shtml=replace(shtml,"$runTime$",runTime)
response.write shtml


%>


<%
Sub dhlink1()
cls=Checkstr(trim(Request.QueryString("cls")))
lid=CheckNum(trim(Request.QueryString("id")))
Select case cls
case ""
case "del"
	conn.execute("Delete  From dhlink Where id="&lid)
	response.write backmsg("恭喜，链接删除成功！","AdminManage.asp?Action=dhlink")
case "up"
Link_order=checkStr(Request.QueryString("link_order"))
	Dim OldOrders,NewOrders
	Set Rs=Server.CreateObject("ADODB.RecordSet")
	Sql="SELECT TOP 2 link_order from  dhlink WHERE link_order>="&link_order&" ORDER BY link_order"
	Rs.Open SQL,Conn,1,3
	If Not (Rs.EOF Or Rs.BOF) Then
		OldOrders=rs("link_order")
		Rs.MoveNext
		If Not (Rs.EOF Or  Rs.BOF) Then
			NewOrders=Rs("link_order")
			Rs("link_order")=OldOrders
			Rs.Update
			Rs.MovePrevious
			Rs("link_order")=NewOrders
			Rs.Update
		End If
	End If
	Rs.Close
	Set Rs=Nothing
	Response.Redirect "AdminManage.asp?Action=dhlink"
case "down"
link_order=checkStr(Request.QueryString("link_order"))
	Set Rs=Server.CreateObject("ADODB.RecordSet")
	Sql="SELECT TOP 2 link_order from dhlink WHERE link_order<="&link_order&" ORDER BY link_order desc"
	Rs.Open SQL,Conn,1,3
	If Not (Rs.EOF Or Rs.BOF) Then
		OldOrders=rs("link_order")
		Rs.MoveNext
		If Not (Rs.EOF Or  Rs.BOF) Then
			NewOrders=Rs("link_order")
			Rs("link_order")=OldOrders
			Rs.Update
			Rs.MovePrevious
			Rs("link_order")=NewOrders
			Rs.Update
		End If
	End If
	Rs.Close
	Set Rs=Nothing
	Response.Redirect "AdminManage.asp?Action=dhlink"
case "save"

id=Request.Form("fid")
Link_name=CStr(Request.Form("Link_name"))
Link_info=Request.Form("Link_info")
Link_url=Request.Form("Link_url")

If Link_name="" Or Len(Link_name)>100 Then response.write backmsg("名称太短或者太长","")
If Link_info="" Or Len(Link_info)>200 Then response.write backmsg("说明太短或者太长","")
If Link_url="" Or Len(Link_info)>200 Then response.write backmsg("地址太短或者太长","")
Set rs = Server.CreateObject("ADODB.Recordset")
'判断是修改还是添加
If id="" Or id=0 Then'如果是添加
		'这里首先要读取最大排序数字，为的是给新添加的排序字段有数据输入。
		Set Rs77=Conn.Execute("SELECT Max(Link_order) FROM dhlink")
			If Rs77.EOF Or Rs77.BOF Then 
				Link_order=1
			Else
				Link_order=Rs77(0)+1
			End If
		If IsNull(Link_order) Then Link_order=1
		'读取排序号结束。
acts="添加"
sql = "SELECT * FROM dhlink where (id is null)" 
rs.OPEN sql,Conn,1,3
rs.addnew
rs("Link_order")=Link_order
Else
acts="修改"
sql = "SELECT * FROM dhlink where id="&id 
rs.OPEN sql,Conn,1,3
End If 
rs("Link_name")=Link_name
rs("Link_url")=Link_url
rs("Link_info")=Link_info
rs.update
rs.close
set rs=Nothing
conn.close
set conn=nothing
response.write backmsg("恭喜，链接"&acts&"成功！","AdminManage.asp?Action=dhlink1")
End Select 
%>
<div class="admintitleft">文字连接管理</div>
<table class="cssraindemo1" id="table1">
     <thead><tr>
    <th  height="24">ID</th>
    <th width="172" height="24" >名称(点击进入修改)</th>
    <th width="200" height="24">简介</th>
    <th width="200" height="24" >地址</th>
    <th width="32" height="24" >排序</th>
    <th width="84" height="24">操作</th>
  </tr></thead><body>
  <%set rs2=server.CreateObject("adodb.recordset")
sql="select * from dhlink where link_type=0 order by link_order desc,id desc"
rs2.open sql,conn,1,1
do while not rs2.eof
%>
  <tr >
    <td height="24" ><%=rs2("id")%></td>
    <td ><a href="AdminManage.asp?Action=dhlink1&cls=edit&id=<%=rs2("id")%>"><%=rs2("link_name")%></a></td>
    <td ><%=left(trim(rs2("link_info")),100)%></td>
    <td ><a href="<%=trim(rs2("link_url"))%>" target=_blank><%=trim(rs2("link_url"))%></a></td>
    <td ><a href="AdminManage.asp?Action=dhlink1&cls=up&link_order=<%=rs2("link_order")%>">↑</a> <a href="AdminManage.asp?Action=dhlink1&cls=down&link_order=<%=rs2("link_order")%>">↓</a></td>
    <td><a href="AdminManage.asp?Action=dhlink1&cls=del&id=<%=rs2("id")%>">删除</a></td>
  </tr>
  <%rs2.movenext
	loop%></body>
</table>
</tr>
<%
If cls="edit" And lid<>"" Then
shuoming="编辑"
set rs2=server.CreateObject("adodb.recordset")
sql="select * from dhlink where id="&lid
rs2.open sql,conn,1,1
If rs2.eof Or rs2.bof Then 
Call backmsg("参数错误或者无此链接","")
Else
link_name=rs2("link_name")
link_url=rs2("link_url")
link_info=rs2("link_info")
End If
Else
shuoming="新增加"
End If 
%>
<BR>
<CENTER>
  <B><%=shuoming%>链接</B>
</CENTER>
<form name='form1' method='post' action='AdminManage.asp?Action=dhlink1&cls=save'>
  <table class="cssraindemo1" id="table1">
     <thead><tr>
      <th   height="24">ID</th>
      <th width="172" height="24" class="admintopbg">名称</th>
      <th width="200" height="24" class="admintopbg">简介</th>
      <th width="200" height="24" class="admintopbg">地址</th>
      <th width="32" height="24" class="admintopbg">排序</th>
      <th width="84" height="24" class="admintopbg">操作</th>
    </tr></thead><body>
    <tr >
      <td width="26" height="24" ><input name="fid" type="hidden" id="id" value="<%=lid%>"></td>
      <td width="172" height="24" ><input name="link_name" type="text" id="link_name" size="20" maxlength="20" value="<%=link_name%>"></td>
      <td width="200" height="24" ><input name="link_info" type="text" id="link_info" size="20" maxlength="200" value="<%=link_info%>"></td>
      <td width="200" height="24" ><input name="link_url" type="text" id="link_url" size="20" maxlength="200" value="<%=link_url%>"></td>
      <td width="32" height="24" >排序</td>
      <td width="84" height="24" ><input type='submit' name='Submit' value='<%=shuoming%> 提交'></td>
    </tr></body>
  </table>
</form>
<!--114导航链接区-->
<%
End Sub

Sub k114link()
cls=Checkstr(trim(Request.QueryString("cls")))
lid=CheckNum(trim(Request.QueryString("id")))
Select case cls
case ""
case "del"
	conn.execute("Delete  From 114link Where id="&lid)
	response.write backmsg("恭喜，链接删除成功！","AdminManage.asp?Action=k114link")
case "up"
Link_order=checkStr(Request.QueryString("link_order"))
	Dim OldOrders,NewOrders
	Set Rs=Server.CreateObject("ADODB.RecordSet")
	Sql="SELECT TOP 2 link_order from  114link WHERE link_order>="&link_order&" ORDER BY link_order"
	Rs.Open SQL,Conn,1,3
	If Not (Rs.EOF Or Rs.BOF) Then
		OldOrders=rs("link_order")
		Rs.MoveNext
		If Not (Rs.EOF Or  Rs.BOF) Then
			NewOrders=Rs("link_order")
			Rs("link_order")=OldOrders
			Rs.Update
			Rs.MovePrevious
			Rs("link_order")=NewOrders
			Rs.Update
		End If
	End If
	Rs.Close
	Set Rs=Nothing
	Response.Redirect "AdminManage.asp?Action=k114link"
case "down"
link_order=checkStr(Request.QueryString("link_order"))
	Set Rs=Server.CreateObject("ADODB.RecordSet")
	Sql="SELECT TOP 2 link_order from 114link WHERE link_order<="&link_order&" ORDER BY link_order desc"
	Rs.Open SQL,Conn,1,3
	If Not (Rs.EOF Or Rs.BOF) Then
		OldOrders=rs("link_order")
		Rs.MoveNext
		If Not (Rs.EOF Or  Rs.BOF) Then
			NewOrders=Rs("link_order")
			Rs("link_order")=OldOrders
			Rs.Update
			Rs.MovePrevious
			Rs("link_order")=NewOrders
			Rs.Update
		End If
	End If
	Rs.Close
	Set Rs=Nothing
	Response.Redirect "AdminManage.asp?Action=k114link"
case "save"

id=Request.Form("fid")
Link_name=CStr(Request.Form("Link_name"))
Link_info=Request.Form("Link_info")
Link_url=Request.Form("Link_url")

If Link_name="" Or Len(Link_name)>100 Then response.write backmsg("名称太短或者太长","")
If Link_info="" Or Len(Link_info)>200 Then response.write backmsg("说明太短或者太长","")
If Link_url="" Or Len(Link_info)>200 Then response.write backmsg("地址太短或者太长","")
Set rs = Server.CreateObject("ADODB.Recordset")
'判断是修改还是添加
If id="" Or id=0 Then'如果是添加
		'这里首先要读取最大排序数字，为的是给新添加的排序字段有数据输入。
		Set Rs77=Conn.Execute("SELECT Max(Link_order) FROM 114link")
			If Rs77.EOF Or Rs77.BOF Then 
				Link_order=1
			Else
				Link_order=Rs77(0)+1
			End If
		If IsNull(Link_order) Then Link_order=1
		'读取排序号结束。
acts="添加"
sql = "SELECT * FROM 114link where (id is null)" 
rs.OPEN sql,Conn,1,3
rs.addnew
rs("Link_order")=Link_order
Else
acts="修改"
sql = "SELECT * FROM 114link where id="&id 
rs.OPEN sql,Conn,1,3
End If 
rs("Link_name")=Link_name
rs("Link_url")=Link_url
rs("Link_info")=Link_info
rs.update
rs.close
set rs=Nothing
conn.close
set conn=nothing
response.write backmsg("恭喜，链接"&acts&"成功！","AdminManage.asp?Action=k114link")
End Select 
%>
<div class="admintitleft">都市114信息管理</div>
<table class="cssraindemo1" id="table1">
     <thead>
     <tr>
    <th height="24">ID</th>
    <th width="172" height="24">名称(点击进入修改)</th>
    <th width="200" height="24">简介</th>
    <th width="200" height="24">地址</th>
    <th width="32" height="24" >排序</th>
    <th width="84" height="24">操作</th>
  </tr>
  </thead><body>
  <%set rs2=server.CreateObject("adodb.recordset")
sql="select * from 114link where link_type=0 order by link_order desc,id desc"
rs2.open sql,conn,1,1
do while not rs2.eof
%>
  <tr>
    <td height="24" ><%=rs2("id")%></td>
    <td ><a href="AdminManage.asp?Action=k114link&cls=edit&id=<%=rs2("id")%>"><%=rs2("link_name")%></a></td>
    <td ><%=left(trim(rs2("link_info")),100)%></td>
    <td ><a href="<%=trim(rs2("link_url"))%>" target=_blank><%=trim(rs2("link_url"))%></a></td>
    <td ><a href="AdminManage.asp?Action=k114link&cls=up&link_order=<%=rs2("link_order")%>">↑</a> <a href="AdminManage.asp?Action=k114link&cls=down&link_order=<%=rs2("link_order")%>">↓</a></td>
    <td ><a href="AdminManage.asp?Action=k114link&cls=del&id=<%=rs2("id")%>">删除</a></td>
  </tr>
  <%rs2.movenext
	loop%></body>
</table>
</tr>
<%
If cls="edit" And lid<>"" Then
shuoming="编辑"
set rs2=server.CreateObject("adodb.recordset")
sql="select * from 114link where id="&lid
rs2.open sql,conn,1,1
If rs2.eof Or rs2.bof Then 
Call backmsg("参数错误或者无此链接","")
Else
link_name=rs2("link_name")
link_url=rs2("link_url")
link_info=rs2("link_info")
End If
Else
shuoming="新增加"
End If 
%>
<BR>
<CENTER>
  <B><%=shuoming%>链接</B>
</CENTER>
<form name='form1' method='post' action='AdminManage.asp?Action=k114link&cls=save'>
<table class="cssraindemo1" id="table1">
     <thead>
    <tr>
    <th  height="24">ID</th>
    <th width="172" height="24">名称</th>
    <th width="200" height="24" >简介</th>
    <th width="200" height="24">地址</th>
    <th width="32" height="24">排序</th>
    <th width="84" height="24">操作</th>
  </tr>
  </thead>
  <body>
  <tr>
    <td width="26" height="24" ><input name="fid" type="hidden" id="id" value="<%=lid%>"></td>
    <td width="172" height="24" ><input name="link_name" type="text" id="link_name" size="20" maxlength="20" value="<%=link_name%>"></td>
    <td width="200" height="24" ><input name="link_info" type="text" id="link_info" size="20" maxlength="200" value="<%=link_info%>"></td>
    <td width="200" height="24" ><input name="link_url" type="text" id="link_url" size="20" maxlength="200" value="<%=link_url%>"></td>
    <td width="32" height="24" >排序</td>
    <td width="84" height="24"><input type='submit' name='Submit' value='<%=shuoming%> 提交'></td>
  </tr>
  </body>
</table></form>
<%
End Sub 
Sub sitemanage1()
cls=Checkstr(Request.QueryString("cls"))
If cls="save" Then
	TieBa_Name_modify=Trim(Request.Form("TieBa_Name"))'网站名称
	TieBa_Url_modify=Trim(Request.Form("TieBa_Url"))'网站TieBa_Url
	Sys_Admin_modify=Trim(Request.Form("Sys_Admin"))'管理员。
	Sys_skins_modify=Trim(Request.Form("Sys_skins"))'风格。
	Sys_BadWords_modify=Trim(Request.Form("Sys_BadWords"))'脏话过滤[标题和内容]
	Sys_ADWords_modify=Trim(Request.Form("Sys_ADWords"))'广告过滤
	Sys_KeepName_modify =Trim(Request.Form("Sys_KeepName")) '被保留的用户名
	sys_close_modify = Request.Form("sys_close1")&Trim(Request.Form("sys_close2"))'系统是否关闭 0,开放；1，关闭； + 关闭原因
    Sys_bottom_modify=Trim(Request.Form("Sys_bottom"))'风格。
	Sys_tel_modify=Trim(Request.Form("Sys_tel"))'风格。
	Sys_Default_Money_modify=CInt(Request.Form("Sys_Default_Money"))'注册初始论坛分数
	Sys_Add_Money_modify=CInt(Request.Form("Sys_Add_Money"))'发布文章分数
	Sys_Re_Money_modify=CInt(Request.Form("Sys_Re_Money"))'回复文章分数
	Sys_Del_Money_modify=CInt(Request.Form("Sys_Del_Money"))'删除文章分数
	Sys_Good_Money_modify=CInt(Request.Form("Sys_Good_Money"))'文章被推荐分数
	Sys_List_Num_modify=CInt(Request.Form("Sys_List_Num"))'首页每页显示条数
	Sys_Show_Num_modify=CInt(Request.Form("Sys_Show_Num"))'帖子每页显示条数
	Sys_PostTime_modify=CInt(Request.Form("Sys_PostTime"))'发帖防止灌水时间，单位：秒
	Sys_Guest_Add_modify=CInt(Request.Form("Sys_Guest_Add")) '游客是否可以发贴
	Sys_Guest_Re_modify=CInt(Request.Form("Sys_Guest_Re")) '游客是否可以回复


	Sys_uploadMoney_modify=CInt(Request.Form("Sys_uploadMoney"))'多少分才可以上传图片
	Sys_ModMoney_modify=CInt(Request.Form("Sys_ModMoney"))'多少分才可以自定义头像？建议大于上传图片分数
	Sys_DyTime_modify=CInt(Request.Form("Sys_DyTime"))'侧边栏调用多少天之内的各种帖子？
	Sys_RegTime_modify=CInt(Request.Form("Sys_RegTime")) '多少分钟后才可以同一个电脑注册？
	Sys_EditTime_modify=CInt(Request.Form("Sys_EditTime")) '多长时间以后修改帖子将自动增加 被xx修改过（仅限管理员和普通作者）

	Sys_MaxOnline_modify=CInt(Request.Form("Sys_MaxOnline"))'最大显示的在线人数
	Sys_UserCheck_modify=CInt(Request.Form("Sys_UserCheck"))'新注册用户是否需要审核----0需要审核1自动审核
	Sys_IsCheck_modify=CInt(Request.Form("Sys_IsCheck"))'会员发帖子是否需要审核------0需要审核1自动审核
	Sys_GuestIsCheck_modify=CInt(Request.Form("Sys_GuestIsCheck"))'游客发帖是否需要审核---0审核，1，自动审核
	Sys_isuserinfo_modify=CInt(Request.Form("Sys_isuserinfo"))'必须登陆才能察看用户信息．1是任何人可以看，0为登陆察看。
	Sys_isShowIpName_modify=CInt(Request.Form("Sys_isShowIpName"))'0:不显示IP的详细位置 1:按纯真数据库进行显示(来自于外部数据)


	Sys_HitsSession_modify=CInt(Request.Form("HitsSession"))'点击率阈值 22
	Sys_isReView_modify=CInt(Request.Form("Sys_isReView"))'是否回复可见 23
	Sys_loginTime_modify=CInt(Request.Form("Sys_loginTime"))'多少分钟重复登录不计算次数 24
	Sys_loginMoney_modify=CInt(Request.Form("Sys_loginMoney"))'登录送积分 25


Sys_Config_modify=Sys_Default_Money_modify &"|"& Sys_Add_Money_modify &"|"& Sys_Re_Money_modify &"|"& Sys_Del_Money_modify &"|"&Sys_Good_Money_modify&"|"&_
Sys_List_Num_modify &"|"& Sys_Show_Num_modify &"|"& Sys_PostTime_modify &"|"& Sys_Guest_Add_modify &"|"& Sys_Guest_Re_modify&"|"&_
Sys_uploadMoney_modify &"|"& Sys_ModMoney_modify &"|"& Sys_DyTime_modify &"|"& Sys_RegTime_modify &"|"& Sys_EditTime_modify &"|"&_
Sys_MaxOnline_modify &"|"& Sys_UserCheck_modify &"|"& Sys_IsCheck_modify &"|"& Sys_GuestIsCheck_modify &"|"& Sys_isuserinfo_modify &"|"&_
Sys_isShowIpName_modify&"|0|"&Sys_HitsSession_modify&"|"&Sys_isReView_modify&"|"&Sys_loginTime_modify&"|"&Sys_loginMoney_modify&"|26|27|28|29|30|31|32|33|34"

If Dreamsun_name<>"" And isadmin=9 And InStr(Sys_Admin_modify,Dreamsun_name)=0 Then 
	response.write backmsg("您目前是最高管理员,出于安全考虑,请不要试图降低自己的权限!","")
End If

Set rs99 = Server.CreateObject("ADODB.Recordset")
sql99 ="SELECT * From "&configtable&" where id=1"
	rs99.open sql99,Conn,3,3
	rs99("TieBa_Name") =TieBa_Name_modify
	rs99("TieBa_Url")=TieBa_Url_modify
	rs99("Sys_Admin") =Sys_Admin_modify
	rs99("Sys_skins")=Sys_skins_modify
	rs99("Sys_BadWords")=Sys_BadWords_modify
	rs99("Sys_ADWords")=Sys_ADWords_modify
	rs99("Sys_KeepName") =Sys_KeepName_modify
	rs99("Sys_close") =Sys_close_modify
	rs99("Sys_bottom") =Sys_bottom_modify
	rs99("Sys_tel") =Sys_tel_modify
	
rs99.update
rs99.close
set rs99=Nothing
Application(webname&"CacheTime")="2010-3-1 12:12:12"
response.write backmsg("恭喜，站点参数成功！","AdminManage.asp?Action=sitemanage1")
End If 

%>
<div class="admintitleft">网站基本信息管理</div>
<form name="form13" method='post' action='AdminManage.asp?Action=sitemanage1&cls=save'>
  <table class="cssraindemo1" id="table1">
     <thead><tr>
      <th  height="24" align=right>名称</th>
      <th width="860" height="24" align=center>参数</th>
    </tr></thead><body>
    <tr height="24">
      <td width="217" height="27" align=right class="font2">贴吧名称</td>
      <td width="860" height="27" align=left ><input name="TieBa_Name" type="text" id="TieBa_Name" size="30" maxlength="30" value="<%=TieBa_Name%>">
        *网站的名称，例如：惠阳信息网</td>
    </tr>
    <tr  height="24">
      <td width="217" height="27" align=right  class="font2">站点地址</td>
      <td width="860" height="27" align=left><input name="TieBa_Url" type="text" id="TieBa_Url" size="30" maxlength="150" value="<%=TieBa_Url%>">
        *例如：http://www.75200.net</td>
    </tr>
    
   
    <tr  height="24">
      <td width="217" height="27" align=right class="font2">风格文件夹</td>
      <td width="860" height="27" align=left ><select name='Sys_skins'>
          <%
	Set FSO=Server.CreateObject("Scripting.FileSystemObject")
	set objFolder=FSO.GetFolder(server.Mappath("skins/"))
	set objSubFolders=objFolder.Subfolders
	for each objSubFolder in objSubFolders
		response.write "<option value="""&objSubFolder.name&""""
		If Sys_skins=objSubFolder.name then Response.Write " selected"
		'处理xml文件
		'Set fso=Server.CreateObject("Scripting.FileSystemObject")
		strSourceFile = Server.MapPath("skins/"&objSubFolder.name&"\default.xml")
			If fso.FileExists(strSourceFile) Then
				set xmldoc=Server.createObject("Microsoft.XMLDOM")
				xmldoc.load(strSourceFile)
				set nodes=xmldoc.selectNodes("templates")
				IsSideBar=nodes(0).selectSingleNode("ddp_skin").text
				SkinName=nodes(0).selectSingleNode("ddp_skin").text
			Else
				IsSideBar=True
				SkinName=objSubFolder.name
			End If 
		Set nodes=nothing
		Set xmldoc=nothing
		'Set fso=nothing
		'处理xml文件结束
		response.write">"&SkinName&"</option>"
	next 
	set objFolder=nothing
	set objSubFolders=nothing
	set fso=nothing
	%>
        </select>
        *请将符合条件的风格包放入skins文件夹 
    </tr>
    <tr  height="24">
      <td width="217" align=right class="font2">积分数值</td>
      <td width="860" align=left>&middot;注册后获得
        <input name="Sys_Default_Money" type="text" id="Sys_Default_Money" size="5" maxlength="5" value="<%=Sys_Default_Money%>">
        分<br /><hr size="0">
        &middot;发贴可获得
<input name="Sys_Add_Money" type="text" id="Sys_Add_Money" size="5" maxlength="5" value="<%=Sys_Add_Money%>">
        分<br /><hr size="0">
&middot;回帖可获得
<input name="Sys_Re_Money" type="text" id="Sys_Re_Money" size="5" maxlength="5" value="<%=Sys_Re_Money%>">
        分 <br><hr size="0">
        &middot;帖子被删除后扣除
<input name="Sys_Del_Money" type="text" id="Sys_Del_Money" size="5" maxlength="5" value="<%=Sys_Del_Money%>">
        分<br /><hr size="0">
&middot;帖子被推荐为精华时加
<input name="Sys_Good_Money" type="text" id="Sys_Good_Money" size="5" maxlength="5" value="<%=Sys_Good_Money%>">
        分<br /><hr size="0">
        &middot;有效登录送
<input name="Sys_loginMoney" type="text" id="Sys_loginMoney" size="5" maxlength="5" value="<%=Sys_loginMoney%>">
        积分 </td>
    </tr>
    <tr height="24">
      <td width="217" align=right  class="font2">显示设置</td>
      <td width="860" align=left > 列表页每页显示
        <input name="Sys_List_Num" type="text" id="Sys_List_Num" size="5" maxlength="5" value="<%=Sys_List_Num%>">
        条帖子<br /><hr size="0">
详细页每页显示
<input name="Sys_Show_Num" type="text" id="Sys_Show_Num" size="5" maxlength="5" value="<%=Sys_Show_Num%>">
        条回复， </td>
    </tr>
    <tr height="24">
      <td width="217" height="36" align=right class="font2">点击次数阈值</td>
      <td width="860" align=left><input name="HitsSession" type="text" id="HitsSession" size="5" maxlength="5" value="<%=HitsSession%>">
        *0：可刷新，一次一个；1-N：防刷新，一次1~N随机个。比如8，就是防刷新，每次增1-8随机 </td>
    </tr>
    <tr  height="24">
      <td width="217" align=right class="font2">时间限制</td>
      <td width="860" align=left><input name="Sys_loginTime" type="text" id="Sys_loginTime" size="5" maxlength="5" value="<%=Sys_loginTime%>">
        分钟内重复登录不计算<br /><hr size="0">
        发帖回帖防止刷新时间
<input name="Sys_PostTime" type="text" id="Sys_PostTime" size="5" maxlength="5" value="<%=Sys_PostTime%>">
        秒，<br /><hr size="0">
        同一个电脑注册限制时间
<input name="Sys_RegTime" type="text" id="Sys_RegTime" size="5" maxlength="5" value="<%=Sys_RegTime%>">
        分钟<BR><hr size="0">
        修改帖子将增加修改记录时间为
        <input name="Sys_EditTime" type="text" id="Sys_EditTime" size="5" maxlength="5" value="<%=Sys_EditTime%>">
        分钟后<br /><hr size="0">
        侧边栏调用帖子为
<input name="Sys_DyTime" type="text" id="Sys_DyTime" size="5" maxlength="5" value="<%=Sys_DyTime%>">
        天之内。 </td>
    </tr>
    <tr  height="24">
      <td width="217" align=right b class="font2">在线列表极限</td>
      <td width="860" align=left ><input name="Sys_MaxOnline" type="text" size="8" value="<%=Sys_MaxOnline%>">
        人，输入0~100间的数字，在线列表统计人数，0为不显示列表。</td>
    </tr>
    <tr >
      <td align="right"  class="font2"> 系统状态 </td>
      <td ><select name='sys_close1'>
          <option value="0" <% if Left(sys_close,1)="0" then Response.Write "selected"%>>系统正常运行</option>
          <option value="1" <% if Left(sys_close,1)="1" then Response.Write "selected"%>>系统暂停</option>
        </select>
        ， 系统暂停原因：
        <input type="text" name="sys_close2" value="<%if len(sys_close)>0 then Response.Write(Right(sys_close,len(sys_close)-1))%>">
        。 </td>
    </tr>
    <tr >
      <td align="right"  class="font2"> 验证权限 </td>
      <td ><select name="Sys_Guest_Add">
          <option value="0" <% If Sys_Guest_Add<>1 Then response.write "selected"%>>不允许</option>
          <Option value="1" <% If Sys_Guest_Add=1 Then response.write "selected"%>>允许</option>
        </select>
        游客发贴，
        <select name="Sys_Guest_Re">
          <option value="0" <% If Sys_Guest_Re<>1 Then response.write "selected"%>>不允许</option>
          <Option value="1" <% If Sys_Guest_Re=1 Then response.write "selected"%>>允许</option>
        </select>
        游客回复。
        <hr size="0">
        用户注册
        <select name="Sys_UserCheck">
          <option value="0" <% If Cstr(Sys_UserCheck)="0" Then response.write "selected"%>>需要审核</option>
          <option value="1" <% If Cstr(Sys_UserCheck)="1" Then response.write "selected"%>>直接通过</option>
        </select>
        。
        用户发帖
        <select name="Sys_IsCheck">
          <option value="0" <% If Cstr(Sys_IsCheck)="0" Then response.write "selected"%>>需要审核</option>
          <option value="1" <% If Cstr(Sys_IsCheck)="1" Then response.write "selected"%>>直接通过</option>
        </select>
        。
        游客发帖
        <select name="Sys_GuestIsCheck">
          <option value="0" <% If Cstr(Sys_GuestIsCheck)="0" Then response.write "selected"%>>需要审核</option>
          <option value="1" <% If Cstr(Sys_GuestIsCheck)="1" Then response.write "selected"%>>直接通过</option>
        </select>
        。
        <hr size="0">
        <select name="Sys_isuserinfo">
          <option value="0" <% If Sys_isuserinfo<>1 Then response.write "selected"%>>登陆后可查看</option>
          <Option value="1" <% If Sys_isuserinfo=1 Then response.write "selected"%>>游客可查看</option>
        </select>
        用户信息，
        <select name="Sys_isShowIpName">
          <option value="0" <% If Sys_isShowIpName<>1 Then response.write "selected"%>>不允许</option>
          <Option value="1" <% If Sys_isShowIpName=1 Then response.write "selected"%>>允许</option>
        </select>
        查看ip地址归属地。
        <hr size="0">
        发帖是否允许使用【回复可见】道具
        <select name="Sys_isReView">
          <option value="0" <% If Sys_isReView<>1 Then response.write "selected"%>>不允许</option>
          <Option value="1" <% If Sys_isReView=1 Then response.write "selected"%>>允许</option>
      </select></td>
    </tr>
    <tr  height="24">
      <td width="217" align=right  class="font2">上传权限</td>
      <td width="860" align=left ><input name="Sys_uploadMoney" type="text" id="Sys_uploadMoney" size="5" maxlength="5" value="<%=Sys_uploadMoney%>">
        分以上可以上传图片，
        <input name="Sys_ModMoney" type="text" id="Sys_ModMoney" size="5" maxlength="5" value="<%=Sys_ModMoney%>">
        分才可以自定义头像――建议大于上传图片分数 </td>
    </tr>
<tr height="24">
      <td width="217" align=right class="font2">保留用户名</td>
      <td width="860" align=left ><textarea rows="5" name="Sys_KeepName" cols="45"><%=Sys_KeepName%></textarea>
        请用|分割，最后不要输入|。←<a href="javascript:" onClick="document.form13.Sys_KeepName.value+='|'">点此插入|</a></td>
    </tr>
    <tr height="24">
      <td width="217" align=right  class="font2">防御广告帖</td>
      <td width="860" align=left ><textarea rows="5" name="Sys_ADWords" cols="45"><%=Sys_ADWords%></textarea>
        请用|分割，最后不要输入|。←<a href="javascript:" onClick="document.form13.Sys_ADWords.value+='|'">点此插入|</a></td>
    </tr>
    <tr height="24">
      <td width="217" align=right class="font2">脏话过滤</td>
      <td width="860" align=left ><textarea rows="5" name="Sys_BadWords" cols="45"><%=Sys_BadWords%></textarea>
        请用|分割，最后不要输入|。←<a href="javascript:" onClick="document.form13.Sys_BadWords.value+='|'">点此插入|</a></td>
    </tr>
     <tr height="24">
      <td width="217" align=right class="font2">网站底部信息</td>
      <td width="860" align=left ><textarea rows="5" name="Sys_bottom" cols="45"><%=Sys_bottom%></textarea>
        包括联系方式电话 qq 邮箱 icp备案号 统计代码 等等。</td>
    </tr>
    <tr  height="24">
      <td width="217" height="27" align=right  class="font2">联系电话调用</td>
      <td width="860" height="27" align=left><input name="Sys_tel" type="text" id="Sys_tel" size="30" maxlength="150" value="<%=Sys_tel%>">
        *例如：0431-88888888</td>
    </tr>
    <tr height="24">
      <td  align=center colspan=2><input type='button' name='Submit' onClick="form13.submit();" value='修改提交'>
        <input type="reset"  value="取消修改"></td>
    </tr>
   
  </table>
</form>
<script>Get_Notice(0);</script>
<%
End Sub 


Sub sitemanage2()
cls2=Checkstr(Request.QueryString("cls2"))
If cls2="save" Then

	TieBa_AD_Top_modify = Trim(Request.Form("TieBa_AD_Top"))'顶部广告
	TieBa_AD_Tie_modify = " "&Trim(Request.Form("TieBa_AD_Tie1")) & "|@|" & Trim(Request.Form("TieBa_AD_Tie2")) & "|@|"& Trim(Request.Form("TieBa_AD_Tie3"))
	TieBa_AD_A_modify =  Trim(Request.Form("TieBa_AD_A"))'贴吧广告A
	TieBa_AD_B_modify = Trim(Request.Form("TieBa_AD_B")) '贴吧广告B
	TieBa_AD_c_modify = Trim(Request.Form("TieBa_AD_c")) '贴吧广告c
	TieBa_AD_d_modify = Trim(Request.Form("TieBa_AD_d")) '贴吧广告d
	TieBa_AD_e_modify = Trim(Request.Form("TieBa_AD_e")) '贴吧广告e
	TieBa_AD_f_modify = Trim(Request.Form("TieBa_AD_f")) '贴吧广告f
	TieBa_AD_g_modify = Trim(Request.Form("TieBa_AD_g")) '贴吧广告g
	TieBa_AD_h_modify = Trim(Request.Form("TieBa_AD_h")) '贴吧广告h
	TieBa_AD_i_modify = Trim(Request.Form("TieBa_AD_i")) '贴吧广告i


Set rs98 = Server.CreateObject("ADODB.Recordset")
sql98 ="SELECT * From "&configtable&" where id=1"
	rs98.open sql98,Conn,3,3
	
	rs98("TieBa_AD_Top") =TieBa_AD_Top_modify
	rs98("TieBa_AD_Tie") =TieBa_AD_Tie_modify
	rs98("TieBa_AD_A") =TieBa_AD_A_modify
	rs98("TieBa_AD_B") =TieBa_AD_B_modify
	rs98("TieBa_AD_c") =TieBa_AD_c_modify
	rs98("TieBa_AD_d") =TieBa_AD_d_modify
	rs98("TieBa_AD_e") =TieBa_AD_e_modify
	rs98("TieBa_AD_f") =TieBa_AD_f_modify
	rs98("TieBa_AD_g") =TieBa_AD_g_modify
	rs98("TieBa_AD_h") =TieBa_AD_h_modify
	rs98("TieBa_AD_i") =TieBa_AD_i_modify
	
rs98.update
rs98.close
set rs98=Nothing
Application(webname&"CacheTime")="2010-3-1 12:12:12"
response.write backmsg("恭喜，站点参数成功！","AdminManage.asp?Action=sitemanage2")
End If 
%>
<div class="admintitleft">网站广告管理</div>
<form name="form13" method='post' action='AdminManage.asp?Action=sitemanage2&cls2=save'>
  <table class="cssraindemo1" id="table1">
     <thead><tr><th colspan="2">网站广告管理</th></tr></thead><body>
     <tr>
      <td width="217" align=right  class="font2">顶部广告</td>
      <td width="860" align=left ><textarea rows="5" name="TieBa_AD_Top" cols="45"><%=TieBa_AD_Top%></textarea>
        *支持Html</td>
    </tr>
    <tr height="24">
      <td width="217" align=right  class="font2">帖间广告</td>
      <td width="860" align=left ><%
		Dim TieBa_AD_Tie1,TieBa_AD_Tie2,TieBa_AD_Tie3,gap_len,gap_arr
		if instr(TieBa_AD_Tie,"|@|")>0 then
			'如果存在“|”，用|来区分是主题帖的广告还是奇数回复行的广告还是偶数回复行的广告
			gap_arr = Split(TieBa_AD_Tie,"|@|")
			gap_len = Ubound(gap_arr)
			if gap_len >=2 then
				TieBa_AD_Tie1 = gap_arr(0)
				TieBa_AD_Tie2 = gap_arr(1)
				TieBa_AD_Tie3 = gap_arr(2)
			elseif gap_len =1 then
				TieBa_AD_Tie1 = gap_arr(0)
				TieBa_AD_Tie2 = gap_arr(1)
				TieBa_AD_Tie3 = " "
			else 
				TieBa_AD_Tie1 = " "
				TieBa_AD_Tie2 = " "
				TieBa_AD_Tie3 = " "
			end if
		else
				TieBa_AD_Tie1 = TieBa_AD_Tie
				TieBa_AD_Tie2 = " "
				TieBa_AD_Tie3 = " "
		end if
	%>
        <textarea rows="2" name="TieBa_AD_Tie1" cols="45"><%=TieBa_AD_Tie1%></textarea>
        *主帖子广告,支持Html<br />
<textarea rows="2" name="TieBa_AD_Tie2" cols="45"><%=TieBa_AD_Tie2%></textarea>
        *奇数回帖行,支持Html<br />
<textarea rows="2" name="TieBa_AD_Tie3" cols="45"><%=TieBa_AD_Tie3%></textarea>
        *偶数回帖行,支持Html </td>
    </tr>
    <tr height="24">
      <td width="217" align=right class="font2">首页右侧宽248广告一<BR>
        <font color="#009900">调用参数TieBa_AD_A</font></td>
      <td width="860" align=left ><textarea rows="3" name="TieBa_AD_A" cols="65"><%=TieBa_AD_A%></textarea>
        *支持Html</td>
    </tr>
    <tr  height="24">
      <td width="217" align=right  class="font2">首页右侧宽248广告二<BR>
        <font color="#009900">调用参数TieBa_AD_</font>B</td>
      <td width="860" align=left ><textarea rows="3" name="TieBa_AD_B" cols="65"><%=TieBa_AD_B%></textarea>
        *支持Html</td>
    </tr>
        <tr height="24">
      <td width="217" align=right class="font2">首页宽698横幅广告一<BR>
        <font color="#009900">调用参数TieBa_AD_c</font></td>
      <td width="860" align=left ><textarea rows="3" name="TieBa_AD_c" cols="65"><%=TieBa_AD_c%></textarea>
        *支持Html</td>
    </tr>
    
            <tr height="24">
      <td width="217" align=right class="font2">首页宽698横幅广告二<BR>
        <font color="#009900">调用参数TieBa_AD_d</td>
      <td width="860" align=left><textarea rows="3" name="TieBa_AD_d" cols="65"><%=TieBa_AD_d%></textarea>
        *支持Html</td>
    </tr>
            <tr  height="24">
      <td width="217" align=right class="font2">首页宽698横幅广告三<BR>
        <font color="#009900">调用参数TieBa_AD_e</font></td>
      <td width="860" align=left><textarea rows="3" name="TieBa_AD_e" cols="65"><%=TieBa_AD_e%></textarea>
        *支持Html</td>
    </tr>
            <tr  height="24">
      <td width="217" align=right  class="font2">首页右侧宽248广告三<BR>
        <font color="#009900">调用参数TieBa_AD_f</font></td>
      <td width="860" align=left ><textarea rows="3" name="TieBa_AD_f" cols="65"><%=TieBa_AD_f%></textarea>
        *支持Html</td>
    </tr>
            <tr  height="24">
      <td width="217" align=right  class="font2">自由广告g<BR>
        需要在页面中调用参数TieBa_AD_g</td>
      <td width="860" align=left ><textarea rows="5" name="TieBa_AD_g" cols="45"><%=TieBa_AD_g%></textarea>
        *支持Html</td>
    </tr>        <tr  height="24">
      <td width="217" align=right  class="font2">自由广告h<BR>
        需要在页面中调用参数TieBa_AD_h</td>
      <td width="860" align=left ><textarea rows="5" name="TieBa_AD_h" cols="45"><%=TieBa_AD_h%></textarea>
        *支持Html</td>
    </tr>
            <tr  height="24">
      <td width="217" align=right  class="font2">自由广告i<BR>
        需要在页面中调用参数TieBa_AD_i</td>
      <td width="860" align=left ><textarea rows="5" name="TieBa_AD_i" cols="45"><%=TieBa_AD_i%></textarea>
        *支持Html</td>
    </tr>
 <tr class="zd_td" height="24">
      <td  align=center colspan=2><input type='button' name='Submit' onClick="form13.submit();" value='修改提交'>
        <input type="reset"  value="取消修改"></td>
    </tr></body>
  </table>
</form>

<%
End Sub 

'帖子回复等数据的修复。
Sub RepairBBS()
MyPageSize   = 40        '每页显示多少条

Server.Scripttimeout=999999
response.write "<font color=red>开始读取数据，请耐心等待...</font><br>" &vbcrlf
response.Flush

sql7 = "SELECT * FROM "&bbsTable&" where ischeck>0 ORDER BY [id] DESC"
Set rs7 = Server.CreateObject("ADODB.Recordset")
rs7.open sql7,conn,3,3
If rs7.eof and rs7.bof Then
	response.write "没有帖子可以修复"
Else
	rs7.PageSize     = MyPageSize
	MaxPages         = rs7.PageCount
	rs7.absolutepage = MyPage
	Totalcount            = rs7.RecordCount
	for i=1 to rs7.PageSize
		If not rs7.eof Then
			title=rs7("title")
			oldre=rs7("recount")
			oldlou=rs7("lou")
			replynum=0
					Set rs_re= Server.CreateObject("ADODB.Recordset")
					rs_re.Open "Select * From "&rebbstable&" where re="&rs7("id")&" and ischeck>0 order by addtime desc", conn,1,1  
					If rs_re.eof and rs_re.bof Then
						replynum=0
					Else
						replynum=rs_re.RecordCount
						rename=rs_re("username")
						addtime=rs_re("addtime")
						lou=rs_re("lou")
					End If 
					rs_re.close
			If replynum<>0 Then
				rs7("recount")=replynum
				rs7("rename")=rename
					If lou>=oldlou Then 
						rs7("lou")=replynum
					Else
						rs7("lou")=lou
					End If 
				rs7("retime")=addtime
			Else
				rs7("recount")=0
				rs7("rename")=rs7("username")
				rs7("lou")=0
				rs7("retime")=rs7("addtime")
			End If 
			rs7.update
			rs7.MoveNext
		end if
	Next
 		 if Totalcount/MyPageSize = int(Totalcount/MyPageSize) then 
		 infopage=int(Totalcount/MyPageSize)
		 else
		 infopage=int(Totalcount/MyPageSize)+1
		 end if
	If MyPage < infopage Then 
		response.write "修复完毕第 "&MyPage&" 页，共有 "&infopage&" 页&nbsp; <A HREF=""ShowList.asp"">返回首页</A>"
		response.write "<meta http-equiv=""refresh"" content=""2;url=AdminManage.asp?Action=RepairBBS&CurPage="&MyPage+1&""">"
		Else
		response.write "修复完毕!<A HREF=""ShowList.asp"">返回首页</A>"
	End If 
End if
rs7.close
set rs7=Nothing
End Sub 
'插件列表
Sub ddpPlus()
%>
<style>
.adminplug{CLEAR: both;FLOAT: left;DISPLAY: inline}
.adminplug li{FLOAT: left;margin-right:10px}

</style>
<div class="admintitleft">插件列表管理</div>
<table width="820" border="1" align="center" cellpadding="3" cellspacing="0" bordercolorlight="#cecece" bordercolordark="#FFFFFF" bgcolor="#C5D5E4"  style="font-size:12px; letter-spacing:1px;">
  <tr >
    <td  class="admintopbg" align="center"><B>插件列表</B></td>
  </tr>
  <tr class="zd_td">
    <td height="30" align="center" bgcolor="#F3F3F3"><B>
      <UL class="adminplug">
        <%=Plug_menu%>
    </UL></td>
  </tr>
</table>
<BR>
<table width="820" border="1" align="center" cellpadding="3" cellspacing="0" bordercolorlight="#cecece" bordercolordark="#FFFFFF" bgcolor="#C5D5E4"  style="font-size:12px; letter-spacing:1px;">
    <tr >
      <td  class="admintopbg">插件执行进度</td>
  </tr>
  <tr>
    <td height="45" bgcolor="#F3F3F3" class="zd_td" style="padding:10px;"><iframe frameborder="0" name="plugRun" id="plugRun" width="100%" height="380"></iframe></td>
  </tr>
</table>
<%
End Sub 
'--------------------------数据库操作，备份还原压缩功能
Sub dbak()
%>
<div class="admintitleft">数据库备份还原压缩管理</div>
<form action="?Action=dbak&cz=sqlquery" method="post">
 <table width="820" border="1" align="center" cellpadding="3" cellspacing="0" bordercolorlight="#cecece" bordercolordark="#FFFFFF" bgcolor="#C5D5E4"  style="font-size:12px; letter-spacing:1px;">
    <tr >
      <td  class="admintopbg" align="center" colspan=2><B>数据库操作修改</B></td>
    </tr>
    <tr class="zd_td">
      <td width="30%" height="30" align="right" bgcolor="#F3F3F3"><strong>SQL 查询执行：</strong></td>
      <td bgcolor="#F3F3F3">&nbsp;
        <input name="SQL_Query" value="" type="text" size="48">
        <input type="submit" value="执行"></td>
    </tr>
    <tr class="zd_td">
      <td width="30%" height="30" align="right" bgcolor="#F3F3F3"><strong>数据库操作：</strong></td>
      <td bgcolor="#F3F3F3">&nbsp;<b>&nbsp;<a href="?Action=dbak&cz=Compact">压缩</a></b>(压缩前最好备份一次)&nbsp;&nbsp;|&nbsp;&nbsp;<b><a href="?Action=dbak&cz=Backup">备份</a></b>(强烈推荐每日备份一次)</td>
    </tr>
  </table>
</form>
<table width="820" border="1" align="center" cellpadding="3" cellspacing="0" bordercolorlight="#cecece" bordercolordark="#FFFFFF" bgcolor="#C5D5E4"  style="font-size:12px; letter-spacing:1px;">
  <tr >
    <td  class="admintopbg" align="left" colspan=2><%
db=Dreamsundb
'获取数据库路径后，开始取出数据库的名字
AccessPath0 = split(db,"/")
AccessPath00 = AccessPath0(ubound(AccessPath0))
'总路径中替换掉名字，就是文件夹
AccessPath=Replace(db,"/"&AccessPath00,"")
cz=Checkstr(Request.QueryString("cz"))
IF cz="sqlquery" Then
	Dim SQL_Query,abc
	SQL_Query=Request.Form("SQL_Query")
	Conn.Execute SQL_Query,abc
	'SQLQueryNums=SQLQueryNums+1
	Response.Write("<a href=""?Action=dbak"">SQL语句执行成功，请点击返回</a>")
ElseIF cz="Compact" Then
	Dim FSO,Engine
	Set FSO=Server.CreateObject("Scripting.FileSystemObject")
	IF FSO.FileExists(Server.Mappath(db)) Then
		Response.Write "压缩数据库开始，网站暂停一切用户的前台操作......<br>"
		Conn.Close
		Set Conn=Nothing

		Set Engine = CreateObject("JRO.JetEngine")
		Engine.CompactDatabase "Provider=Microsoft.Jet.OLEDB.4.0;Data Source=" & Server.Mappath(db), "Provider=Microsoft.Jet.OLEDB.4.0;Data Source=" & Server.Mappath(db & ".temp")
		FSO.CopyFile Server.Mappath(db & ".temp"),Server.Mappath(db)
		FSO.DeleteFile(Server.Mappath(db & ".temp"))
		Set FSO = Nothing
		Set Engine = Nothing
		Response.write "压缩数据库完成..."
		Response.Write "<br>网站恢复正常访问..."
		Response.Write("<br><a href='?Action=dbak'>请点击返回</a>")
	End IF
ElseIF cz="Backup" Then
	Response.Write "备份数据库开始，网站暂停一切用户的前台操作......<br>"
	Conn.Close
	Set Conn=Nothing
	CopyFiles Server.Mappath(db),Server.Mappath(db & "_" & DateToStr(Now(),"YmdHIS") &".bak")
	Response.write "<br>备份完成..."
	Response.write "<br>网站恢复正常访问..."
	Response.Write("<br><a href='?Action=dbak'>请点击返回</a>")

ElseIF cz="Restore" Then
	Response.Write "还原数据库开始，网站暂停一切用户的前台操作......<br>"
	Conn.Close
	Set Conn=Nothing
	IF Request.QueryString("filename")=Empty Then
		Response.Write("<b>要还原的文件名不能为空</b>")
	Else
        Response.write "备份原数据库.<br>"
        CopyFiles Server.Mappath(db),Server.Mappath(db & ".TEMP")
        if DeleteFiles(Server.Mappath(db))=1 then response.write ("<br>原数据库删除成功")
        Response.write "<br>更新数据库."
        CopyFiles Server.Mappath(AccessPath)&"/"&checkStr(Request.QueryString("filename")),Server.Mappath(db)
        if DeleteFiles(Server.MapPath(AccessPath&"/"&checkStr(Request.QueryString("filename"))))=1 then response.write ("<br>Bak备份删除成功")
		if DeleteFiles(Server.Mappath(db & ".TEMP"))=1 then response.write ("<br>Temp备份删除成功")

		Response.write "<br>还原完成..."
	end if

	Response.write "<br>网站恢复正常访问..."
	Response.Write("<br><a href='?Action=dbak'>请点击返回</a>")   

ElseIF cz="DeleFile" Then
	IF Request.QueryString("filename")=Empty Then
		Response.Write("<a href='?Action=dbak'>要删除的文件名不能为空，请点击返回</a>")
	Else
		IF DeleteFiles(Server.MapPath(AccessPath&"/"&checkStr(Request.QueryString("filename"))))=1 Then
			response.write backmsg("文件删除成功，请点击返回","?Action=dbak")
		Else
			response.write backmsg("文件删除失败，请点击返回","?Action=dbak")
		End IF
	End IF
Else
	Response.Write("<div align='center'><b>备份文件列表</b></div>")
	Dim DataFolder,DataFileList,DataFile,DataFileName
	Set FSO=Server.CreateObject("Scripting.FileSystemObject")
	Set DataFolder=FSO.GetFolder(Server.MapPath(AccessPath))
	Set DataFileList=DataFolder.Files
	For Each DataFile IN DataFileList
		IF Ubound(Split(DataFile,"."))>=2 and (Right(DataFile,3)="bak") Then
			DataFileName=DataFile.Name
			Response.Write("&nbsp;&nbsp;<font color='#FF0000'>"&DataFileName&"</font>&nbsp;&nbsp;|&nbsp;&nbsp;<b><a href='"&AccessPath&"/"&DataFileName&"'>下载此文件</a></b>&nbsp;&nbsp;|&nbsp;&nbsp;<b><a href='?Action=dbak&cz=DeleFile&filename="&DataFileName&"'>删除</a></b>此文件&nbsp;&nbsp;|&nbsp;&nbsp;从此文件<b><a href='?Action=dbak&cz=Restore&filename="&DataFileName&"' >还原</a></b>数据<br>")
		End IF
	Next
End If
%></td>
  </tr>
</table>
<%
End Sub 
Sub attach()
UploadDir="upload/"
maxperpage=5

cls=CheckStr(trim(Request("cls")))

if cls="Del" then
		call DelFiles()
end if

If cls="1" Then 
	upfolder=Trim(Request.Form("upfolder"))
	If upfolder<>"" Then
		session("attach_folder_"&webname)=upfolder&"/"
		Else
		session("attach_folder_"&webname)=""
	End If 
End If 
UploadDir=UploadDir & session("attach_folder_"&webname)


TruePath=Server.MapPath(UploadDir)
If not IsObjInstalled("Scripting.FileSystemObject") Then
	Response.Write "<b><font color=red>你的服务器不支持 FSO(Scripting.FileSystemObject)! 不能使用本功能</font></b>"
Else
	set fso=CreateObject("Scripting.FileSystemObject")
	if request("Action")="Del" then
		call DelFiles()
	end if
	
  if fso.FolderExists(TruePath)then
	FileCount=0
	TotleSize=0
	Set theFolder=fso.GetFolder(TruePath)
	For Each theFile In theFolder.Files
		zongshu=zongshu+1
		zongsize=zongsize+theFile.Size
	next
    totalPut=zongshu
	if MyPage<1 then
   		MyPage=1
   	end if
   	if (MyPage-1)*MaxPerPage>totalput then
		if (totalPut mod MaxPerPage)=0 then
	  		MyPage= totalPut \ MaxPerPage
	  	else
	      	MyPage= totalPut \ MaxPerPage + 1
		end if

    end If
    
   	dim c
	FileCount=0
	TotleSize=0
%>
<table width="820" border="1" align="center" cellpadding="3" cellspacing="0" bordercolorlight="#cecece" bordercolordark="#FFFFFF" bgcolor="#C5D5E4"  style="font-size:12px; letter-spacing:1px;">
    <tr >
      <td  class="admintopbg"colspan="5" align="center" ><b>上 
      传 图 片 管 理</b> 当前目录<%=UploadDir%></td>
    <td align="right" colspan="5"  class="admintopbg"><form action="AdminManage.asp?Action=attach&cls=1" name="form2" method="post">
        <select name='upfolder'>
          <%
	Set FSO=Server.CreateObject("Scripting.FileSystemObject")
	set objFolder=FSO.GetFolder(server.Mappath("upload/"))
	set objSubFolders=objFolder.Subfolders
	response.write "<option value="""">主文件夹</option>"
	for each objSubFolder in objSubFolders
		response.write "<option value="""&objSubFolder.name&""""
		If Sys_skins=objSubFolder.name then Response.Write " selected"
		response.write">"&objSubFolder.name&"</option>"
	next 
	set objFolder=nothing
	set objSubFolders=nothing
	set fso=nothing
	%>
        </select>
        <input type="submit" value="执行">
    </form></td>
  </tr>
  <tr align="center" valign="middle" class="zd_td">
    <td height="25" bgcolor="#F3F3F3">选中 <br></td>
    <td bgcolor="#F3F3F3">文件名/复制地址</td>
    <td bgcolor="#F3F3F3">文件大小</td>
    <td bgcolor="#F3F3F3">预览</td>
    <td bgcolor="#F3F3F3">最后修改时间</td>
    <td bgcolor="#F3F3F3">归属</td>
    <td bgcolor="#F3F3F3">操作</td>
  </tr>
  <form action="" name="form1" method="post">
  
  <%

For Each theFile In theFolder.Files
	c=c+1
	if FileCount>=MaxPerPage then
		exit for
	elseif c>MaxPerPage*(MyPage-1) then
%>
  <tr height="25" align="center" valign="middle" class="zd_td">
    <td bgcolor="#F3F3F3"><input name="FileName" type="checkbox" id="FileName" value="<%=theFile.Name%>"></td>
    <td bgcolor="#F3F3F3"><a style="cursor:hand;background-color:#e5e5e5;" onclick=JM_cc('<%=theFile.Name%>') title="点击图片复制地址到剪贴板"><%=UploadDir%><%=theFile.Name%></a></td>
    <td bgcolor="#F3F3F3"><%=theFile.size%>字节</td>
    <td bgcolor="#F3F3F3"><%=theFile.type%><BR>
      <a href="<%=(UploadDir & theFile.Name)%>" target="_blank" ><img src="<%=(UploadDir & theFile.Name)%>" alt="点击地址在新窗口浏览" width="50" height="50" border="0"></a></td>
    <td bgcolor="#F3F3F3"><%=theFile.DateLastModified%></td>
    <td bgcolor="#F3F3F3"><div id="guishu<%=c%>"><A HREF="#" onClick="get_guishu('<%=theFile.Name%>','guishu<%=c%>')">归属</A></div></td>
    <td bgcolor="#F3F3F3"><a href="AdminManage.asp?Action=attach&cls=Del&FileName=<%=session("attach_folder_"&webname)%><%=theFile.Name%>" onClick="{if(confirm('你真的要删除此文件吗!')){this.document.form1.submit();return true;}return false;}">删除</a></td>
  </tr>
  <%
		FileCount=FileCount+1
		TotleSize=TotleSize+theFile.Size
	end if
Next
%>
</table>
<table width="820" border="1" align="center" cellpadding="3" cellspacing="0" bordercolorlight="#cecece" bordercolordark="#FFFFFF" bgcolor="#C5D5E4"  style="font-size:12px; letter-spacing:1px;">
  <tr >
    <td  class="admintopbg" height="30"><input name="chkall" type="checkbox" id="chkall" onClick="javascript:CheckAll(this.form)" value="checkbox">
      选中本页显示的所有文件</td>
    <td  class="admintopbg"> <input name="cls" type="hidden" id="cls" value="Del">
      <input type="submit" name="Submit" value="删除选中的文件"></td>
  </tr>
</table>
</form>
<%
response.write viewpage(totalput,maxperpage,5,MyPage,"Action=attach","当前总数:","AdminManage.asp")&"</td>"

response.write "<br><div align='center'>本页共显示 <b>" & FileCount & "</b> 个文件，占用 <b>" & TotleSize\1024 & "</b> K。共有 <b>" & totalPut & "</b> 个文件，占用 <b>" & zongSize\1024 & "</b> K</div>"
 else
	response.write "找不到文件夹！文件夹已经删除或未建立！"
	response.write "<a href='pic.asp'>返回</a>！"
  end if
end if
End Sub 

Public Function IsObjInstalled(strClassString)
	On Error Resume Next
	IsObjInstalled = False
	Err = 0
	Dim xTestObj
	Set xTestObj = Server.CreateObject(strClassString)
	If 0 = Err Then IsObjInstalled = True
	Set xTestObj = Nothing
	Err = 0
End Function

sub DelFiles()
	dim whichfile,arrFileName,i
	whichfile=trim(Request("FileName"))

	Set FSO=Server.CreateObject("Scripting.FileSystemObject")
	if whichfile="" then exit sub
	if instr(whichfile,",")>0 then
		arrFileName=split(whichfile,",")
		for i=0 to ubound(arrFileName)
			if left(trim(arrFileName(i)),3)<>"../" and left(trim(arrFileName(i)),1)<>"/" then
				If Left(trim(arrFileName(i)),1)="/" then trim(arrFileName(i))=Right(trim(arrFileName(i)),len(trim(arrFileName(i)))-1)
				whichfile=server.MapPath("upload/" & trim(arrFileName(i)))
				set thisfile=fso.GetFile(whichfile)
				thisfile.Delete True
			end if
		next
	else
		if left(whichfile,3)<>"../" and left(whichfile,1)<>"/" Then
			If Left(whichfile,1)="/" then whichfile=Right(whichfile,len(whichfile)-1)
			Set thisfile = fso.GetFile(server.MapPath("upload/" & whichfile))
			thisfile.Delete True
		end if
	end if
	Response.Write("<script>alert(""删除成功"");location.href="""&comurl&""";</script>")
end sub


%>
