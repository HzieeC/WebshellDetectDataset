<!--#include file="../inc/mdb.asp"-->
<%Admin="down"%>
<!--#include file="check.asp"-->
<!--#include file="../inc/config.asp"-->
<!--#include file="../inc/cmsfunction.asp"-->
<HTML><HEAD><title>07ing管理系统――下载管理</title>
<META http-equiv=Content-Type content="text/html; charset=gb2312">
<LINK href="../inc/admin.css" type=text/css rel=StyleSheet>
<META content="MSHTML 6.00.2800.1126" name=GENERATOR>
</HEAD>
<body onkeydown=return(!(event.keyCode==78&&event.ctrlKey)) >
<%
'****************************************************
' 07ing Ver8.0       Power by 07ing.net
' Web: http://www.07ing.net,http://www.07ing.com
' Copyright (C) 2006 07ing.net All Rights Reserved.
'****************************************************
if session("adminlogin")<>sessionvar then
  Response.Write("<script language=javascript>alert('你尚未登录，或者超时了！请重新登录');this.top.location.href='admin.asp';</script>")
  response.end
else
if request.form("MM_insert") then
if request.Form("action")="newcat" then
dim cat_name,sid
sid=clng(request.form("id"))
cat_name=trim(replace(request.form("cat_name"),"'",""))
if cat_name="" then
  Response.Write("<script language=javascript>alert('你必须填写分类名称');history.back(1);</script>")
  Response.End
else
  conn.Execute ("Insert Into d_cat(cat_name,sid) Values('"&cat_name&"',"&sid&")")
  response.redirect "admin_down.asp"
end if
'================07ing.com===============
elseif request.Form("action")="editcat" then
cat_name=trim(replace(request.form("cat_name"),"'",""))
if request.Form("id")="" then
  Response.Write("<script language=javascript>alert('你必须指定操作的对象！');history.back(1);</script>")
  Response.End
end if
if not isInteger(request.form("id")) then
  Response.Write("<script language=javascript>alert('非法的id参数');history.back(1);</script>")
  Response.End
end if
if cat_name="" then
  Response.Write("<script language=javascript>alert('你必须填写分类名称');history.back(1);</script>")
  Response.End
end if
  conn.Execute ("Update d_cat Set cat_name='"&cat_name&"',sid="&clng(request.form("lid"))&" where cat_id="&cint(request.form("id"))&"")
  response.redirect "admin_down.asp"
'================07ing.com===============
elseif request.Form("action")="delcat" then
if request.Form("id")="" then
  Response.Write("<script language=javascript>alert('你必须指定操作的对象！');history.back(1);</script>")
  Response.End
end if
if not isInteger(request.form("id")) then
  Response.Write("<script language=javascript>alert('非法的id参数');history.back(1);</script>")
  Response.End
end if
if request.Form("sid")="0" then
sql="select cat_id from d_cat where sid="&clng(request.form("id"))
set rsd=conn.execute(sql)
do while not rsd.eof
   Conn.Execute "DELETE * FROM [soft] WHERE soft_catid="&rsd("cat_id")
rsd.movenext
loop
rsd.close
set rsd=nothing
   Conn.Execute "DELETE * FROM d_cat WHERE sid="&clng(request.form("id"))
   Conn.Execute "DELETE * FROM d_cat WHERE cat_id="&clng(request.form("id"))
else
   Conn.Execute "DELETE * FROM d_cat WHERE cat_id="&clng(request.form("id"))
   Conn.Execute "DELETE * FROM [soft] WHERE soft_catid="&clng(request.form("id"))
end if
  response.redirect "admin_down.asp"
end if
end if
if request.QueryString("action")="" then
%>
<table align="center" width="98%" align="center" border="1" cellspacing="0" cellpadding="4" class=07ingbk style="border-collapse: collapse">
  <tr> 
   <td colspan="4" class=07ingss>软件移动、合并管理(请慎重操作，操作后不可还原!)</font></td>
  </tr>
  <form method="post" action="?action=moves">
  <tr align="center"> 
   <td height=22 align=center class=07ingqs>将：
   <select size="1" name="cat1">
<%
sql="select * from d_cat where sid=0"
set rs1=conn.execute(sql)
do while not rs1.eof
response.write "<optgroup label='"&rs1("cat_name")&"'>"
sql="select * from d_cat where sid="&rs1("cat_id") 
set rs2=server.createobject("adodb.recordset")
rs2.open sql,conn,1,1
do while not rs2.eof
%>
  <option value="<%=rs2("cat_id")%>">├ <%=rs2("cat_name")%></option>
<%
rs2.movenext
loop
rs1.movenext
loop
rs1.close
set rs1=nothing%>
</select> 分类软件，移动到： 
<select size="1" name="cat2">
<%
sql="select * from d_cat where sid=0"
set rs1=conn.execute(sql)
do while not rs1.eof
response.write "<optgroup label='"&rs1("cat_name")&"'>"
sql="select * from d_cat where sid="&rs1("cat_id") 
set rs2=server.createobject("adodb.recordset")
rs2.open sql,conn,1,1
do while not rs2.eof
%>
  <option value="<%=rs2("cat_id")%>">├ <%=rs2("cat_name")%></option>
<%
rs2.movenext
loop
rs1.movenext
loop
rs1.close
set rs1=nothing%>
</select>分类里。
<input type="submit" value="移动合并" name="B2">
</td></tr>
</form>
</table>
<table align="center" width="98%" align="center" border="1" cellspacing="0" cellpadding="4" class=07ingbk style="border-collapse: collapse">
        <tr> 
          <td colspan="5" class=07ingss>软件分类管理</font></td>
        </tr>
        <tr align="center"> 
          <td width="10%" class=07ingqs>ID编号</td>
          <td width="40%" class=07ingqs>分类名称</td>
          <td width="20%" class=07ingqs>子栏目</td>
          <td width="15%" class=07ingqs>排列次序</td>
          <td width="15%" class=07ingqs>相关操作</td>
        </tr>
<%
sql="select * from d_cat where sid=0 order by sorder"
set rs=server.createobject("adodb.recordset")
rs.open sql,conn,1,1
do while not rs.eof%>
        <tr class=07ingds><form name="modify" method="post" action="?action=Setting"> 
          <td align="center"><%=rs("cat_id")%></td>
          <td><font color=#008000><%=rs("cat_name")%></font>  [<a href="admin_down.asp?id=<%=rs("cat_id")%>&action=newcat">添加子分类</a>]</td>
          <td align="center"><%=conn.execute("select count(*) from d_cat where sid="&rs("cat_id")&"")(0)%> 个</td>
          <td align="center"><input name="Order" type="text" id="Order" value="<%=rs("sorder")%>" size="4" maxlength="5" style="COLOR: rgb(255,0,0);" class="button"> <input name="Submit2" type="submit" id="Submit2" value="设定" class="button"></td><input type="hidden" name="id" value="<%=rs("cat_id")%>"></form>
          <td align="center"><a href="admin_down.asp?id=<%=rs("cat_id")%>&action=editcat">编辑</a> 
                             <a href="admin_down.asp?id=<%=rs("cat_id")%>&sid=<%=rs("sid")%>&action=delcat">删除</a></td>
        </tr>
<%sql="select * from d_cat where sid="&rs("cat_id")&" order by sorder" 
set rs2=server.createobject("adodb.recordset")
rs2.open sql,conn,1,1
do while not rs2.eof%>
<form name="S_modify" method="post" action="?action=Setting">
<tr class=07ingds><td align="right"><%=rs2("cat_id")%></td><td>├ <%=rs2("cat_name")%></td>
<td align="left">软件：<%=conn.execute("select count(*) from [soft] where soft_catid="&rs2("cat_id")&"")(0)%> 个</td>
<td align="center"><input type="text" name="order" size="4" value="<%=rs2("sorder")%>" class="button"> <input name="Submit3" type="submit" id="Submit32" value="设定" class="button"></td><input type="hidden" name="id" value="<%=rs2("cat_id")%>"></form>
<td align="center"><a href="admin_down.asp?id=<%=rs2("cat_id")%>&action=editcat">编辑</a> 
            <a href="admin_down.asp?id=<%=rs2("cat_id")%>&sid=<%=rs2("sid")%>&action=delcat">删除</a></td></tr>
<%
rs2.movenext
loop
response.write "<tr class=07ingqs><td colspan=5 align=center>"
if rs2.bof and rs2.eof then
response.write "此大类没有子分类！"
end if
rs2.close
set rs2=nothing
rs.movenext
loop
if rs.bof and rs.eof then
response.write "<tr align=""center"">" 
response.write "<td colspan=5 class=07ingds>当前没有软件分类！</td>"
response.write "</tr>"
end if
rs.close
set rs=nothing
response.write("</table>")
end if
'================07ing.com===============
if request.QueryString("action")="Setting" then
  Response.Write("<script language=javascript>alert('免费版无此功能');history.back(1);</script>")
  Response.End
end if
'================07ing.com===============
if request.QueryString("action")="newcat" then
%>
  <table align="center" width="98%" align="center" border="1" cellspacing="0" cellpadding="4" class=07ingbk style="border-collapse: collapse">
   <form name="form1" method="post" action="admin_down.asp">
   <tr> 
     <td class=07ingss>新的软件分类</td>
   </tr>
   <tr> 
     <td class=07ingds>分类名称：<input type="text" name="cat_name" size="40"></td>
   </tr>
   <tr> 
     <td class=07ingqs align="center" height="30">
     <input type="submit" name="Submit" value="确定新增" class="button">
     <input type="reset" name="reset" value="清空重写" class="button">
     [<a href="admin_down.asp">返回</a>] </td>
   </tr><input type="hidden" name="id" value="<%=clng(request.querystring("id"))%>">
	<input type="hidden" name="action" value="newcat">
	<input type="hidden" name="MM_insert" value="true">
	</form>
  </table>
<%
end if
'================07ing.com===============
if request.QueryString("action")="editcat" then
if request.querystring("id")="" then
  Response.Write("<script language=javascript>alert('请指定操作的对象！');history.back(1);</script>")
  response.end
else
  if not isinteger(request.querystring("id")) then
  Response.Write("<script language=javascript>alert('非法的id参数');history.back(1);</script>")
  response.end
  end if
end if
sql="select * from d_cat where cat_id="&clng(request.querystring("id"))
set rs=server.createobject("adodb.recordset")
rs.open sql,conn,1,1%>
      <table align="center" width="98%" align="center" border="1" cellspacing="0" cellpadding="4" class=07ingbk style="border-collapse: collapse">
        <form name="form1" method="post" action="admin_down.asp">
          <tr> 
            <td class=07ingss>修改软件分类</font></td>
          </tr>
          <tr> 
            <td class=07ingds>分类名称- 
              <input name="cat_name" type="text" class="textarea" id="cat_name" size="40" value="<%=rs("cat_name")%>"> 
            </td>
          </tr>
          <tr> 
            <td class=07ingds>所属分类- 
            <select size="1" name="lid">
            <option value="<%=rs("sid")%>">默认分类</option><br>
            <option value="0">设为大类</option><br>
<%
sql="select * from d_cat where sid=0"
set rs1=conn.execute(sql)
do while not rs1.eof
'response.write "<optgroup label='"&rs1("cat_name")&"'>"
%>
              <option value="<%=rs1("cat_id")%>">├ <%=rs1("cat_name")%></option>
<%
rs1.movenext
loop
rs1.close
set rs1=nothing%>
</select> 特别提示：当你要改变分类属性操作时，请确保类下无软件！是大类时，请确保其下无小类！
            </td>
          </tr>
          <tr> 
            <td class=07ingqs align="center" height="30"> <input name="Submit" type="submit" class="button" id="Submit" value="确定修改"> 
              <input name="reset" type="reset" class="button" id="reset" value="清空重写">
              [<a href="admin_down.asp">返回</a>] </td>
          </tr>
		  <input type="hidden" name="id" value="<%=rs("cat_id")%>">
		  <input type="hidden" name="action" value="editcat">
                  <input type="hidden" name="MM_insert" value="true">
        </form>
      </table>
<%
rs.close
set rs=nothing
end if

'================07ing.com===============
if request.QueryString("action")="delcat" then
if request.querystring("id")="" then
  Response.Write("<script language=javascript>alert('请指定操作的对象！');history.back(1);</script>")
  response.end
else
  if not isinteger(request.querystring("id")) then
  Response.Write("<script language=javascript>alert('非法的id参数');history.back(1);</script>")
  response.end
  end if
end if
sql="select * from d_cat where cat_id="&clng(request.querystring("id"))
set rs=server.createobject("adodb.recordset")
rs.open sql,conn,1,1
%>
      <table align="center" width="98%" align="center" border="1" cellspacing="0" cellpadding="4" class=07ingbk style="border-collapse: collapse">
        <form name="form1" method="post" action="admin_down.asp">
          <tr> 
            <td class=07ingss>删除软件分类</font></td>
          </tr>
          <tr> 
            <td class=07ingds>分类名称- <%=rs("cat_name")%></td>
          </tr>
          <tr> 
            <td class=07ingds><%if request.querystring("sid")="0" then%>友情提示：你要删除的是软件的大分类，此操作将同时删除其下的小类和所有的类下软件，请慎重！<%else%>友情提示：删除分类，将删除此分类下的所有软件，请慎重！<%end if%></td>
          </tr>
          <tr> 
            <td class=07ingqs align="center" height="30"> <input name="Submit" type="submit" class="button" id="Submit" value="确定删除">
              [<a href="admin_down.asp">返回</a>] </td>
          </tr>
          <input type="hidden" name="id" value="<%=rs("cat_id")%>">
          <input type="hidden" name="sid" value="<%=clng(request.querystring("sid"))%>">
          <input type="hidden" name="action" value="delcat">
          <input type="hidden" name="MM_insert" value="true">
        </form>
      </table>
<%
rs.close
set rs=nothing
end if
'================07ing.com===============
if request.querystring("action")="moves" then
cat1=clng(trim(request("cat1")))
cat2=clng(trim(request("cat2")))
conn.Execute = "update [soft] set soft_catid="&cat2&" where soft_catid="&cat1&""
set conn=nothing
Response.Redirect "admin_down.asp"
end if
'================07ing.com===============
if request.QueryString("action")="checkpass" then
sql="select * from soft where soft_id="&clng(request.querystring("id"))
set rs=server.createobject("adodb.recordset")
rs.open sql,conn,1,3
rs("passed")=0
rs.update
tjuser=rs("tjuser")
rs.close
set rs=nothing
conn.execute ("UPDATE [user] SET points = points + "&fbpoints&" where username='"&tjuser&"'")
response.redirect Request.ServerVariables("http_referer")
end if
if request.form("operation")="DEL" then
    num=request.form("soft_id").Count
    for i=1 to num
      conn.execute("delete from soft where soft_id="&request.form("soft_id")(i))
    next
end if
'================07ing.com===============
'================07ing.com===============
if request.querystring("action")="list" then
Response.Write("<table align=""center"" width=""98%"" border=""1"" cellspacing=""0"" cellpadding=""4"" class=07ingbk style=""border-collapse: collapse"">")
dim keyword,cat_id,colname,i
keyword=trim(replace(request("keyword"),"'",""))
cat_id=request("cat_id")
colname=request("colname")
Dim CurPage,Url_Add
Url_Add="?action=list&"
If Request.QueryString("Page")<>"" Then
   Curpage=Request.QueryString("Page")
   If IsInteger(Curpage)=False OR Curpage<0 Then Curpage=1
Else
   Curpage=1
End If
if cat_id<>"" then
   sql="SELECT * FROM soft where soft_catid="&clng(cat_id)&" order by soft_id desc"
   Url_Add=Url_Add&"cat_id="&cat_id&"&"
elseif keyword<>"" and colname<>"0" then
   sql="select * from soft where "&colname&" like '%"&keyword&"%' order by soft_id desc"
   Url_Add=Url_Add&"colname="&colname&"&keyword="&keyword&"&"
elseif request.querystring("t")="pass" then
   sql="select * from soft where passed=1 order by soft_joindate desc"
   Url_Add=Url_Add&"t=pass&"
else
   sql="SELECT * FROM soft where passed=0 order by istop desc,soft_id desc"
end if
set rs=server.createobject("adodb.recordset")
rs.open sql,conn,1,1
if rs.eof and rs.bof then
  Response.Write("<tr align=""center""><td class=07ingds colspan=9>当前没有软件！</td></tr>")
Else
   Dim down_Nums,MultiPages,j
   rs.PageSize=adflperpage
   rs.AbsolutePage=CurPage
   down_Nums=rs.RecordCount
   MultiPages="<tr><td class=07ingqs colspan=""9"" align=""center"">共有软件："&down_Nums&"个。&nbsp;&nbsp;"&MultiPage(down_Nums,adflperpage,CurPage,Url_Add)&"</td></tr>"
%>
<tr class=07ingqs><form name="form1" method="post" action="admin_down.asp?action=list"><td> 
<select name="colname"><option value=0 selected>--==搜索范围==--</option><option value="soft_name">软件名称</option><option value="soft_desc">软件描述</option></select>&nbsp; <input type="text" name="keyword" class="textarea" size="20">&nbsp;&nbsp; <input type="submit" name="Submit" value="搜索" class="button"></td></form>
<form><td >跳转到<select name="go" onChange='window.location=form.go.options[form.go.selectedIndex].value'>
<option value="">====选择分类====</option>
<%sql="select * from d_cat where sid=0 order by sorder"
set rs1=conn.execute(sql)
do while not rs1.eof
response.write "<optgroup label='"&rs1("cat_name")&"'>"
sql="select * from d_cat where sid="&rs1("cat_id")&" order by sorder" 
set rs2=server.createobject("adodb.recordset")
rs2.open sql,conn,1,1
do while not rs2.eof
%>
<option value="admin_down.asp?action=list&cat_id=<%=rs2("cat_id")%>">├ <%=rs2("cat_name")%></option>
<%
rs2.movenext
loop
rs1.movenext
loop
rs2.close
set rs2=nothing
rs1.close
set rs1=nothing%>
</select></td></form>
<form name=form method=post action="admin_down.asp?action=list">
<script language="javascript">
function CheckAll(form)
{
for (var i=0;i<form.elements.length;i++)
{
var e = form.elements[i];
if (e.name != 'chkall')
e.checked = form.chkall.checked;
}
}
</script>
<td align="right"></td>
              </tr>
            </table>
<%
Do Until Rs.EOF OR j=adflperpage
sql="select cat_id,cat_name from d_cat where cat_id="&rs("soft_catid")
set rscat=server.createobject("adodb.recordset")
rscat.open sql,conn,1,1  
if rs("istop")="1" then      
folder="「置顶」"       
else
folder=""       
end if      
if rs("istop")="0" then      
if rs("isbest")=1 then
folder="「推荐」"      
else
folder=""       
end if      
end if      
%> 
 <table align="center" width="98%" align="center" border="1" cellspacing="0" cellpadding="4" class=07ingbk style="border-collapse: collapse">
              <tr class="07ingqs" align="center">
                <td width="5%"><input type=checkbox Name=soft_id Value=<%=rs("soft_id")%>></td> 
                <td width="5%"><%If Rs("passed")=1 Then%><a href="?id=<%=rs("soft_id")%>&action=checkpass"><font color=red>pass</font></a><%else%>√<%End If%></td>
                <td width="*" align="left"><%=rs("soft_name")%></td> 
                <td width="8%"><font color="red"><%=folder%></font></td>
                <td width="12%"><%=formatdatetime(rs("soft_joindate"),2)%></td>
                <td width="8%"><%=rs("soft_dcount")%>/<%=rs("soft_rcount")%></td>
                <td width="8%"><%=rscat("cat_name")%></td><td width="10%"><%=rs("tjuser")%></td>
                <td width="5%"><a href="admin_down.asp?id=<%=rs("soft_id")%>&action=editsoft">编辑</a></td>
              </tr>
<%
rscat.close
set rscat=nothing
%>
              <tr class="07ingds"> 
                <td colspan="9">简介：<%=cutstr(rs("soft_desc"),60,false,none)%></td>
              </tr>
            </table>
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td height="9"></td>
              </tr>
            </table>
<%
j=j+1
rs.movenext
loop
end if
rs.close
set rs=nothing
%>
 <table align="center" width="98%" align="center" border="1" cellspacing="0" cellpadding="4" class=07ingbk style="border-collapse: collapse">
        <form name="form3" method="post" action="admin_down.asp?action=list&cat_id=<%=request("cat_id")%>&keyword=<%=request("keyword")%>&colname=<%=request("colname")%>">
          <tr class="07ingds"> <td class=07ingqs colspan="9">
            <input type=hidden value=DEL name=operation>
	 <input type="checkbox" name="chkall" onclick="CheckAll(this.form)" value="ON">选中本页所有 <input type=submit value=批量删除 onClick="return confirm('确定删除选中的资源吗?');" class="button"></td>
          </tr>
        </form>
<%
Response.Write(MultiPages)
Response.Write("</table>")
end if


if request.form("MM_insert") then
if request.Form("action")="newsoft" then
dim soft_name,soft_size,soft_mode,roof,commend,demo,home,showpic,desc,downisbest,downistop,url1,url2,url3,url4,uGrade,points,tjuser
soft_name=trim(replace(request.form("name"),"'",""))
soft_size=trim(replace(request.form("size"),"'",""))
soft_mode=trim(replace(request.form("mode"),"'",""))
roof=trim(replace(request.form("roof"),"'",""))
commend=cint(request.form("commend"))
demo=trim(replace(request.form("demo"),"'",""))
home=trim(replace(request.form("home"),"'",""))
showpic=trim(replace(request.form("showpic"),"'",""))
desc=trim(replace(request.form("desc"),"'",""))
downisbest=request.form("isbest")
downistop=request.form("istop")
url1=trim(replace(request.form("url1"),"'",""))
url2=trim(replace(request.form("url2"),"'",""))
url3=trim(replace(request.form("url3"),"'",""))
url4=trim(replace(request.form("url4"),"'",""))
uGrade=request.form("Grade")
points=request.form("points")
tjuser=request.form("tjuser")
if soft_name="" then
  Response.Write("<script language=javascript>alert('你必须填写文件名称！');history.back(1);</script>")
  response.end
end if
if commend<1 then
  Response.Write("<script language=javascript>alert('你必须选择文件推荐程度！');history.back(1);</script>")
  response.end
end if
if request("of")="" then
   Response.Write("<script language=javascript>alert('你必须选择所属分类！');history.back(1);</script>")
   response.end
end if
if desc="" then
  Response.Write("<script language=javascript>alert('你必须填写文件简介！');history.back(1);</script>")
  response.end
end if
if url1="" and url2="" and url3="" and url4="" then
  Response.Write("<script language=javascript>alert('你必须填写下载地址！');history.back(1);</script>")
  response.end
end if
sql="select * from soft"
set rs=server.createobject("adodb.recordset")
rs.open sql,conn,1,3
rs.addnew
  rs("soft_name")=soft_name
  rs("soft_commend")=commend
  rs("soft_desc")=desc
if soft_size="" then
  rs("soft_size")="未知"
else
  rs("soft_size")=soft_size
end if
if soft_mode="" then
  rs("soft_mode")=""
else
  rs("soft_mode")=soft_mode
end if
if roof="" then
  rs("soft_roof")=""
else
  rs("soft_roof")=roof
end if
if cint(downisbest)=1 then
  rs("isbest")=cint(downisbest)
end if
if cint(downistop)=1 then
  rs("istop")=cint(downistop)
end if
if request("of")<>"" then
        Set rsclass = Server.CreateObject("ADODB.Recordset")
        sqlclass="SELECT * FROM d_cat where cat_id="&clng(request("of"))
        rsclass.OPEN sqlclass,Conn,1,1
	rs("soft_classname")=rsclass("cat_name")
        rs("soft_catid")=rsclass("cat_id")
	set rscat = Server.CreateObject("ADODB.Recordset")
	sqlcat="select cat_name from d_cat where cat_id="&rsclass("sid")
	rscat.open sqlcat,conn,1,1
	rs("soft_catname")=rscat("cat_name")
	rscat.close
	rsclass.close
	set rscat=nothing
	set rsclass=nothing
end if
if demo="" then
  rs("soft_demo")=""
else
  rs("soft_demo")=demo
end if
if home="" then
  rs("soft_home")=""
else
  rs("soft_home")=home
end if
if showpic="" then
  rs("soft_showpic")=""
else
  rs("soft_showpic")=showpic
end if
if url1="" then
  rs("soft_url1")=""
else
  rs("soft_url1")=url1
end if
if url2="" then
  rs("soft_url2")=""
else
  rs("soft_url2")=url2
end if
if url3="" then
  rs("soft_url3")=""
else
  rs("soft_url3")=url3
end if
if url4="" then
  rs("soft_url4")=""
else
  rs("soft_url4")=url4
end if
  rs("Grade")=cint(uGrade)
  if cint(uGrade)=0 then
  rs("points")=0
  else
  rs("points")=cint(points)
  end if
  rs("tjuser")=tjuser
  rs.update
  rs.close
  set rs=nothing
  sql="update allcount set softcount = softcount + 1"
  conn.execute(sql)
  response.redirect "admin_down.asp?action=list"
end if

if request.Form("action")="editsoft" then
if request.Form("id")="" then
  Response.Write("<script language=javascript>alert('你必须指定操作的对象！');history.back(1);</script>")
  response.End
else
  if not isInteger(request.form("id")) then
   Response.Write("<script language=javascript>alert('非法的软件id参数。');history.back(1);</script>")
   response.End
  end if
end if
soft_name=trim(replace(request.form("name"),"'",""))
soft_size=trim(replace(request.form("size"),"'",""))
soft_mode=trim(replace(request.form("mode"),"'",""))
roof=trim(replace(request.form("roof"),"'",""))
commend=cint(request.form("commend"))
demo=trim(replace(request.form("demo"),"'",""))
home=trim(replace(request.form("home"),"'",""))
showpic=trim(replace(request.form("showpic"),"'",""))
desc=trim(replace(request.form("desc"),"'",""))
downisbest=request.form("isbest")
downistop=request.form("istop")
url1=trim(replace(request.form("url1"),"'",""))
url2=trim(replace(request.form("url2"),"'",""))
url3=trim(replace(request.form("url3"),"'",""))
url4=trim(replace(request.form("url4"),"'",""))
uGrade=request.form("Grade")
points=request.form("points")
tjuser=request.form("tjuser")
if soft_name="" then
  Response.Write("<script language=javascript>alert('你必须填写文件名称！');history.back(1);</script>")
  response.End
end if
if commend<1 then
  Response.Write("<script language=javascript>alert('你必须选择文件推荐程度！');history.back(1);</script>")
  response.End
end if
if request("of")="" then
  Response.Write("<script language=javascript>alert('你必须选择所属分类，或者非法操作！');history.back(1);</script>")
  response.End
end if
if desc="" then
  Response.Write("<script language=javascript>alert('你必须填写文件简介！');history.back(1);</script>")
  response.end
end if
if url1="" and url2="" and url3="" and url4="" then
  Response.Write("<script language=javascript>alert('你必须填写下载地址！');history.back(1);</script>")
  response.end
end if
sql="select * from soft where soft_id="&clng(request.form("id"))
set rs=server.createobject("adodb.recordset")
rs.open sql,conn,1,3
  rs("soft_name")=soft_name
  rs("soft_commend")=commend
  rs("soft_desc")=desc
if soft_size="" then
  rs("soft_size")="未知"
else
  rs("soft_size")=soft_size
end if
if soft_mode="" then
  rs("soft_mode")=""
else
  rs("soft_mode")=soft_mode
end if
if roof="" then
  rs("soft_roof")=""
else
  rs("soft_roof")=roof
end if
rs("isbest")=cint(downisbest)
rs("istop")=cint(downistop)
if request("of")<>"" then
        Set rsclass = Server.CreateObject("ADODB.Recordset")
        sqlclass="SELECT * FROM d_cat where cat_id="&clng(request("of"))
        rsclass.OPEN sqlclass,Conn,1,1
	rs("soft_classname")=rsclass("cat_name")
        rs("soft_catid")=rsclass("cat_id")
	set rscat = Server.CreateObject("ADODB.Recordset")
	sqlcat="select cat_name from d_cat where cat_id="&rsclass("sid")
	rscat.open sqlcat,conn,1,1
	rs("soft_catname")=rscat("cat_name")
	rscat.close
	rsclass.close
	set rscat=nothing
	set rsclass=nothing
end if
if demo="" then
  rs("soft_demo")=""
else
  rs("soft_demo")=demo
end if
if home="" then
  rs("soft_home")=""
else
  rs("soft_home")=home
end if
if showpic="" then
  rs("soft_showpic")=""
else
  rs("soft_showpic")=showpic
end if
if url1="" then
   rs("soft_url1")=""
else
  rs("soft_url1")=url1
end if
if url2="" then
  rs("soft_url2")=""
else
  rs("soft_url2")=url2
end if
if url3="" then
  rs("soft_url3")=""
else
  rs("soft_url3")=url3
end if
if url4="" then
  rs("soft_url4")=""
else
  rs("soft_url4")=url4
end if
  rs("Grade")=cint(uGrade)
  if cint(uGrade)=0 then
  rs("points")=0
  else
  rs("points")=cint(points)
  end if
  rs("tjuser")=tjuser
  if cint(downisbest)=1 then
     sql="UPDATE [user] SET points = points + "&bestpoints&" where username='"&tjuser&"'"
     conn.execute (sql)
  end if
  if cint(downistop)=1 then
     sql="UPDATE [user] SET points = points + "&toppoints&" where username='"&tjuser&"'"
     conn.execute (sql)
  end if
  rs.update
  rs.close
  set rs=nothing
  response.redirect "admin_down.asp?action=list"
end if
end if

if request.QueryString("action")="newsoft" then
%>
<table align="center" width="98%" align="center" border="1" cellspacing="0" cellpadding="4" class=07ingbk style="border-collapse: collapse">
              <form name="form1" method="post" action="admin_down.asp?action=list">
	      <tr class=07ingss> 
                <td colspan="2">新增软件</td>
              </tr>
              <tr  class=07ingds> 
                <td width="16%">软件名称：</td>
                <td width="84%"><input type="text" name="name" size="40" class="textarea"></td>
              </tr>
              <tr class=07ingds> 
                <td>软件大小：</td>
                <td><input type="text" name="size" size="20" class="textarea"></td>
              </tr>
              <tr class=07ingds> 
                <td>授权方式：</td>
                <td>
                    <select name="mode">
		     <option value="免费软件" selected>免费软件</option>
                      <option value="共享软件">共享软件</option>
                      <option value="汉化软件">汉化软件</option>
                      <option value="破解软件">破解软件</option>
                    </select>
                  </td>
              </tr>
              <tr class=07ingds> 
                <td>应用平台：</td>
                <td>
                    <select name="roof">
		     <option value="Win9x/Me">Win9x/Me</option>
		     <option value="IIS环境" selected>IIS环境</option>
                      <option value="WinNT/2000/XP">WinNT/2000/XP</option>
                      <option value="Win9x/Me/NT/2000/XP">Win9x/Me/NT/2000/XP</option>
                    </select>
                  </td>
              </tr>
              <tr class=07ingds> 
                <td>推荐程度：</td>
                <td>
                    <select name="commend">
		     <option value="5">5stars</option>
                      <option value="4">4stars</option>
                      <option value="3" selected>3stars</option>
                      <option value="2">2stars</option>
                      <option value="1">1stars</option>
                      <option value="0">0stars</option>
                    </select>
                  </td>
              </tr>
              <tr class=07ingds> 
                <td>所属分类：</td>
                <td>
                    <select name="of">
                      <%
sql="select * from d_cat where sid=0 order by sorder"
set rs1=conn.execute(sql)
do while not rs1.eof
response.write "<optgroup label='"&rs1("cat_name")&"'>"
sql="select * from d_cat where sid="&rs1("cat_id")&" order by sorder" 
set rs2=server.createobject("adodb.recordset")
rs2.open sql,conn,1,1
do while not rs2.eof
%>
              <option value="<%=rs2("cat_id")%>">├ <%=rs2("cat_name")%></option>
<%
rs2.movenext
loop
rs2.close
set rs2=nothing
rs1.movenext
loop
rs1.close
set rs1=nothing%></select>
                  </td>
              </tr>
              <tr class=07ingds> 
                <td>演示地址：</td>
                <td>
                    <input type="text" name="demo" size="60" class="textarea">
                  </td>
              </tr>
              <tr class=07ingds> 
                <td>主页地址：</td>
                <td>
                    <input type="text" name="home" size="60" class="textarea" value="http://07ing.com">
                  </td>
              </tr>
              <tr class=07ingds> 
                <td>图片地址：</td>
                <td>
                    <input type="text" name="showpic" size="60" class="textarea" value="http://07ing.com">
                  </td>
              </tr>
             <tr class=07ingds> 
              <td> 上传图片： </td>
              <td align="left" height="25"><iframe frameborder=0 width=290 height=25 scrolling=no src="upload.asp?action=downpic"></iframe></td>
            </tr>
              <tr class=07ingds> 
                <td>程序简介：</td>
                <td>
                    <textarea name="desc" cols="65" rows="10" class="textarea">没有</textarea>
                  </td>
              </tr>
              <tr class=07ingds> 
                <td>本地下载：</td>
                <td>
                    <input type="text" name="url1" size="60" class="textarea">
                  </td>
              </tr>
             <tr class=07ingds> 
              <td> 上传软件： </td>
              <td align="left" height="25"><iframe frameborder=0 width=290 height=25 scrolling=no src="upload.asp?action=down"></iframe></td>
            </tr>
              <tr class=07ingds> 
                <td>镜像下载：</td>
                <td>
                    <input type="text" name="url2" size="60" class="textarea">
                  </td>
              </tr>
              <tr class=07ingds> 
                <td>远程下载1：</td>
                <td>
                    <input type="text" name="url3" size="60" class="textarea">
                  </td>
              </tr>
              <tr class=07ingds> 
                <td>远程下载2：</td>
                <td>
                    <input type="text" name="url4" size="60" class="textarea">
                  </td>
              </tr>
              <tr> 
               <td class=07ingds>下载等级：：</td>
                  <td><select name="Grade" id="Grade">
          <option value="0" selected>游客下载</option>
          <option value="1">普通用户</option>
          <option value="2">VIP 用户</option>
        </select>&nbsp;&nbsp;  扣除会员积分数：<input type="text" name="points" size="4" value=""> (应添数字) *游客下载请留空
            </td>
          </tr>
          <tr class=07ingds> 
             <td>软件添加：</td>
             <td><input type="text" name="tjuser" size="10" value="<%=Session("hxStudioAdminName")%>"></td>
          </tr>
              <tr class=07ingqs> 
                <td colspan="2" align="center" height="30">
<input type="checkbox" name="istop" value="1">置顶&nbsp;&nbsp;&nbsp; <input type="checkbox" name="isbest" value="1">推荐&nbsp;&nbsp;&nbsp; <input type="submit" name="Submit" value="确定新增" class="button">
                    <input type="reset" name="Reset" value="清空重填" class="button">
<input type="button" value="返回"  onClick="location.href='admin_down.asp?action=list'" class="button"></td>
              </tr>
			  <input type="hidden" name="action" value="newsoft">
			  <input type="hidden" name="MM_insert" value="true">
			  </form>
            </table>
<%end if
if request.QueryString("action")="editsoft" then
if request.querystring("id")="" then
  Response.Write("<script language=javascript>alert('请指定操作的对象！');history.back(1);</script>")
  response.end
else
  if not isinteger(request.querystring("id")) then
     Response.Write("<script language=javascript>alert('非法的软件ID参数！');history.back(1);</script>")
     response.end
  end if
end if
sql="select * from soft where soft_id="&clng(request.querystring("id"))
set rs2=server.createobject("adodb.recordset")
rs2.open sql,conn,1,1%>
<table align="center" width="98%" align="center" border="1" cellspacing="0" cellpadding="4" class=07ingbk style="border-collapse: collapse">
              <form name="form1" method="post" action="admin_down.asp?action=list">
                <tr class=07ingss> 
                  <td colspan="2">编辑软件</td>
                </tr>
                <tr class=07ingds> 
                  <td width="16%">软件名称：</td>
                  <td width="84%"> <input type="text" name="name" size="40" class="textarea" value="<%=rs2("soft_name")%>"></td>
                </tr>
                <tr class=07ingds> 
                  <td>软件大小：</td>
                  <td> <input type="text" name="size" size="20" class="textarea" value="<%=rs2("soft_size")%>"> 
                  </td>
                </tr>
              <tr class=07ingds> 
                <td>授权方式：</td>
                <td>
                    <select name="mode">
		     <option value="免费软件" <%if rs2("soft_mode")="免费软件" then response.write "selected" end if%>>免费软件</option>
                      <option value="共享软件" <%if rs2("soft_mode")="共享软件" then response.write "selected" end if%>>共享软件</option>
                      <option value="汉化软件" <%if rs2("soft_mode")="汉化软件" then response.write "selected" end if%>>汉化软件</option>
                      <option value="破解软件" <%if rs2("soft_mode")="破解软件" then response.write "selected" end if%>>破解软件</option>
                    </select>
                  </td>
              </tr>
              <tr class=07ingds> 
                <td>应用平台：</td>
                <td>
                    <select name="roof">
		     <option value="IIS环境" <%if rs2("soft_roof")="IIS环境" then response.write "selected" end if%>>IIS环境</option>
		     <option value="Win9x/Me" <%if rs2("soft_roof")="Win9x/Me" then response.write "selected" end if%>>Win9x/Me</option>
                      <option value="WinNT/2000/XP" <%if rs2("soft_roof")="WinNT/2000/XP" then response.write "selected" end if%>>WinNT/2000/XP</option>
                      <option value="Win9x/Me/NT/2000/XP" <%if rs2("soft_roof")="Win9x/Me/NT/2000/XP" then response.write "selected" end if%>>Win9x/Me/NT/2000/XP</option>
                    </select>
                  </td>
              </tr>
                <tr class=07ingds> 
                  <td>推荐程度：</td>
                  <td> <select name="commend" id="commend">
                      <option value="5" <%if rs2("soft_commend")=5 then response.write "selected" end if%>>5stars</option>
                      <option value="4" <%if rs2("soft_commend")=4 then response.write "selected" end if%>>4stars</option>
                      <option value="3" <%if rs2("soft_commend")=3 then response.write "selected" end if%>>3stars</option>
                      <option value="2" <%if rs2("soft_commend")=2 then response.write "selected" end if%>>2stars</option>
                      <option value="1" <%if rs2("soft_commend")=1 then response.write "selected" end if%>>1stars</option>
                      <option value="0" <%if rs2("soft_commend")=0 then response.write "selected" end if%>>0stars</option>
                    </select> </td>
                </tr>
                <tr class=07ingds> 
                  <td>所属分类：</td>
                  <td> <select name="of" id="of">
                      <%
sql="select * from d_cat where sid=0 order by sorder"
set rs1=conn.execute(sql)
do while not rs1.eof
response.write "<optgroup label='"&rs1("cat_name")&"'>"
sql="select * from d_cat where sid="&rs1("cat_id")&" order by sorder" 
set rs3=server.createobject("adodb.recordset")
rs3.open sql,conn,1,1
do while not rs3.eof
%>
              <option value="<%=rs3("cat_id")%>"<%if rs3("cat_id")=rs2("soft_catid") then response.write "selected" end if%>>├ <%=rs3("cat_name")%></option>
<%
rs3.movenext
loop
rs1.movenext
loop
rs3.close
set rs3=nothing
rs1.close
set rs1=nothing%></select></td>
                </tr>
                <tr class=07ingds> 
                  <td>演示地址：</td>
                  <td> <input type="text" name="demo" size="60" class="textarea" value="<%=rs2("soft_demo")%>"> 
                  </td>
                </tr>
                <tr class=07ingds> 
                  <td>主页地址：</td>
                  <td> <input type="text" name="home" size="60" class="textarea" value="<%=rs2("soft_home")%>"> 
                  </td>
                </tr>
                <tr class=07ingds> 
                  <td>图片地址：</td>
                  <td> <input type="text" name="showpic" size="60" class="textarea" value="<%=rs2("soft_showpic")%>"> 
                  </td>
                </tr>
             <tr class=07ingds> 
              <td>上传图片：</td>
              <td align="left" height="25"><iframe frameborder=0 width=290 height=25 scrolling=no src="upload.asp?action=downpic"></iframe></td>
            </tr>
                <tr class=07ingds> 
                  <td>程序简介：</td>
                  <td> <textarea name="desc" cols="65" rows="10" class="textarea" id="desc"><%=rs2("soft_desc")%></textarea> 
                  </td>
                </tr>
                <tr class=07ingds> 
                  <td>本地下载：</td>
                  <td> <input type="text" name="url1" size="60" class="textarea" value="<%=rs2("soft_url1")%>"> 
                  </td>
                </tr>
             <tr class=07ingds> 
              <td>上传软件：</td>
              <td align="left" height="25"><iframe frameborder=0 width=290 height=25 scrolling=no src="upload.asp?action=down"></iframe></td>
            </tr>
                <tr class=07ingds> 
                  <td>镜像下载：</td>
                  <td> <input type="text" name="url2" size="60" class="textarea" value="<%=rs2("soft_url2")%>"> 
                  </td>
                </tr>
                <tr class=07ingds> 
                  <td>远程下载1：</td>
                  <td> <input type="text" name="url3" size="60" class="textarea" value="<%=rs2("soft_url3")%>"> 
                  </td>
                </tr>
                <tr class=07ingds> 
                  <td>远程下载2：</td>
                  <td> <input type="text" name="url4" size="60" class="textarea" value="<%=rs2("soft_url4")%>"> 
                  </td>
                </tr>
                <tr> 
                  <td class=07ingds>下载等级：</td>
                  <td><select name="Grade" id="Grade">
        <option value="0" <%if rs2("Grade")="0" then response.write "selected" end if%>>游客下载</option>
        <option value="1" <%if rs2("Grade")="1" then response.write "selected" end if%>>普通用户</option>
        <option value="2" <%if rs2("Grade")="2" then response.write "selected" end if%>>VIP 用户</option>
        </select>&nbsp;&nbsp;  扣除会员积分数：<input type="text" name="points" size="5" value="<%=rs2("points")%>"> **数字 
                  </td>
                </tr>
                <tr class=07ingds> 
                  <td>软件添加：</td>
                  <td><input type="text" name="tjuser" size="10" value="<%=rs2("tjuser")%>"> 
                  </td>
                </tr>
                <tr class=07ingqs> 
                  <td colspan="2" align="center" height="30">
<input type="checkbox" name="istop" value="1" id="istop" <%if rs2("istop")=1 then response.write "checked" end if%>>
              置顶&nbsp;&nbsp;&nbsp;<input type="checkbox" name="isbest" value="1" id="isbest" <%if rs2("isbest")=1 then response.write "checked" end if%>>
              推荐&nbsp;&nbsp;&nbsp; 
                    <input name="Submit" type="submit" class="button" id="Submit" value="确定修改"> 
<input type="button" value="返回"  onClick="location.href='admin_down.asp?action=list'" class="button"></td>
                </tr>
		<input type="hidden" name="id" value="<%=request.QueryString("id")%>">
                <input type="hidden" name="action" value="editsoft">
                <input type="hidden" name="MM_insert" value="true">
              </form>
            </table>
<%
rs2.close
set rs2=nothing
end if
end if
'****************************************************
' 07ing Ver8.0       Power by 07ing.net
' Web: http://www.07ing.net,http://www.07ing.com
' Copyright (C) 2006 07ing.net All Rights Reserved.
'****************************************************
%>