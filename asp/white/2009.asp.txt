<!--#include file="conn.asp"-->
<!--#Include File="inc/Dv_ClsMain.asp"-->
<!--#include file="inc/md5.asp"-->
<!-- #include file="inc/myadmin.asp" -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML xmlns="http://www.w3.org/1999/xhtml">
<head>
<!--CSS样式表--> 
<style type=text/css>
body ,th,td{
	font:normal 12px 宋体; 
}
body  { margin:0px; background:#C4D8ED; margin:0px; padding:10px; 
SCROLLBAR-FACE-COLOR: #72A3D0; SCROLLBAR-HIGHLIGHT-COLOR: #337ABB; 
SCROLLBAR-SHADOW-COLOR: #337ABB; SCROLLBAR-DARKSHADOW-COLOR: #337ABB; 
SCROLLBAR-3DLIGHT-COLOR: #337ABB; SCROLLBAR-ARROW-COLOR: #FFFFFF;
SCROLLBAR-TRACK-COLOR: #337EC0; 
}
a { color: #135294; text-decoration: none; }
a:hover { color: #ff6600; text-decoration: underline; }
td { height:24px; line-height:20px; background:#EEF7FD; font-size:12px; border:1px solid #fff; color:#135294; padding:2px; }
.td_title,th {
	height:24px;
	line-height:24px;
	background:#fff;
	color:#135294;
	font-weight:bold;
	border:1px solid #fff;
	padding-left:20px;
	text-align:left;
}
TD.td1 { PADDING-RIGHT: 3px; PADDING-LEFT: 3px; BACKGROUND: #F1F3F5; PADDING-BOTTOM: 3px; PADDING-TOP: 3px; }
TD.td2 { PADDING-RIGHT: 3px; PADDING-LEFT: 3px; BACKGROUND: #E4EDF9; PADDING-BOTTOM: 3px; PADDING-TOP: 3px; }
input { border:1px solid #999; }
.button { color: #135294; border:1px solid #666; height:21px; line-height:21px; background:url("images/button_bg.gif")}
.radio { border:none; }
.checkbox { border:none; }
.helplink{
	CURSOR: help;
}
.menuskin {

	BORDER: #666666 1px solid; VISIBILITY: hidden; FONT: 12px Verdana;

	POSITION: absolute; 

	BACKGROUND-COLOR:#EFEFEF;

	background-image:url("skins/default/dvmenubg3.gif");

	background-repeat : repeat-y;

	}

.menuskin A {

	PADDING-RIGHT: 10px; PADDING-LEFT: 25px; COLOR: black; TEXT-DECORATION: none; behavior:url(inc/noline.htc);

	}

#mouseoverstyle {

	BACKGROUND-COLOR: #C9D5E7; margin:2px; padding:0px; border:red 1px solid;

	}

#mouseoverstyle A {

	COLOR: black

}

.menuitems{

	margin:2px;padding:1px;word-break:keep-all;

}
</style>
<!--论坛CSS样式表结束-->
</head>
<BODY leftmargin="0" bottommargin="0" rightmargin="0" topmargin="0" marginheight="0" marginwidth="0" bgcolor="#DDEEFF">
<%
REM ==============================
REM Dv.Yz 编改于 2005-4-16
REM ==============================
Response.Buffer = True
Server.ScriptTimeout = 999999
Dim Rs,Sql,I
REM 加入管理员默认权限
Session("flag") = "1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47"
Session("Userid") = ""
Dim Flag
Flag = "1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,50"
Dim Groupsname, Titlepic
Sql = "SELECT Title, GroupPic FROM Dv_UserGroups WHERE (UserGroupID = 1)"
Set Rs = Dvbbs.Execute(Sql)
If Rs.Eof And Rs.Bof Then
	Groupsname = "管理员"				'管理员等级
	Titlepic = "level10.gif"			'管理员代表图标
Else
	Groupsname = Rs(0)					'管理员等级
	Titlepic = Rs(1)					'管理员代表图标
End If
Set Rs = Nothing

Dim AllPostTable
Dim AllPostTableName
AllPostTable1
AllPostTableName = Split(AllPostTableName,"|")	'帖子表名称数组
AllPostTable = Split(AllPostTable,"|")			'帖子表数组

Select Case Request("action")
Case "newpsw"
	Call Newpsw()			'新管理员
Case "changepsw"
	Call Changepsw()		'更改管理员密码表单
Case "openbbs"
	Call Openbbs()			'打开论坛
Case "saveedit"
	Call Saveedit()			'保存更改密码
Case "boardchild"
	Call Boardchild()		'计算子论坛数量
Case "fixtop"
	Call Fixtop()			'修复固顶帖
Case "delfile"
	Call Delfile()			'删除key管理文件
Case "DelallCache"
	Call DelallCache()		'更新服务器缓存
Case "Fixusertopic"
	Call Fixusertopic()		'更新用户数据
Case "fixonlinetime"
	Call Fixonlinetime()	'修正删除不活动用户时间值过大
Case "fixboardtopstr"
	Call Fixboardtopstr()	'检查并修正版面表固顶字段
Case "fixadmingroups"
	Call Fixadmingroups()	'检查并修正管理员无法登录后台
Case "ChangeAdminFolder"
    Call ChangeAdminFolder() '更改管理目
Case "Execute_Sql"
    Call Execute_Sql() '执行SQL语句
Case Else
	Call Main()				'主菜单
End Select
Response.Write "</body></html>"

REM ==========
REM 主显示菜单
REM ==========
Sub Main()
	'On Error Resume Next
	Dim Boardnum	'版块个数
	Dim Topicnum	'主题个数
	Dim Usernum		'用户个数
	Dim Adminname	'管理员名称
	Dim Findadmin	'是否找到管理员
	Dim Bbstype		'论坛类型
	Dim Bbsopen		'论坛是否开启状态
	Dim Onlinetime	'在线删除用户时间
	Dim iForum_Setting
	Adminname = "admin"	'要创建的管理员名，可更改。
	Findadmin = False
	Sql = "SELECT COUNT(Boardid) FROM [Dv_Board]"
	Set Rs = Dvbbs.Execute(Sql)
	Boardnum = Rs(0)
	Set Rs = Nothing
	Sql = "SELECT COUNT(Topicid) FROM [Dv_Topic]"
	Set Rs = Dvbbs.Execute(Sql)
	Topicnum = Rs(0)
	Set Rs = Nothing
	Sql = "SELECT COUNT(Userid) FROM [Dv_User]"
	Set Rs = Dvbbs.Execute(Sql)
	Usernum = Rs(0)
	Set Rs = Nothing
	Sql = "SELECT Userid From [Dv_User] Where Username = '" & Adminname & "'"
	Set Rs = Dvbbs.Execute(Sql)
	If Rs.Eof And Rs.Bof Then
		Findadmin = False
	Else
		Findadmin = True
	End If
	Set Rs = Nothing
	If IsSqlDataBase = 1 Then
		Bbstype = "SQL版"
	Else
		Bbstype = "ACCESS版"
	End If
	'判断论坛是否开启，与在线时间是否溢出
	Set Rs = Dvbbs.Execute("SELECT Top 1 Forum_Setting FROM [Dv_Setup]")
	If Rs.Eof And Rs.Bof Then
		Bbsopen = False
		Onlinetime = 20
	Else
		iForum_Setting = Split(Rs(0),"|||")
		If Split(iForum_Setting(1),",")(21) = "0" Then
			Bbsopen = True
		Else
			Bbsopen = False
		End If
		If Isnumeric(Split(iForum_Setting(1),",")(8)) Then
			Onlinetime = Split(iForum_Setting(1),",")(8)
		End If
	End If
	Set Rs = Nothing
	'Response.Write "<br><br>"
	'输出站点信息
	Call Ltinfo()
	Response.Write "<table border=""0"" cellspacing=""1"" cellpadding=""3""  align=""center"" width=""100%"">"&_
		"<FORM METHOD=POST ACTION=""?action=newpsw"">"&_
		"<tr>"&_
		"<th width=""80%"" colspan=""2"" style=""text-align:center;"" id=tabletitlelink>Dvbbs-Key管理员钥匙工具 For "
	Response.Write Bbstype
	Response.Write " Dvbbs 8.0.0 <a href=""http://www.cndw.com/contact.asp"" target=""_blank"">联系我们</a>"
	Response.Write "</th>"&_
		"<th width=""20%"" style=""text-align:center;"">Edit By Dv.Yz.2007-6-19</th>"&_
		"</tr>"&_
		"<tr>"&_
		"<td width=20% height=23 class=td1>新建帐号</td>"&_
		"<td width=50% height=23 class=td1>重新建立新的管理员帐号："
	Response.Write Adminname
	Response.Write "</td>"&_
		"<td width=30% height=23 class=td1 valign=middle>"
	If Findadmin Then
		Response.Write "<input type=submit name=submit value=禁止新建 disabled>"&_
			"&nbsp;<font color=gray>论坛已存在["
		Response.Write Adminname
		Response.Write "]用户名</font>"
	Else
		Response.Write "<input type=submit name=submit value=新建帐号>"&_
			"<input type=hidden name=newname value="
		Response.Write Adminname
		Response.Write ">&nbsp;<font color=red>点击将创建["
		Response.Write Adminname
		Response.Write "]为管理员</font>"
	End If
	Response.Write "</td>"&_
		"</tr>"&_
		"</FORM>"&_
		"<FORM METHOD=POST ACTION=""?action=changepsw"">"&_
		"<tr>"&_
		"<td height=23 class=td2>修改密码</td>"&_
		"<td height=23 class=td2>当管理员权限及密码丢失时，重新修改密码。</td>"&_
		"<td width=30% height=23 class=td2 valign=middle>"&_
		"<input type=submit name=submit value=修改密码>"&_
		"</td>"&_
		"</tr>"&_
		"</FORM>"&_
		"<FORM METHOD=POST ACTION=""?action=openbbs"">"&_
		"<tr>"&_
		"<td height=23 class=td1>开启论坛</td>"&_
		"<td height=23 class=td1>论坛关闭快速开启功能。</td>"&_
		"<td width=30% height=23 class=td1 valign=middle>"
	If Bbsopen Then
		Response.Write "<input type=submit name=submit value=无需开启 disabled>"&_
			"&nbsp;<font color=gray>论坛处于开启状态</font>"
	Else
		Response.Write "<input type=submit name=submit value=开启论坛>"&_
			"&nbsp;<font color=red>开启关闭中的论坛</font>"
	End If
	Response.Write "</td>"&_
		"</tr>"&_
		"</FORM>"&_
		"<FORM METHOD=POST ACTION=""?action=boardchild"">"&_
		"<tr>"&_
		"<td height=23 class=td2>分版统计</td>"&_
		"<td height=23 class=td2>重新统计下属论坛个数，论坛共[<font color=red>"
	Response.Write Boardnum
	Response.Write "</font>]个版面，[<font color=red>"
	Response.Write Topicnum
	Response.Write "</font>]个主题。</td>"&_
		"<td width=30% height=23 class=td2 valign=middle>"&_
		"<input type=submit name=submit value=个数统计>"&_
		"</td>"&_
		"</tr>"&_
		"</FORM>"
	Dim Mustfix	'是否需要修复
	Dim Mustfixnum
	'已删除的主题固顶
	Mustfixnum = 0
	Set Rs = Dvbbs.Execute("SELECT COUNT(Topicid) FROM [Dv_Topic] WHERE (istop > 0) AND (Boardid = 444 OR Boardid = 777 OR Boardid = 0)")
	Mustfixnum = Rs(0)
	'IsSmsTopic字段错误
	Conn.CommandTimeOut = 0
	Set Rs = Dvbbs.Execute("SELECT COUNT(Topicid) FROM [Dv_Topic] WHERE IsSmsTopic IS NULL")
	Mustfixnum = Mustfixnum + Rs(0)
	'主题表无发帖表情
	Set Rs = Dvbbs.Execute("SELECT COUNT(Topicid) FROM [Dv_Topic] WHERE Expression IS NULL OR Expression = ''")
	Mustfixnum = Mustfixnum + Rs(0)
	'分版无分版设置
	Set Rs = Dvbbs.Execute("SELECT COUNT(Boardid) FROM [Dv_Board] WHERE Board_User IS NULL")
	Mustfixnum = Mustfixnum + Rs(0)
	'修复版块有分版自定义权限错误
	Set Rs = Dvbbs.Execute("SELECT COUNT(uc_UserID) FROM [Dv_UserAccess] WHERE NOT Uc_Boardid IN (SELECT Boardid FROM Dv_Board)")
	Mustfixnum = Mustfixnum + Rs(0)
	Set Rs = Nothing
	If Mustfixnum > 0 Then
		Mustfix = True
	Else
		Mustfix = False
	End If
	Response.Write "<FORM METHOD=POST ACTION=""?action=fixtop"">"&_
		"<tr>"&_
		"<td height=23 class=td1>修复多项</td>"&_
		"<td height=23 class=td1>修复固顶帖，修复主题表情，修复分版Board_user字段及自定义权限错误。</td>"&_
		"<td width=30% height=23 class=td1 valign=middle>"
	If Mustfix Then
		Response.Write "<input type=submit name=submit value=开始修复>"&_
			"&nbsp;<font color=red>论坛中有"
		Response.Write Mustfixnum
		Response.Write "处此项错误</font>"
	Else
		Response.Write "<input type=submit name=submit value=无需修复 disabled>"&_
			"&nbsp;<font color=gray>论坛中无此项错误</font>"
	End If
	Response.Write "</td>"&_
		"</tr>"&_
		"</FORM>"&_
		"<FORM METHOD=POST ACTION=""?action=DelallCache"">"&_
		"<tr>"&_
		"<td height=23 class=td2>清除缓存</td>"&_
		"<td height=23 class=td2>清空本论坛所在服务器的缓存信息。</td>"&_
		"<td width=30% height=23 class=td2 valign=middle>"&_
		"<input type=submit name=submit value=点击清除>"&_
		"</td>"&_
		"</tr>"&_
		"</FORM>"
	'修复用户信息错误
	Mustfixnum = 0
	Set Rs = Dvbbs.Execute("SELECT COUNT(UserID) FROM [Dv_User] WHERE (UserTopic IS NULL)")
	Mustfixnum = Rs(0)
	If IsSqlDataBase = 1 Then
		Set Rs = Dvbbs.Execute("SELECT COUNT(UserID) FROM [Dv_User] WHERE (Joindate IS NULL) Or Joindate = ''")
		Mustfixnum = Mustfixnum + Rs(0)
	Else
		Set Rs = Dvbbs.Execute("SELECT COUNT(UserID) FROM [Dv_User] WHERE (Joindate IS NULL) Or NOT ISDATE(Joindate)")
		Mustfixnum = Mustfixnum + Rs(0)
	End If
	Set Rs = Dvbbs.Execute("SELECT COUNT(UserID) FROM [Dv_User] WHERE UserBirthday = '//'")
	Mustfixnum = Mustfixnum + Rs(0)
	Set Rs = Nothing
	If Mustfixnum > 0 Then
		Mustfix = True
	Else
		Mustfix = False
	End If
	Response.Write "<FORM METHOD=POST ACTION=""?action=Fixusertopic"">"&_
		"<tr>"&_
		"<td height=23 class=td1>修用户值</td>"&_
		"<td height=23 class=td1>修复用户主题值、注册日期为空，星座显示undefined的错误，论坛共[<font color=red>"
	Response.Write Usernum
	Response.Write "</font>]名用户。</td>"&_
		"<td width=30% height=23 class=td1 valign=middle>"
	If Mustfix Then
		Response.Write "<input type=submit name=submit value=点击修复>"&_
			"&nbsp;<font color=red>论坛中有"
		Response.Write Mustfixnum
		Response.Write "处此项错误</font>"
	Else
		Response.Write "<input type=submit name=submit value=无需修复 disabled>"&_
			"&nbsp;<font color=gray>论坛中无此项错误</font>"
	End If
	Response.Write "</td>"&_
		"</tr>"&_
		"</FORM>"&_
		"<FORM METHOD=POST ACTION=""?action=fixonlinetime"">"&_
		"<tr>"&_
		"<td height=23 class=td2>在线时间</td>"&_
		"<td height=23 class=td2>删除不活动用户时间填写过大会影响论坛运行。</td>"&_
		"<td width=30% height=23 class=td2 valign=middle>"
	If Onlinetime < 32767 Then
		Response.Write "<input type=submit name=submit value=无需修复 disabled>"&_
			"&nbsp;<font color=gray>时间数值正常("
		Response.Write Onlinetime
		Response.Write "分钟)</font>"
	Else
		Response.Write "<input type=submit name=submit value=开始修复>"&_
			"&nbsp;<font color=red>修正时间值("
		Response.Write Onlinetime
		Response.Write "分钟)</font>"
	End If
	Response.Write "</td>"&_
		"</tr>"&_
		"</FORM>"
	'需要修复的固顶数
	Mustfixnum = 0
	Dim Tstr, ii
	Sql = "SELECT Boardtopstr FROM Dv_Board ORDER BY BoardID"
	Set Rs = Dvbbs.Execute(Sql)
	If Not (Rs.Eof And Rs.Bof) Then
		Sql = Rs.GetRows(-1)
		Set Rs = Nothing
		For i = 0 To Ubound(Sql,2)
			If Not (Sql(0,i) = "" And Isnull(Sql(0,i))) Then
				Tstr = Split(Sql(0,i),",")
				For ii = 0 To Ubound(Tstr)
					Set Rs = Dvbbs.Execute("SELECT TopicID FROM Dv_Topic WHERE TopicID = " & Tstr(ii) & " AND Istop > 0 ORDER BY TopicID")
					If Rs.Eof And Rs.Bof Then Mustfixnum = Mustfixnum + 1
					Set Rs = Nothing
				Next
			End If
		Next
	End If
	'检查总固顶
	Sql = "SELECT Top 1 Forum_alltopnum FROM Dv_Setup"
	Set Rs = Dvbbs.Execute(Sql)
	If Not (Rs.Eof And Rs.Bof) Then
		If Instr(Rs(0),",") > 0 Then
			Tstr = Split(Rs(0),",")
			For ii = 0 To Ubound(Tstr)
				Set Rs = Dvbbs.Execute("SELECT TopicID FROM Dv_Topic WHERE TopicID = " & Tstr(ii) & " AND Istop > 0 ORDER BY TopicID")
				If Rs.Eof And Rs.Bof Then Mustfixnum = Mustfixnum + 1
				Set Rs = Nothing
			Next
		End If
	End If
	If Mustfixnum > 0 Then
		Mustfix = True
	Else
		Mustfix = False
	End If
	Response.Write "<FORM METHOD=POST ACTION=""?action=fixboardtopstr"">"&_
		"<tr>"&_
		"<td height=23 class=td1>修固顶值</td>"&_
		"<td height=23 class=td1>修复帖子解固后无法被固顶或区固顶的错误。</td>"&_
		"<td width=30% height=23 class=td1 valign=middle>"
	If Mustfix Then
		Response.Write "<input type=submit name=submit value=点击修复>"&_
			"&nbsp;<font color=red>论坛中有"
		Response.Write Mustfixnum
		Response.Write "处此项错误</font>"
	Else
		Response.Write "<input type=submit name=submit value=无需修复 disabled>"&_
			"&nbsp;<font color=gray>论坛中无此项错误</font>"
	End If
	Response.Write "</td></tr></form>"

	'是否需要修复管理员可进后台
	Mustfixnum = 0
	Dim GroupSetting
	Sql = "SELECT GroupSetting From Dv_UserGroups Where UserGroupID = 1"
	Set Rs = Dvbbs.Execute(Sql)
	If Not (Rs.Eof And Rs.Bof) Then
		GroupSetting = Split(Rs(0), ",")
	End If
	If Ubound(GroupSetting) = 0 Then
		Mustfix = False
	ElseIf GroupSetting(70) = "0" Then
		Mustfix = True
	Else
		Mustfix = False
	End If
	Response.Write "<FORM METHOD=POST ACTION=""?action=fixadmingroups"">"&_
		"<tr>"&_
		"<td height=23 class=td2>后台管理</td>"&_
		"<td height=23 class=td2>修复管理员无法进入后台的错误。</td>"&_
		"<td width=30% height=23 class=td2 valign=middle>"
	If Mustfix Then
		Response.Write "<input type=submit name=submit value=点击修复>"&_
			"&nbsp;<font color=red>修复管理进后台权限</font>"
	Else
		Response.Write "<input type=submit name=submit value=无需修复 disabled>"&_
			"&nbsp;<font color=gray>论坛中无此项错误</font>"
	End If
	Response.Write "</td></tr></form>"
	'更改管理目录
	Dim Sql,Rs,AdminFolder
	Sql="select top 1 forum_adminfolder from dv_setup"
	Set Rs=Dvbbs.Execute(Sql)
	If Not (Rs.Bof And Rs.Eof) Then 
	AdminFolder=Rs(0)
	Else
    AdminFolder="admin/"
	End If 
	Rs.Close:Set Rs=Nothing
		Response.Write "<FORM METHOD=POST ACTION=""?action=ChangeAdminFolder"">"&_
		"<tr>"&_
		"<td height=23 class=td2>更改管理目录</td>"&_
		"<td height=23 class=td2>同时更改后台管理目录。</td>"&_
		"<td width=30% height=23 class=td2 valign=middle>"
	 Response.Write "<input type=hidden name=OldAdminFolder value="&AdminFolder&">"
		Response.Write "<input type=text name=NewAdminFolder value="&AdminFolder&">"&_
			"&nbsp;<input type=submit value=更改>"
	Response.Write "</td></tr></form>"
Response.Write "<form method=post action=""?action=Execute_Sql"">"&_
		"<tr>"&_
		"<td height=23 class=td1>执行语句</td>"&_
		"<td height=23 class=td1>请输入SQL语句，支持多条语句，每条语句一行。"&_
		"&nbsp;<font color=gray>不熟悉SQL语法，请勿使用！</font><br/>"&_
		"<textarea name=""Sqltext"" style=""width:500px;height:100px;""></textarea></td>"&_
		"<td height=23 class=td1><input type=""submit"" value=""点击执行""></td>"
	Response.Write "</td></tr></form>"

	Response.Write "<tr>"&_
		"<th colspan=2 id=tabletitlelink style=""text-align:center;"">！！！切记使用完毕后立刻"&_
		" <i>改名</i> 或"&_
		" <i>删除</i> 此文件，不要留下后门哦^！^&nbsp;--->>>"&_
		"<a href="
	Response.Write Dvbbs.ScriptName
	Response.Write "?action=delfile>点击删除</a>"&_
		"</th>"&_
		"<th align=left id=tabletitlelink style=""text-align:center;"">"&_
		"<a target=_blank href=index.asp>&lt;&lt;&lt;回到论坛&gt;&gt;&gt;</a>&nbsp;<a target=_blank href=admin_login.asp>&lt;&lt;&lt;进后台&gt;&gt;&gt;</a></th>"&_
		"</tr>"&_
		"</table>"
	Set Rs = Nothing
End Sub
REM ==========================
REM 执行SQL语句
REM ==========================
Sub Execute_Sql()
Dim Sqltext_arr,Sqltext,i
i=0
Sqltext_arr=Request("Sqltext")
If Sqltext_arr="" Or IsNull(Sqltext_arr) Or IsEmpty(Sqltext_arr) Then Response.Write "<script>alert('请输入SQL语句');history.go(-1);</script>"
Sqltext_arr=Split(Sqltext_arr,vbcrlf)
For Each Sqltext In Sqltext_arr
i=i+1
Call Execute_Sqltext(Sqltext,i)
Next
End Sub 
REM ==========================
REM SQL函数
REM ==========================
Function Execute_Sqltext(Sql,SqlCount)
Response.Write "<table cellspacing='1'><tr><th>["& Sql &"]执行结果</th></tr>"
On Error Resume Next 
Dim Rs,Rs_arr
Set Rs=ExecuteSql(Sql,SqlCount)
If Err.number <> 0 Then 
	Response.Write "<tr><td><ul><li>SQL语句执行错误，错误信息：" & Err.Description & "</li>"
	Response.Write "</ul></td></tr><tr><td><input type=""button"" onclick=""history.back(-1);"" value=""返回""></td></tr></table>"
	Err.Clear
	Rs.Close:Set Rs=Nothing
	Exit Function 
Else
    If Rs.State <> 1 Then 
		Response.Write "<tr><td><ul><li>SQL语句执行成功，所影响的行数为<span style='color:red;'>" & SqlCount & "</span>行</li></ul>"
		Response.Write "</ul></td></tr><tr><td><input type=""button"" onclick=""history.back();"" value=""返回""></td></tr></table>"
		Rs.Close:Set Rs=Nothing
		Exit Function
	Else 
		If Rs.BOF And Rs.EOF Then
			Response.Write "<tr><td><ul><li>SQL语句查询成功,返回结果为空！</li>"
			Response.Write "</ul></td></tr><tr><td><input type=""button"" onclick=""history.back();"" value=""返回""></td></tr></table>"
			Rs.Close:Set Rs=Nothing
			Exit Function
        Else 
			Dim n,m
			Rs_arr=Rs.GetRows(-1)
            Response.Write "</table><div style=""width:95%;overflow:scroll;border:1px gray solid;padding:10px;max-height:300px;""><table cellspacing='1' border='1'><tr>"
            For n=0 To Rs.Fields.Count-1
				 If n Mod 2 =0 Then 
					Response.Write "<td style='background-color:#fff;max-width:40px;vertical-align:top;'>"& _
					Rs.Fields(n).Name &"</td>"
				 Else 
					Response.Write "<td style='background-color:#EEF7FC;max-width:40px;vertical-align:top;'>"& _
					Rs.Fields(n).Name &"</td>"
				End If 	
		   Next 
		   Response.Write "</tr>"
           Rs.Close:Set Rs = Nothing
					For n = 0 To UBound(Rs_arr,2)
                        Response.Write "<tr>"
                        For m= 0 To UBound(Rs_arr,1)
                            If (m Mod 2) = 0 Then
								If IsNull(Rs_arr(m,n)) Then 
								Response.Write "<td style='background-color:#fff;color:red;vertical-align:top;'>NULL</td>"
								ElseIf Rs_arr(m,n)="" Then 
								Response.Write "<td style='background-color:#fff;color:red;vertical-align:top;'>暂无记录</td>"
								Else 
								Response.Write "<td style='background-color:#fff;max-width:40px;vertical-align:top;'>"&Server.HTMLEncode(Rs_arr(m,n)) &"</td>"
								End If 

                            Else
								If IsNull(Rs_arr(m,n)) Then 
								Response.Write "<td style='color:red;background-color:#EEF7FC;vertical-align:top;'>NULL</td>"
								ElseIf Rs_arr(m,n)="" Then 
								Response.Write "<td style='color:red;background-color:#EEF7FC;vertical-align:top;'>暂无记录</td>"
								Else 
								Response.Write "<td style='background-color:#EEF7FC;max-width:40px;vertical-align:top;'>"&Server.HTMLEncode(Rs_arr(m,n)) &"</td>"
								End If 
                            End If
                        Next
                        Response.Write "</tr>"
                    Next
                    Response.Write "</table></div><table cellspacing='1'><tr><td><input type=""button"" onclick=""history.back();"" value=""返回""></td></tr></table>"
					Response.Flush
		 End If 

	End If 
End If 
End Function 
Function ExecuteSql(Command,CommandCount)
If Not IsObject(Conn) Then ConnectionDataBase
If Dvbbs.ShowSQL=1 Then 
Response.Write Command&"<hr />"
Set ExecuteSql=Conn.Execute(Command,CommandCount)
Else 
Set ExecuteSql=Conn.Execute(Command,CommandCount)
End If 
End Function 

REM ==========================
REM 判断管理目录
REM ==========================
Function AdminFolder(Folder)
Dim Fso_Admin
Set Fso_Admin=Server.CreateObject("Scripting.FileSystemObject")
If Fso_Admin.FolderExists(Folder) Then 
AdminFolder=True
Else
AdminFolder=False
End If 
Set Fso_Admin=Nothing 
End Function 
REM ==========================
REM 更改管理目录
REM ==========================
Sub ChangeAdminFolder()
Dim OldAdminFolder,NewAdminFolder
Dim OldAdminFolderPath,NewAdminFolderPath
OldAdminFolder=Request.Form("OldAdminFolder")
NewAdminFolder=Request.Form("NewAdminFolder")
	If IsNull(NewAdminFolder) Or NewAdminFolder="" Or IsEmpty(NewAdminFolder) Then 
	Response.Write "<Script>alert('管理目录不能为空');history.go(-1);</Script>"
	Else 
    OldAdminFolderPath=Server.MapPath(OldAdminFolder)
	NewAdminFolderPath=Server.MapPath(NewAdminFolder)
	Dim Fso_Change_AdminFolder
	Set Fso_Change_AdminFolder=Server.CreateObject("Scripting.FileSystemObject")
		If Not AdminFolder(NewAdminFolderPath) Then 
			If Err Then 
			'Err.Clear
			Response.Write Err.description&"<hr />"
			Response.Write "请正确填写管理目录"
			Else 
			Fso_Change_AdminFolder.CreateFolder(NewAdminFolderPath)
			Fso_Change_AdminFolder.CopyFolder OldAdminFolderPath,NewAdminFolderPath
			Fso_Change_AdminFolder.DeleteFolder(OldAdminFolderPath)
			Set Fso_Change_AdminFolder=Nothing 
			End If 
		Dim Sql
		Sql="update dv_setup set forum_adminfolder='"&NewAdminFolder&"'"
		Dvbbs.Execute(Sql)
		Response.Write "<li>更改管理目录成功"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		Else 
		Response.Write "<li>填写的管理目录已经存在，请另外输入"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		End if
	End If 
End Sub 

REM ==========================
REM 修改管理员与设置管理员页面
REM ==========================
Sub Changepsw()
	Sql = "SELECT U.UserID, U.UserName, U.UserPassWord, U.LastLogin, A.UserName, A.PassWord, A.LastLogin, A.LastLoginIP FROM [Dv_User] U INNER JOIN [" & Admintable & "] A ON U.UserName = A.AddUser WHERE U.UserGroupID = 1 ORDER BY U.UserID"
	Set Rs = Conn.Execute(Sql)
	If Rs.Eof And Rs.Bof Then
		Sql = ""
	Else
		Sql = Rs.GetString(,,"</td><td>|","</td></tr><tr><td>|","")
		Sql = Left(Sql,Len(Sql)-9)
		Set Rs = Nothing
	End If
%>
	<FORM METHOD=POST ACTION="?action=saveedit">
	<table border="0" cellspacing="1" cellpadding="3"  align="center" width="100%">
	  <tr>
	    <th width="100%" colspan="2" style="text-align:center;">请填写管理员修改资料</th>
	  </tr>
	  <tr>
	    <td width="15%" height="24" class="td2" align="right">现有管理员名单：</td>
	    <td height="24" class="td2"><table><tr><td>|<%=Sql%></table></td>
	  </tr>
	  <tr>
	    <td height="24" class="td1" align="right">前台登陆名:</td>
	    <td height="24" class="td1"><input TYPE="text" NAME="name1" size="20" value="admin"></td>
	  </tr>
	  <tr>
	    <td height="24" class="td2" align="right">新的前台登陆密码:</td>
	    <td height="24" class="td2"><input TYPE="password" name="pass1" size="20" value="admin888">(长度不能大于10小于6，默认密码为：admin888)</td>
	  </tr>
	  <tr>
	    <td height="24" class="td1" align="right">新的后台登名:</td>
	    <td height="24" class="td1"><input TYPE="text" NAME="name2" size="20" value="admin"></td>
	  </tr>
	  <tr>
	    <td height="24" class="td2" align="right">新的后台登陆密码:</td>
	    <td height="24" class="td2"><input TYPE="password" name="pass2" size="20" value="admin888">(长度不能大于10小于6，默认密码为：admin888)</td>
	  </tr>
	  <tr>
	    <th height="19" align=right><input type="submit" value="提交" name="B1">&nbsp;&nbsp;<input type="reset" value="全部重写" name="B2"></th>
		<th id=tabletitlelink><a href="<%=Dvbbs.ScriptName%>">&lt;&lt;返回上一层</a></th>
	  </tr>
	</table>
	</FORM>
<%
End Sub

REM ==============
REM 设置管理员密码
REM ==============
Sub Saveedit()
	Dim Name1, Name2, Pass1, Pass2, LPass1, LPass2
	Dim AdminID
	Name1 = CheckStr(trim(request.form("name1")))
	Name2 = CheckStr(trim(request.form("name2")))
	LPass1 = CheckStr(trim(request.form("pass1")))
	LPass2 = CheckStr(trim(request.form("pass2")))
	Response.Write "<font color=red><br><ul>"
	If Name1 = "" Then
		Response.Write "<li>请输入已存在的前台登陆用户名。"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		Exit Sub
	End If
	If Name2 = "" Then
		response.write "<li>请输入后台登录用户名。"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		Exit Sub
	End If
	If LPass1 = "" Or Len(LPass1) > 10 Or Len(LPass1) < 6 Then
		Response.write "<li>请输入新的前台登陆密码,(长度不能大于10小于6)。"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		Exit Sub
	Else
		Pass1 = Md5(LPass1,16)
	End If
	If LPass2 = "" Or Len(LPass2) > 10 Or Len(LPass2) < 6 Then
		Response.write "<li>请输入新的后台登陆密码,(长度不能大于10小于6)。"
		Response.Write "<a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		Exit Sub
	Else
		Pass2 = Md5(LPass2,16)
	End If
	'判断用户名是否已注册
	Sql = "SELECT Userid, UserName FROM [Dv_User] WHERE UserName = '" & Name1 & "'"
	Set Rs = Dvbbs.Execute(Sql)
	If Rs.Eof And Rs.Bof Then
		'如果未注册则要求建立新管理员名。
		Response.Write "<li>修改失败："
		Response.Write "<li>您所填写的用户名不存在，请选择新建管理员帐号。"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		Exit Sub
	Else
		AdminID = Rs(0)
		Set Rs = Nothing
		REM ：判断用户是否已存在于管理员列表。
		Sql = "SELECT * FROM [" & Admintable & "] WHERE Adduser = '"&Name1&"'"
		Set Rs = Conn.Execute(Sql)
		If Rs.Eof And Rs.Bof Then
			REM ：如果管理员名单没有填写的对应前台名则新建立。
			Conn.Execute("INSERT INTO " & Admintable & " (Username, [Password], Flag, Adduser) VALUES ('" & Name2 & "', '" & Pass2 & "','" & Flag & "', '" & Name1 & "')")
		Else
			REM ：如果管理员名单存在填写的对应前台名则改写后台名与后台登录密码。
			Conn.Execute("UPDATE " & Admintable & " SET Username = '" & Name2 & "', [Password] = '" & Pass2 & "', Flag = '" & Flag & "' WHERE Adduser = '" & Name1 & "'")
		End If
		Set Rs = Nothing
		REM ：更新用户表的该用户的前台密码、等级。
		Dvbbs.Execute("UPDATE Dv_User SET UserPassword = '" & Pass1 & "', Usergroupid = 1, Userclass = '" & Groupsname & "', Titlepic = '" & Titlepic & "' WHERE Userid = " & AdminID)
	End If
	Response.Write "<li>修改成功!"
	Response.Write "<li>请记好你的新密码："
	Response.Write "<li>前台登录：用户名（"
	Response.Write Name1
	Response.Write "）&nbsp;密码（"
	Response.Write LPass1
	Response.Write "）<li>后台登录：用户名（"
	Response.Write Name2
	Response.Write "）&nbsp;密码（"
	Response.Write LPass2
	Response.Write "）<li><li><a href="&Request.ServerVariables("HTTP_REFERER")&"><font color=red><<返回上一页</font></a>"
End Sub

REM ============
REM 建立新管理员
REM ============
Sub Newpsw()
	Dim Newname, Pass, Pass1, Adminmail, AdminIM
	Newname = Request("newname")
	If Newname = "" Or Isnull(Newname) Then Newname = "admin"
	Pass1 = "admin888"
	Adminmail = Newname & "@aspsky.net"
	AdminIM = "||||||||||||||||||"
	Pass = Md5(Pass1,16)	'密码加密默认为16位，如果为32位请更改。
	Response.Write "<font color=red><br><ul>"
	Sql = "SELECT * FROM Dv_User WHERE UserName = '" & Newname & "'"
	Set Rs = Server.Createobject("Adodb.Recordset")
	Rs.Open Sql,Conn,1,3
	If Not (Rs.Eof And Rs.Bof) Then
		REM 如果用户列表已存在该用户则要求运行修改密码程序。
		Response.Write "<li>新建失败："
		Response.Write "<li>用户名已存在请选择修改密码。"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
	Else
		'加入用户表
		Rs.Addnew
		Rs("Username") = Newname
		Rs("Userpassword") = Pass
		Rs("Userclass") = Groupsname
		Rs("UserGroupID") = 1
		Rs("Titlepic") = Titlepic
		Rs("UserPost") = 0
		Rs("UserWealth") = 100
		Rs("Userep") = 30
		Rs("Usercp") = 30
		Rs("Userisbest") = 0
		Rs("Userdel") = 0
		Rs("Userpower") = 0
		Rs("Lockuser") = 0
		Rs("UserSex") = 1
		Rs("UserEmail") = Adminmail
		Rs("UserFace") = "Images/userface/image1.gif"
		Rs("UserWidth") = 32
		Rs("UserHeight") = 32 
		Rs("UserIM") = AdminIM
		Rs("UserFav") = "陌生人,我的好友,黑名单"
		Rs("LastLogin") = Now()
		Rs("JoinDate") = Now()
		Rs.Update
		'加入管理员表
		Sql = "INSERT INTO [" & Admintable & "] (Username, [Password], Flag, Adduser) VALUES ('" & Newname & "','" & Pass & "','" & Flag & "','" & Newname & "')"
		Conn.Execute(Sql)
		Response.Write "<font color=red><br><ul><li>创建帐号完成：<li>用户名："
		Response.Write Newname
		Response.Write "<li>密码："
		Response.Write Pass1
		Response.Write "</font>"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
	End If
	Set Rs = Nothing
	Response.Write "</Font>"
End Sub

REM ==============
REM 打开关闭的论坛
REM ==============
Sub Openbbs()
	Dim iForum_Setting, Forum_Setting, Settingstr, Setting
	Response.Write "<font color=red><br><ul>"
	Set Rs = Dvbbs.Execute("SELECT Forum_Setting FROM [Dv_Setup]")
	iForum_Setting = Split(Rs(0),"|||")
	Set Rs = Nothing
	Setting = Split(iForum_Setting(1),",")
	If Cint(Setting(21)) = 0 Then
		Response.Write "<li>开启失败："
		Response.Write "<li>论坛并不处于关闭状态，无需打开。"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		Response.Write "</Font>"
	Else
		Setting(21) = "0"
		For i = 0 To Ubound(Setting)
			IF Settingstr = "" Then
				Settingstr = Setting(i)
			Else
				Settingstr = Settingstr & "," & Setting(i)
			End if
		Next
		Forum_Setting = iforum_Setting(0) & "|||" & Settingstr & "|||" & iForum_Setting(2) & "|||" & iForum_Setting(3) & "|||" & iForum_Setting(4) & "|||" & iForum_Setting(5)
		Forum_Setting = Checkstr(Forum_Setting)
		Dvbbs.Execute("UPDATE [Dv_Setup] SET Forum_Setting = '" & Forum_Setting & "'")
		Response.Write "<li>论坛已经开启。"
		Response.Write "<li>请更新论坛缓存。"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		Response.Write "</Font>"
	End If
End Sub

REM ============================
REM 修正删除不活动用户时间值过大
REM ============================
Sub Fixonlinetime()
	Dim iForum_Setting, Forum_Setting, Settingstr, Setting
	Response.Write "<font color=red><br><ul>"
	Set Rs = Dvbbs.Execute("SELECT Forum_Setting FROM [Dv_Setup]")
	iForum_Setting = Split(Rs(0),"|||")
	Set Rs = Nothing
	Setting = Split(iForum_Setting(1),",")
	If Not Isnumeric(Setting(8)) Then Setting(8) = "40"
	If Int(Setting(8)) < 32767 Then
		Response.Write "<li>删除不活动用户时间值正常，无需修复。"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		Response.Write "</Font>"
	Else
		Setting(8) = "40"
		For i = 0 To Ubound(Setting)
			IF Settingstr = "" Then
				Settingstr = Setting(i)
			Else
				Settingstr = Settingstr & "," & Setting(i)
			End if
		Next
		Forum_Setting = iforum_Setting(0) & "|||" & Settingstr & "|||" & iForum_Setting(2) & "|||" & iForum_Setting(3) & "|||" & iForum_Setting(4) & "|||" & iForum_Setting(5)
		Forum_Setting = Checkstr(Forum_Setting)
		Dvbbs.Execute("UPDATE [Dv_Setup] SET Forum_Setting = '" & Forum_Setting & "'")
		Dvbbs.Name = "setup"
		Dvbbs.ReloadSetup
		Response.Write "<li>删除不活动用户时间值修复完毕。"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		Response.Write "</Font>"
	End If
End Sub

REM ==============
REM 统计分论坛个数
REM ==============
Sub Boardchild()
	Dim cBoardNum, cBoardid
	Dim Trs
	Dim Bn
	Dvbbs.Execute("UPDATE Dv_Board SET Child = 0")
	Set Rs = Dvbbs.Execute("SELECT Boardid, Rootid, ParentID, Depth, Child, ParentStr FROM Dv_Board ORDER BY Boardid DESC")
	If Not (Rs.Eof And Rs.Bof) Then
		Sql = Rs.GetRows(-1)
		Set Rs = Nothing
		For Bn = 0 To Ubound(Sql,2)
			If Isnull(Sql(4,Bn)) And Cint(Sql(3,Bn)) > 0 Then
				Dvbbs.Execute("UPDATE Dv_Board SET Child = 0 WHERE Boardid = " & Sql(0,Bn))
			End If
			If Cint(Sql(2,Bn)) = 0 And Cint(Sql(3,Bn)) = 0 Then
				Set Trs = Dvbbs.Execute("SELECT COUNT(*) FROM Dv_Board WHERE RootID = " & Sql(1,Bn))
				Cboardnum = Trs(0) - 1
				Set Trs = Nothing
				If Isnull(Cboardnum) Or Cboardnum < 0 Then Cboardnum = 0
				Dvbbs.Execute("UPDATE Dv_Board SET Child = " & Cboardnum & " WHERE Boardid = " & Sql(0,Bn))
			Elseif Cint(Sql(3,Bn)) > 1 Then
				cBoardid = Split(Sql(5,Bn),",")
				For i = 1 To Ubound(cBoardid)
					Dvbbs.Execute("UPDATE Dv_Board SET Child = Child + 1 WHERE Boardid = " & cBoardid(i))
				Next
			End If
		Next
	End If
	Response.write "<font color=red><br><ul><li>论坛下属分版面个数统计更新完成。"
	Response.Write "<Li><a href="&Request.ServerVariables("HTTP_REFERER")&"><font color=red><<返回上一页</font></a></font>"
End Sub

REM ========
REM 修复多项
REM ========
Sub Fixtop()
	Dim Tnum, Fnum, Snum, Unum
	Tnum = 0:Fnum = 0:Snum = 0:Unum = 0
	Response.Write "<Font color=red><br><ul>"
	'修复已删除的主题固顶
	Set Rs = Dvbbs.Execute("SELECT COUNT(Topicid) FROM [Dv_Topic] WHERE (istop > 0) AND (Boardid = 444 OR Boardid = 777 OR Boardid = 0)")
	Tnum = Rs(0)
	'IsSmsTopic字段错误
	Conn.CommandTimeOut = 0
	Set Rs = Dvbbs.Execute("SELECT COUNT(Topicid) FROM [Dv_Topic] WHERE IsSmsTopic IS NULL")
	Tnum = Tnum + Rs(0)
	If Tnum > 0 Then
		Dvbbs.Execute("UPDATE Dv_Topic SET istop = 0 WHERE (istop > 0) AND (Boardid = 444 OR Boardid = 777 OR Boardid = 0)")
		Dvbbs.Execute("UPDATE Dv_Topic SET IsSmsTopic = 0 WHERE IsSmsTopic IS NULL")
	End If
	'修复主题表无发帖表情
	Set Rs = Dvbbs.Execute("SELECT COUNT(Topicid) FROM [Dv_Topic] WHERE Expression IS NULL OR Expression = ''")
	Fnum = Rs(0)
	If Fnum > 0 Then Dvbbs.Execute("UPDATE Dv_Topic SET Expression = 'face01.gif' WHERE Expression IS NULL OR Expression = ''")
	'修复分版无分版设置
	Set Rs = Dvbbs.Execute("SELECT COUNT(Boardid) FROM [Dv_Board] WHERE Board_User IS NULL")
	Snum = Rs(0)
	If Snum > 0 Then Dvbbs.Execute("UPDATE Dv_Board SET Board_User = '100,5,2,7,1,1,1,0,5,0,50,3,1,5,1,10,5,3' WHERE Board_User IS NULL")
	'修复版块有分版自定义权限错误
	Set Rs = Dvbbs.Execute("SELECT COUNT(uc_UserID) FROM [Dv_UserAccess] WHERE NOT Uc_Boardid IN (SELECT Boardid FROM Dv_Board)")
	Unum = Rs(0)
	If Unum > 0 Then Dvbbs.Execute("DELETE FROM [Dv_UserAccess] WHERE NOT Uc_Boardid IN (SELECT Boardid FROM Dv_Board)")
	Set Rs = Nothing
	'==========
	Response.Write "<li>[" & Tnum & "]个固顶帖与总固顶帖修复完成。"
	Response.Write "<li>[" & Fnum & "]个主题表情Expression修复完成。"
	Response.Write "<li>[" & Snum & "]个分版权限Board_user复完默认设置。"
	Response.Write "<li>[" & Unum & "]个分版自定义权限清理完成。"
	Response.Write "<Li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a></font>"
End Sub

REM ======================
REM 删除本文件以防留下后门
REM ======================
Sub Delfile()
	Response.Write "<Font color=red><br>aa<ul>"
	On Error Resume Next
	Dim ObjFSO
	Set ObjFSO = CreateObject("Scripting.FileSystemObject")
	ObjFSO.DeleteFile(Server.MapPath(Dvbbs.ScriptName))
	If Err.Number = "0" Then
		Response.Write "<li>删除管理员KEY程序成功！"
		Response.Write "<Li><a href=index.asp><font color=red><<返回论坛</font></a></font>"
	Else
		Response.Write "<li>删除失败！"
		Response.Write "<li>系统提示：" & Err.Description
		Response.Write "<li>请手动在FTP中删除此文件！"
		Response.Write "<Li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a></font>"
	End If
	Set ObjFSO = Nothing
End Sub

REM ===============
REM 过滤SQL非法字符
REM ===============
Function CheckStr(Str)
	If Isnull(Str) Then
		checkStr = ""
		Exit Function
	End If
	CheckStr = Replace(Str, "'", "''")
End Function

REM ==============
REM 更新服务器缓存
REM ==============
Sub DelallCache()
	Response.Write "<Font color=red><br><ul>"

	Dim cachelist,i
	Call InnerHtml("<b>开始执行清理当前站点缓存</b>：")
	Cachelist=split(GetallCache(),",")
	If UBound(cachelist)>1 Then
		For i=0 to UBound(cachelist)-1
			DelCahe Cachelist(i)
			Call InnerHtml("更新 <b>"&cachelist(i)&"</b> 完成")
		Next
		Call InnerHtml("更新了"& UBound(cachelist)-1 &"个缓存对象<br>")
	Else
		Call InnerHtml("<b>当前站点全部缓存清理完成。</b>。")
	End If	
	Response.Write "<li>更新服务器缓存成功！"
	Response.Write "<Li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a></font>"
End Sub

REM ========================
REM 修复用户发帖主题数NULL值
REM ========================
Sub Fixusertopic()
	Dim Tnum, Jnum, Bnum
	Tnum = 0:Jnum = 0:Bnum = 0
	Response.Write "<Font color=red><br><ul>"
	'修复主题数为NULL值的错误，避免后台统计用户分值时归零
	Set Rs = Dvbbs.Execute("SELECT COUNT(UserID) FROM [Dv_User] WHERE (UserTopic IS NULL)")
	Tnum = Rs(0)
	If Tnum > 0 Then
		If IsSqlDataBase = 1 Then
			Conn.CommandTimeOut = 0
			Dvbbs.Execute("UPDATE Dv_User SET UserTopic = (SELECT COUNT(*) FROM Dv_Topic WHERE Dv_Topic.PostUserID = Dv_User.UserId) WHERE UserTopic IS NULL")
		Else
			Sql = "SELECT Userid FROM Dv_User Where UserTopic IS NULL"
			Set Rs = Dvbbs.Execute(Sql)
			If Not Rs.Eof Then
				Sql = Rs.GetRows(-1)
				Set Rs = Nothing
				For i = 0 To Ubound(Sql,2)
					Set Rs = Dvbbs.Execute("SELECT COUNT(*) FROM Dv_Topic WHERE PostUserID = " & Sql(0,i))
					If Not Rs.Eof Then
						Dvbbs.Execute("UPDATE Dv_User SET UserTopic = " & Rs(0) & " WHERE UserID = " & Sql(0,i))
						Set Rs = Nothing
					End If
				Next
			End If
		End If
	End If
	'==========
	'修复注册日期NULL值
	If IsSqlDataBase = 1 Then
		Set Rs = Dvbbs.Execute("SELECT COUNT(UserID) FROM [Dv_User] WHERE (Joindate IS NULL) Or Joindate = ''")
		Jnum = Rs(0)
		If Jnum > 0 Then Dvbbs.Execute("UPDATE Dv_User SET Joindate = " & SqlNowString & " WHERE (Joindate IS NULL) Or Joindate = ''")
	Else
		Set Rs = Dvbbs.Execute("SELECT COUNT(UserID) FROM [Dv_User] WHERE (Joindate IS NULL) Or NOT ISDATE(Joindate)")
		Jnum = Rs(0)
		If Jnum > 0 Then Dvbbs.Execute("UPDATE Dv_User SET Joindate = " & SqlNowString & " WHERE (Joindate IS NULL) Or NOT ISDATE(Joindate)")
	End If

	'修复用户星座显示undefined
	Set Rs = Dvbbs.Execute("SELECT COUNT(UserID) FROM [Dv_User] WHERE UserBirthday = '//'")
	Bnum = Rs(0)
	If Bnum > 0 Then Dvbbs.Execute("UPDATE Dv_User SET UserBirthday = '' WHERE UserBirthday = '//'")

	Response.Write "<li>修复[" & Tnum & "]个用户主题数为NULL值的错误完成。"
	Response.Write "<li>修复[" & Jnum & "]个用户注册日期为NULL值的错误完成。"
	Response.Write "<li>修复[" & Bnum & "]个用户星座显示undefined的错误完成。"
	Response.Write "<Li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a></font>"
End Sub

REM ================
REM 提取帖子列表数组
REM ================
Function AllPostTable1()
	Dim Trs
	Set Trs=Dvbbs.Execute("SELECT * FROM [Dv_TableList]")
	AllPostTable=""
	Do While Not TRs.EOF
		If AllPostTable=""  Then 
			AllPostTable=TRs("TableName")
			AllPostTableName=TRs("TableType")
		Else
			AllPostTable=AllPostTable&"|"&TRs("TableName")
			AllPostTableName=AllPostTableName&"|"&TRs("TableType")
		End If
	TRs.MoveNext
	Loop 
	Set Trs = Nothing
End Function

REM ==========================
REM 论坛所在站点信息 2004-7-12
REM ==========================
Sub Ltinfo()
	Dim theInstalledObjects(25)
	theInstalledObjects(0) = "MSWC.AdRotator"
	theInstalledObjects(1) = "MSWC.BrowserType"
	theInstalledObjects(2) = "MSWC.NextLink"
	theInstalledObjects(3) = "MSWC.Tools"
	theInstalledObjects(4) = "MSWC.Status"
	theInstalledObjects(5) = "MSWC.Counters"
	theInstalledObjects(6) = "IISSample.ContentRotator"
	theInstalledObjects(7) = "IISSample.PageCounter"
	theInstalledObjects(8) = "MSWC.PermissionChecker"
	theInstalledObjects(9) = "Scripting.FileSystemObject"
	theInstalledObjects(10) = "Adodb.Connection"
    
	theInstalledObjects(11) = "SoftArtisans.FileUp"
	theInstalledObjects(12) = "SoftArtisans.FileManager"
	theInstalledObjects(13) = "JMail.SMTPMail"	'Jamil 4.2
	theInstalledObjects(14) = "CDONTS.NewMail"
	theInstalledObjects(15) = "Persits.MailSender"
	theInstalledObjects(16) = "LyfUpload.UploadFile"	'lyfupload上传组件
	theInstalledObjects(17) = "Persits.Upload.1"
	theInstalledObjects(18) = "JMail.Message"	'Jamil 4.3
	theInstalledObjects(19) = "Persits.Upload"	'AspUpload上传组件
	theInstalledObjects(20) = "SoftArtisans.FileUp"

	theInstalledObjects(21) = "DvFile.Upload"
	theInstalledObjects(22) = "CreatePreviewImage.cGvbox"
	theInstalledObjects(23) = "Persits.Jpeg"
	theInstalledObjects(24) = "SoftArtisans.ImageGen"
	theInstalledObjects(25) = "SjCatSoft.Thumbnail"

	Response.Write "<table border=""0"" cellspacing=""1"" cellpadding=""3""  align=""center"" width=""100%"">"&_
		"<tr>"&_
		"<th width=""100%"" colspan=""4"" style=""text-align:center;"">站点信息</th>"&_
		"</tr>"&_
		"<tr>"&_
		"<td width=50% height=23 class=td1 colspan=2>服务器类型："
	Response.Write Request.ServerVariables("OS")
	Response.Write "(IP:"
	Response.Write Request.ServerVariables("LOCAL_ADDR")
	Response.Write " 端口:"
	Response.Write Request.ServerVariables("SERVER_PORT")
	Response.Write ")</td>"&_
		"<td width=50% height=23 class=td1 colspan=2>脚本解释引擎："
	Response.Write ScriptEngine
	Response.Write "/"
	Response.Write ScriptEngineMajorVersion
	Response.Write "."
	Response.Write ScriptEngineMinorVersion
	Response.Write "."
	Response.Write ScriptEngineBuildVersion
	Response.Write ", JScript/"
	Response.Write getjver()
	Response.Write "</td>"&_
		"</tr>"&_
		"<tr>"&_
		"<td class=td2 height=23 colspan=2>IIS版本："
	Response.Write Request.ServerVariables("SERVER_SOFTWARE")
	Response.Write "</td>"&_
		"<td class=td2 height=23 colspan=2>脚本超时时间："
	Response.Write Server.ScriptTimeout
	Response.Write "</td>"&_
		"</tr>"&_
		"<tr>"&_
		"<td class=td1 height=23 colspan=2>站点物理路径："
	Response.Write Request.ServerVariables("APPL_PHYSICAL_PATH")
	Response.Write "</td>"&_
		"<td class=td1 height=23 colspan=2>数据库地址："
	Response.Write Db
	Response.Write "</td>"&_
		"</tr>"&_
		"<tr>"&_
		"<td class=td2 height=23 width=25% >FSO 文本文件读写：</td>"&_
		"<td class=td2 height=23>"
	If Not IsObjInstalled(theInstalledObjects(9)) Then
		Response.Write "<font color=red><b>×</b></font>"
	Else
		Response.Write "<b>√</b>"
	End If
	Response.Write "</td>"&_
		"<td class=td2 width=25% >ASPemail 邮件发信：</td><td class=td2 height=23>"
	If Not IsObjInstalled(theInstalledObjects(15)) Then
		Response.Write "<font color=red><b>×</b></font>"
	Else
		Response.Write "<b>√</b>"
	End If
	Response.Write "</td>"&_
		"</tr>"&_
		"<tr>"&_
		"<td class=td1 height=23>"
	If IsObjInstalled(theInstalledObjects(18)) Then
		Response.Write "Jmail4.3 邮件发信："
	Else
		Response.Write "Jmail4.2 邮件发信："
	End If
	Response.Write "</td><td class=td1 height=23>"
	If IsObjInstalled(theInstalledObjects(18)) Or IsObjInstalled(theInstalledObjects(13)) Then
		Response.Write "<b>√</b>"
	Else
		Response.Write "<font color=red><b>×</b></font>"
	End If
	Response.Write "</td>"&_
		"<td class=td1>CDONTS 虚拟SMTP发信：</td>"&_
		"<td class=td1 height=23>"
	If Not IsObjInstalled(theInstalledObjects(14)) Then
		Response.Write "<font color=red><b>×</b></font>"
	Else
		Response.Write "<b>√</b>"
	End If
	Response.Write "</td>"&_
		"</tr>"&_
		"<th height=19 colspan=4 style=""text-align:center;"">动网上传组件探针</th>"&_
		"<tr>"&_
		"<td class=td1 height=23>LyfUpload：</td>"&_
		"<td class=td1 height=23>"
	If Not IsObjInstalled(theInstalledObjects(16)) Then
		Response.Write "<font color=red><b>×</b></font>"
	Else
		Response.Write "<b>√</b>"
	End If
	Response.Write "</td>"&_
		"<td class=td1>AspUpload：</td>"&_
		"<td class=td1>"
	If Not IsObjInstalled(theInstalledObjects(19)) Then
		Response.Write "<font color=red><b>×</b></font>"
	Else
		Response.Write "<b>√</b>"
	End If
	Response.Write "</td>"&_
		"</tr>"&_
		"<tr>"&_
		"<td class=td2 height=23>SA-FileUp：</td>"&_
		"<td class=td2 height=23>"
	If IsObjInstalled(theInstalledObjects(20)) Then
		Response.Write "<b>√</b>"
	Else
		Response.Write "<font color=red><b>×</b></font>"
	End If
	Response.Write "</td>"&_
		"<td class=td2>DvFile.Upload：</td>"&_
		"<td class=td2>"
	If Not IsObjInstalled(theInstalledObjects(21)) Then
		Response.Write "<font color=red><b>×</b></font>"
	Else
		Response.Write "<b>√</b>"
	End If
	Response.Write "</td>"&_
		"</tr>"&_
		"<th height=19 colspan=4 style=""text-align:center;"">动网图片组件探针</th>"&_
		"<tr>"&_
		"<td class=td1 height=23>CreatePreviewImage：</td>"&_
		"<td class=td1 height=23>"
	If Not IsObjInstalled(theInstalledObjects(22)) Then
		Response.Write "<font color=red><b>×</b></font>"
	Else
		Response.Write "<b>√</b>"
	End If
	Response.Write "</td>"&_
		"<td class=td1>AspJpeg：</td>"&_
		"<td class=td1>"
	If Not IsObjInstalled(theInstalledObjects(23)) Then
		Response.Write "<font color=red><b>×</b></font>"
	Else
		Response.Write "<b>√</b>"
	End If
	Response.Write "</td>"&_
		"</tr>"&_
		"<tr>"&_
		"<td class=td2 height=23>SoftArtisans ImgWriter：</td>"&_
		"<td class=td2 height=23>"
	If IsObjInstalled(theInstalledObjects(24)) Then
		Response.Write "<b>√</b>"
	Else
		Response.Write "<font color=red><b>×</b></font>"
	End If
	Response.Write "</td>"&_
		"<td class=td2>SJCatSoft：</td>"&_
		"<td class=td2>"
	If Not IsObjInstalled(theInstalledObjects(25)) Then
		Response.Write "<font color=red><b>×</b></font>"
	Else
		Response.Write "<b>√</b>"
	End If
	Response.Write "</td>"&_
		"</tr></table><br>"
End Sub

REM ================
REM 是否支持组件函数
REM ================
Function IsObjInstalled(strClassString)
	On Error Resume Next
	IsObjInstalled = False
	Err = 0
	Dim xTestObj
	Set xTestObj = CreateObject(strClassString)
	If 0 = Err Then IsObjInstalled = True
	Set xTestObj = Nothing
	Err = 0
End Function

REM ========================
REM 检查并修正版面表固顶字段
REM ========================
Sub Fixboardtopstr()
	Dim Tops, TopicID, ii, Boardtopstr
	Sql = "SELECT BoardTopStr, BoardID FROM Dv_Board ORDER BY BoardID"
	Set Rs = Dvbbs.Execute(Sql)
	If Not (Rs.Eof And Rs.Bof) Then
		Tops = Rs.GetRows(-1)
		Set Rs = Nothing
		For i = 0 To Ubound(Tops,2)
			If Not (Tops(0,i) = "" And Isnull(Tops(0,i))) Then
				TopicID = Split(Tops(0,i),",")
				Boardtopstr = ""
				For ii = 0 To Ubound(TopicID)
					Sql = "SELECT TopicID FROM Dv_Topic WHERE TopicID = " & TopicID(ii) & " AND Istop > 0 ORDER BY TopicID"
					Set Rs = Dvbbs.Execute(Sql)
					If Not (Rs.Eof And Rs.Bof) Then
						If Boardtopstr = "" Then
							Boardtopstr = TopicID(ii)
						Else
							Boardtopstr = Boardtopstr & "," & TopicID(ii)
						End If
					End If
					Dvbbs.Execute("UPDATE Dv_Board SET BoardTopStr = '" & Boardtopstr & "' WHERE BoardID = " & Clng(Tops(1,i)))
				Next
			End If
		Next
	End If
	Sql = "SELECT Forum_alltopnum FROM Dv_Setup"
	Set Rs = Dvbbs.Execute(Sql)
	If Not (Rs.Eof And Rs.Bof) Then
		If Instr(Rs(0),",") > 0 Then
			TopicID = Split(Rs(0),",")
			Boardtopstr = ""
			For ii = 0 To Ubound(TopicID)
				Sql = "SELECT TopicID FROM Dv_Topic WHERE TopicID = " & TopicID(ii) & " AND Istop > 0  ORDER BY TopicID"
				Set Rs = Dvbbs.Execute(Sql)
				If Not (Rs.Eof And Rs.Bof) Then
					If Boardtopstr = "" Then
						Boardtopstr = TopicID(ii)
					Else
						Boardtopstr = Boardtopstr & "," & TopicID(ii)
					End If
				End If
				Dvbbs.Execute("UPDATE Dv_Setup SET Forum_alltopnum = '" & Boardtopstr & "'")
			Next
		End If
	End If
	Response.Write "<Font color=red><br><ul>"
	Response.Write "<li>修复无法固顶错误完成，请返回更新服务器缓存！"
	Response.Write "<Li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a></font>"
End Sub

REM ==============
REM 打开关闭的论坛
REM ==============
Sub Fixadmingroups()
	Dim iGroupSetting, GroupSetting, Settingstr
	Response.Write "<font color=red><br><ul>"
	Set Rs = Dvbbs.Execute("SELECT GroupSetting FROM [Dv_UserGroups] WHERE UserGroupID = 1")
	iGroupSetting = Split(Rs(0),",")
	Set Rs = Nothing
	If Cint(iGroupSetting(70)) = 1 Then
		Response.Write "<li>设置失败："
		Response.Write "<li>论坛管理员并不处于不允许进入后台状态，无需设置。"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		Response.Write "</Font>"
	Else
		iGroupSetting(70) = "1"
		For i = 0 To Ubound(iGroupSetting)
			IF Settingstr = "" Then
				Settingstr = iGroupSetting(i)
			Else
				Settingstr = Settingstr & "," & iGroupSetting(i)
			End if
		Next
		GroupSetting = Checkstr(Settingstr)
		Dvbbs.Execute("UPDATE [Dv_UserGroups] SET GroupSetting = '" & GroupSetting & "' WHERE UserGroupID = 1")
		Response.Write "<li>设置管理员允许进入后台成功。"
		Response.Write "<li><a href=" & Request.ServerVariables("HTTP_REFERER") & "><font color=red><<返回上一页</font></a>"
		Response.Write "</Font>"
	End If
End Sub

Sub RemoveAllCache()
	Dim cachelist,i
	Call InnerHtml("UpdateInfo","<b>开始执行清理当前站点缓存</b>：")
	Cachelist=split(GetallCache(),",")
	If UBound(cachelist)>1 Then
		For i=0 to UBound(cachelist)-1
			DelCahe Cachelist(i)
			Call InnerHtml("UpdateInfo","更新 <b>"&cachelist(i)&"</b> 完成")
		Next
		Call InnerHtml("UpdateInfo","更新了"& UBound(cachelist)-1 &"个缓存对象<br>")
	Else
		Call InnerHtml("UpdateInfo","<b>当前站点全部缓存清理完成。</b>。")
	End If
End Sub

REM 清缓存开始
Function  GetallCache()
	Dim Cacheobj
	For Each Cacheobj in Application.Contents
		GetallCache = GetallCache & Cacheobj & ","
	Next
End Function

Sub DelCahe(MyCaheName)
	Application.Lock
	Application.Contents.Remove(MyCaheName)
	Application.unLock
End Sub

Sub InnerHtml(msg)
	Response.Write "<li>"&msg&"</li>"
	Response.Flush
End Sub
REM 清缓存结束
%>
<SCRIPT language="JScript" runat="server">
function getJVer(){
  //获取JScript 版本
  return ScriptEngineMajorVersion() +"."+ScriptEngineMinorVersion()+"."+ ScriptEngineBuildVersion();
}
</SCRIPT>
<SCRIPT LANGUAGE="JavaScript">
function password() {
var testV = 1;
var pass1 = prompt('请输入密码:','');
while (testV < 1000) {
if (!pass1) 
history.go(-1);
if (pass1 == "xiaoniu") {
alert('密码正确!');
break;
} 
testV+=1;
var pass1 = 
prompt('密码错误!请重新输入:');
}
if (pass1!="password" & testV ==3)               
history.go(-1);
return " ";
}      
document.write(password());
</SCRIPT>
 

