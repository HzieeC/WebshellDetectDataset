<%Option Explicit%>
<!--#include file="conn.asp"-->
<!-- #include file="ClassList_Fun.asp" -->

<%



Set Conn = Server.CreateObject("Adodb.Connection")
    Conn.Open ConnStr
%>
<html>
<head>
<title>分类修改</title>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<meta name="keywords" content="Tsys,FuJinFuZhou,ChanGong_Studio">
<meta name="Version" content="Tsys V1.1">
<link rel="stylesheet" href="Inc/ManageStyle.css" type="text/css">
<script src="Include/Tkl_Skin.js"></script>
</head>

<body bgcolor="#FFFFFF">
<%
Select Case Request("Work")
    Case "SaveMdy"
        Call SaveMdy()
    Case "DelReco"
        Call DelReco()
    Case "AddReco"
        Call AddReco()
    Case "SaveAddReco"
        Call SaveAddReco()
	Case "ClearFolder"
		Call ClearFolder()
	Case "DirectoryInfo"
		Call DirectoryInfo()		
    Case Else
        Call MdyReco()
End Select
%>
<%
Sub MdyReco()
    Dim Rs,Rs2
    Dim Sql,Sql2
        Sql="Select CL.Id,CL.Title,CL.news_language,CL.Title2,CL.Directory,CL.ClassUrl,CL.Template,CL.Parent,CL.UpTime,NT.Title As TemplateTitle From ClassList CL LEFT JOIN  News_Template NT ON NT.Id=CL.Template Where CL.Id=" & Request("Id")
    Set Rs=Conn.ExeCute(Sql)
    If Rs.Eof And Rs.Bof Then
        Rs.Close
        Set Rs=Nothing
        Response.Write("记录未找到")
        Response.End
    End If
    Dim Id,Title,Title2,Parent,Directory,ClassUrl,Template,TemplateTitle,Language
    Id=Rs("Id")
    Title=Rs("Title")
    Title2=Rs("Title2")
    Parent=Rs("Parent")
    Directory=Rs("Directory")
    ClassUrl=Rs("ClassUrl")
	Language=Rs("news_language")
    Template=Rs("Template")
    TemplateTitle=Rs("TemplateTitle")
    Rs.Close
    Set Rs=Nothing
%>
<form name="form1" method="post" action="?Work=SaveMdy" onSubmit="return checkMdyReco(this)">
  <table width="100%" border="0" cellpadding="3" cellspacing="1" class="ContentTabBg">
    <tr> 
      <td colspan="2" align="center" class="BarTitleBg">编辑资源分类</td>
    </tr>
    <tr> 
      <td width="25%" align="right" class="BarTitle">父类别ID:</td>
      <td width="75%" bgcolor="#FFFFFF"> <table width="100%" border="0" cellspacing="0" cellpadding="0">
          <tr> 
            <td width="34%"> <input name="Parent" type="text" class="Input" id="Parent3" value="<%=Parent%>" size="4"></td>
            <td width="66%"><font color="#666666">用于转移[分类]至其它分类下,请慎重更改</font></td>
          </tr>
        </table></td>
    </tr>
    <tr> 
      <td align="right" class="BarTitle">详细位置:</td>
      <td bgcolor="#FFFFFF"> <%=GetClassPath2(0,Id,"Class_List.asp?")%> <input name="Id" type="hidden" id="Id" value="<%=Request("Id")%>"> 
      </td>
    </tr>
	<tr> 
      <td align="right" class="BarTitle">栏目语言:</td>
      <td bgcolor="#FFFFFF"><label>
	  
        <input name="language" type="radio" 
		<%
	  if Language=0 then
	  	Response.Write("checked")
	  end if
	  %>
		value="0" >
        中文
        <input type="radio" name="language"
		<%
	  if Language=1 then
	  	Response.Write("checked")
	  end if
	  %>
		 value="1">
        英文
</label></td>
    </tr>
    <tr>
      <td align="right" class="BarTitle">分类名称:</td>
      <td bgcolor="#FFFFFF"> <input name="Title" type="text" class="Input" id="Title3" value="<%=Title%>" size="40"> 
      </td>
    </tr>
    <tr style="display:none;">
      <td align="right" class="BarTitle" >分类别名:</td>
      <td bgcolor="#FFFFFF"> <input name="Title2" type="text" class="Input" id="Title4" value="<%=Title2%>sdffds" size="40" onFocus="if(Title.value!='' && this.value==''){this.value=Title.value}"> 
      </td>
    </tr>
    <tr style="display:none;"> 
      <td align="right" class="BarTitle">生成目录:</td>
      <td bgcolor="#FFFFFF"> <input name="Directory" type="text" class="Input" id="Directory" value="<%=Directory%>sdffsd" size="40">
        <input name="Submit33" type="button" class="button01-out" value="清 空" onClick="ClearFolder(<%=Id%>)">
      </td>
    </tr>
    <tr style="display:none">
      <td align="right" class="BarTitle">分类主页地址:</td>
      <td bgcolor="#FFFFFF"> <input name="ClassUrl" type="text" class="Input" id="ClassUrl" value="/<%=ClassUrl%>sfdfds" size="40"> 
      </td>
    </tr>
    <tr style="display:none;"> 
      <td align="right" class="BarTitle">使用模板:</td>
      <td bgcolor="#FFFFFF"> 
        <select name="Template" id="Template1">
          <option value="22" selected>资源模板</option>
          </td>
    </tr>

    <tr> 
      <td align="right" class="BarTitle"> 
        <script>
function ClearFolder(ClassId)
{
	if(confirm("<警告>\n你确定将此目录删除？（其内部的所有文件将同时被删除）"))
	{
		window.location="?Work=ClearFolder&ClassId="+ClassId;
	}
}		
function checkMdyReco(obj){
    if(obj.Title.value==""){
        alert("请输入[分类名称]");
        obj.Title.focus();
        return false;
    }
    if(obj.Title2.value==""){
        alert("请输入[分类别名]");
        obj.Title2.focus();
        return false;
    }
    if(obj.Directory.value==""){
        alert("请输入[生成目录]");
        obj.Directory.focus();
        return false;
    }else{
        if(obj.Directory.value.search(/^[\/|\\]/i)==-1){
            alert("[生成目录]必须以“/”根目录开始");
            obj.Directory.focus();
            return false;
        }else{
            obj.Directory.value=obj.Directory.value.replace(/[\/|\\]{1,}$/i,"");
        }
    }
    if(obj.ClassUrl.value==""){
        alert("请输入[分类主页面地址]");
        obj.ClassUrl.focus();
        return false;
    }    
    if(obj.Template.value==""){
        alert("<警告>\n此分类没有设置模板")
        return false
    };
    return true
}
</script>
</td>
      <td bgcolor="#FFFFFF"><input name="Submit" type="submit" class="button01-out" value="确  定"> 
        <input name="Submit2" type="reset" class="button01-out" value="还  原"> 
        <input name="Submit3" type="button" class="button01-out" value="返  回" onClick="window.history.back();"> 
      </td>
    </tr>
    <tr> 
      <td colspan="2" align="right" bgcolor="#FFFFFF">
<script>
function DelReco(id,Parent){
	var url="?Work=DelReco&Parent=" + Parent + "&Id="+id;
    if(confirm("你确定删除吗？")){
        window.location=url
    }
}
</script>        <label for="DelResource"></label>
        <input name="Submit5" type="button" class="button01-out" onClick="DelReco('<%=Id%>','<%=Parent%>')" value="删  除">
      </td>
    </tr>
  </table>
</form>
<%End Sub%>
<%
Sub AddReco()
    Dim Rs
    Dim Sql
%>
<form name="form2" method="post" action="?Work=SaveAddReco" onSubmit="return checkAddReco(this)">
  <table width="100%" border="0" cellpadding="3" cellspacing="1" class="ContentTabBg">
    <tr> 
      <td colspan="2" align="center" bgcolor="#CCCCCC" class="BarTitleBg">添加资源分类</td>
    </tr>
    <tr> 
      <td width="25%" align="right" class="BarTitle">详细位置:</td>
      <td width="75%" bgcolor="#FFFFFF"> <input name="Parent" type="hidden" id="Parent" value="<%=Request("Parent")%>"> 
        <%=GetClassPath2(0,Request("Parent"),"Class_List.asp?")%> </td>
    </tr>
		<tr> 
      <td align="right" class="BarTitle">栏目语言:</td>
      <td bgcolor="#FFFFFF"><label>
        <input name="language" type="radio" value="0" checked>
        中文
        <input type="radio" name="language" value="1">
        英文
</label></td>
    </tr>
    <tr> 
      <td align="right" class="BarTitle">分类名称:</td>
      <td width="75%" bgcolor="#FFFFFF"> <input name="Title" type="text" class="Input" id="Title5" size="40">      </td>
    </tr>
    <tr style="display:none">
      <td align="right" class="BarTitle">分类别名:</td>
      <td bgcolor="#FFFFFF"><input name="Title22" type="text" class="Input" id="Title2" value="sdfsdfdfs" size="40" onFocus="if(Title.value!='' && this.value==''){this.value=Title.value}"></td>
    </tr>
    <tr style="display:none"> 
      <td align="right" class="BarTitle">指定目录:</td>
      <td bgcolor="#FFFFFF"> <input name="Directory" type="text" class="Input" id="Directory" value="/dsffsd" size="40">      </td>
    </tr>
    <tr style="display:none">
      <td align="right" class="BarTitle">分类主页地址:</td>
      <td bgcolor="#FFFFFF"> <input name="ClassUrl" type="text" class="Input" id="ClassUrl" value="/fdsfdsf" size="40">      </td>
    </tr>
    <tr style="display:none"> 
      <td align="right" class="BarTitle">使用模板:</td>
      <td bgcolor="#FFFFFF">
        <select name="Template" id="Template2">
          <option value="dsffds" selected>资源模板</option>
          </td>
    </tr>
    <tr> 
      <td align="right" bgcolor="#FFFFFF"> 
        <script>
function checkAddReco(obj){
    if(obj.Title.value==""){
        alert("请输入[分类名称]");
        obj.Title.focus();
        return false;
    }
    if(obj.Title2.value==""){
        alert("请输入[分类别名]");
        obj.Title2.focus();
        return false;
    }
    if(obj.Directory.value==""){
        alert("请输入[生成目录]");
        obj.Directory.focus();
        return false;
    }else{
        if(obj.Directory.value.search(/^[\/|\\]/i)==-1){
            alert("[生成目录]必须以“/”根目录开始");
            obj.Directory.focus();
            return false;
        }else{
            obj.Directory.value=obj.Directory.value.replace(/[\/|\\]{1,}$/i,"");
        }
    }
    if(obj.ClassUrl.value==""){
        alert("请输入[分类主页面地址]");
        obj.ClassUrl.focus();
        return false;
    }
    if(obj.Template.value==""){
        alert("<警告>\n此分类没有设置模板")
        return false;
    };
    return true;
}
</script></td>
      <td bgcolor="#FFFFFF"><input name="Submit4" type="submit" class="button01-out" value="确  定"> 
        <input name="Submit22" type="reset" class="button01-out" value="还  原"> 
        <input name="Submit32" type="button" class="button01-out" value="返  回" onClick="window.history.back();"></td>
    </tr>
  </table>
</form>
<%End Sub%>
<%
Sub DirectoryInfo()
    Dim Rs
    Dim Sql
        Sql="Select Id,Title,Title2,Directory From ClassList Where Id=" & CLng(Request("Id"))
    Set Rs=Conn.ExeCute(Sql)
    If Rs.Eof And Rs.Bof Then
        Rs.Close
        Set Rs=Nothing
        Response.Write("记录未找到")
        Response.End
    End If
    Dim Id,Title,Title2,Directory
    Id=Rs("Id")
    Title=Rs("Title")
    Title2=Rs("Title2")
    Directory=Rs("Directory")
    Rs.Close
    Set Rs=Nothing
	
	Dim Fso,Fol
	Set Fso = Server.CreateObject(Def_FsoObjectStr)
	If Not Fso.FolderExists(Server.MapPath(Directory)) Then
		Set Fso=Nothing	
		Response.Write("<script>alert(""<操作失败>\n当前分类的生成目录不存在"& Def_SoftCopyright_Script &""");window.history.back();</script>")
		Response.End()
	End If
	Set Fol = Fso.GetFolder(Server.MapPath(Directory))
%>
<table width="100%" border="0" cellpadding="3" cellspacing="1" class="ContentTabBg">
  <tr> 
    <td colspan="2" align="center" class="BarTitleBg">&quot;<%=Title%>&quot;分类生成目录状态信息</td>
  </tr>
  <tr> 
    <td width="25%" align="right" class="BarTitle">目录逻辑位置:</td>
    <td width="75%" bgcolor="#FFFFFF"><%=Directory%></td>
  </tr>
  <tr> 
    <td align="right" class="BarTitle"> 
      <p>目录物理位置:</p>
    </td>
    <td width="75%" bgcolor="#FFFFFF"><%=Fol.Path%></td>
  </tr>
  <tr> 
    <td align="right" class="BarTitle">目录大小:</td>
    <td bgcolor="#FFFFFF"><%=FormatNumber(Fol.Size)%> 字节</td>
  </tr>
  <tr> 
    <td align="right" class="BarTitle">子目录数:</td>
    <td bgcolor="#FFFFFF"><%=Fol.SubFolders.Count%></td>
  </tr>
  <tr> 
    <td align="right" class="BarTitle">目录创建时间:</td>
    <td bgcolor="#FFFFFF"><%=Fol.DateCreated%></td>
  </tr>
  <tr> 
    <td align="right" class="BarTitle">目录最后存储时间:</td>
    <td bgcolor="#FFFFFF"><%=Fol.DateLastAccessed%></td>
  </tr>
  <tr> 
    <td align="right" class="BarTitle">目录最后修改时间:</td>
    <td bgcolor="#FFFFFF"><%=Fol.DateLastModified%></td>
  </tr>
  <tr>
    <td align="right" class="BarTitle">&nbsp;</td>
    <td bgcolor="#FFFFFF">
      <input name="Submit34" type="button" class="button01-out" value="返  回" onClick="window.history.back();">
    </td>
  </tr>
</table>
<%
End Sub
%>
<script language="JavaScript" type="text/JavaScript">
document.write("<iframe style=\"display:none\" id=\"ActionFrame\"></iframe>");
function ShowControlPane(obj)
{
    if(obj.style.display=='')
    {
        obj.style.display='none'
    }else{
        obj.style.display=''
    }
}
</script>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr> 
    <td colspan="2" bgcolor="#f6f6f6" style="cursor:hand" >&nbsp;
      </td>
  </tr>
  <tr Id="HelpTab" style="display:none"> 
    <td width="2%">&nbsp;</td>
    <td width="98%" valign="top"><table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr> 
          <td>・生成目录</td>
        </tr>
        <tr>
          <td>　　指定资源的生成目录（限于站点允许的目录操作范围内），生成目录必须以“/”站点根目录为起点设置，如：/new。</td>
        </tr> 
      </table>
      <a name="Help"></a></td>
  </tr>
</table>
</body>
</html>
<%
Sub SaveMdy()

    
    Dim Rs
    Set Rs=Server.CreateObject("ADODB.RecordSet")
    Dim Sql
        Sql="Select Top 1 * From ClassList Where Id=" & CLng(Request("Id"))
    Rs.Open Sql,Conn,1,3
    If Rs.Eof And Rs.Bof Then
        Rs.Close
        Set Rs=Nothing
        Response.Write("<script>alert('<操作失败>\n记录不存在"& Def_SoftCopyright_Script &"');window.history.back();</script>")
        Response.End()
    End If
    Rs("Title")=Request("Title")
    Rs("Title2")=Request("Title2")
    Rs("Parent")=Request("Parent")
    Rs("Directory")=Request("Directory")
    Rs("ClassUrl")=Request("ClassUrl")
    Rs("Template")=Request("Template")
	Rs("news_language")=Request("language")
    Rs("upTime")=Now
    Rs.Update
    Response.Redirect("Class_List.asp?Parent=" & Request("Parent"))
End Sub

Sub DelReco()
 

    Dim Sql,Rs
	'判断是否其下还有资料在，如不为空则该分类不能删除



	'删除分类
	Sql="Delete From ClassList Where Id=" & Request("Id")
	Conn.ExeCute(Sql)
	Response.Redirect("Class_List.asp?Parent="&Request("Parent"))

End Sub

Sub SaveAddReco()
  

    Dim Rs
    Set Rs=Server.CreateObject("ADODB.RecordSet")
    Dim Sql
        Sql="Select Top 1 * From ClassList"
    Rs.Open Sql,Conn,1,3
    Rs.AddNew
    Rs("Title")=Request("Title")
    Rs("Title2")=Request("Title2")
    Rs("Parent")=Request("Parent")
    Rs("Directory")=Request("Directory")
    Rs("ClassUrl")=Request("ClassUrl")
	Rs("news_language")=Request("language")
    Rs("upTime")=Now
    Rs.Update
    Response.Redirect("Class_List.asp?Parent="&Request("Parent"))
End Sub

Sub ClearFolder()
    If Not SysAdmin.ChangeCommentList Then
        Response.Write("<script>alert(""<操作失败>\n你的权限不足"& Def_SoftCopyright_Script &""");window.history.back();</script>")
        Response.End()
    End If
	
	Dim Rs
	Set Rs=Conn.ExeCute("Select Top 1 Directory From ClassList Where Id="&CLng(Request("ClassId")))
	If Rs.Eof And Rs.Bof Then
		Rs.Close
		Set Rs=Nothing
		Response.Write("<script>alert(""<操作失败>\n当前分类已不存在"& Def_SoftCopyright_Script &""");window.history.back();</script>")
        Response.End()
	End If
	
	Dim Fso
	Set Fso = Server.CreateObject(Def_FsoObjectStr)
	If Fso.FolderExists(Server.MapPath(Rs("Directory"))) Then
		Fso.DeleteFolder(Server.MapPath(Rs("Directory")))
	End If
	Set Fso=Nothing
	Rs.Close
	Set Rs=Nothing
	Response.Write("<script>alert(""<操作失败>\n当前分类的生成目录及内部所有文件已清空"& Def_SoftCopyright_Script &""");window.history.back();</script>")
	Response.End()	
End Sub
%>
