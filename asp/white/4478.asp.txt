<!--#include file="conn_xp/xp.asp"-->
<!--#include file="conn_xp/shopxp.asp"-->
<!--#include file="Alipay/myAlipay.asp"-->
<!--#include file="xpli.asp"-->
<%
if request.Cookies("shopxp")("username")<>"" then
username=trim(request.Cookies("shopxp")("username"))
else
username=request.Cookies("shopxp")("dingdanusername")
end if%>
<html><head><title><%=webname%>--我要下订单</title>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<link href="img_shopxp/css.css" rel="stylesheet" type="text/css">
<style type="text/css">
<!--
.style1 {font-size: 13pt}
.style2 {font-weight: bold}
.style4 {font-weight: bold; font-size: 13px; }
.style5 {font-size: 13px}
.STYLE6 {
	font-size: 14pt;
	font-weight: bold;
}
-->
</style> 
</head> 
<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">
<!--#include file="xptop.asp"-->
<table width="985"  border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td><img src="img_shopxp/xiao/basketimagenew.gif" width="100%" height="180"></td>
  </tr>
</table>
<table width="985"  border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td><TABLE cellSpacing=0 cellPadding=0 width=100% align=center border=0>
      <TBODY>
        <TR>
          <td width="251" valign="top"><table width="92%" height="3"  border="0" cellpadding="0" cellspacing="0">
            <tr>
              <td></td>
            </tr>
          </table>
            <TABLE width=239 border=0 align="center" cellPadding=0 cellSpacing=0>
                <TBODY>
                  <TR>
                    <TD width="239"><img 
                src="img_shopxp/xiao/rbox_top_01.gif"></TD>
                  </TR>
                  <TR>
                    <TD><img src="img_shopxp/xiao/buyhelp.gif" width="239" height="43"></TD>
                  </TR>
                  <TR>
                    <TD vAlign=top align=middle 
                background="img_shopxp/xiao/bg_rbox_04.gif" 
                height=170>
                      <TABLE cellSpacing=0 cellPadding=0 width=206 border=0>
                        <TBODY>
                         <TR>
                            <TD height=21><a href="xpa.asp"><img src="img_shopxp/xiao/company_mn01.gif" border="0"></a></TD>
                          </TR>
                          <TR>
                            <TD bgColor=#e3e3e3 height=1></TD>
                          </TR>
                       <TR>
                            <TD bgColor=#cae8eb height=1></TD>
                          </TR>
                          <TR>
                            <TD 
                      style="PADDING-RIGHT: 0px; PADDING-LEFT: 22px; PADDING-BOTTOM: 5px; PADDING-TOP: 5px" 
                      bgColor=#eff8fd height=21><a href="shopxphelp.asp?action=qiyexingxiang">企业形象</a><br>
                                <a href="shopxphelp.asp?action=gongzuoshijian">工作时间</a><br>
                                <a href="xpa.asp?action=lxwm">联系我们</a> <br>
                            <a href="shopxphelp.asp?action=shiyongfalv">法律声明</a> </TD>
                          </TR>
                          <TR>
                            <TD bgColor=#cae8eb height=1></TD>
                          </TR>
                          <TR>
                            <TD height=21><img 
                        src="img_shopxp/xiao/company_mn03.gif"></TD>
                          </TR>
                          <TR>
                            <TD bgColor=#cae8eb height=1></TD>
                          </TR>
                          <TR>
                            <TD 
                      style="PADDING-RIGHT: 0px; PADDING-LEFT: 22px; PADDING-BOTTOM: 5px; PADDING-TOP: 5px" 
                      bgColor=#eff8fd height=21>1.<a href="shopxphelp.asp?action=gouwuliucheng">如何购买</a><br>
                      2.<a href="shopxphelp.asp?action=feiyong">送货方式</a><br>
                      3.<a href="shopxphelp.asp?action=fukuan">付款方式</a><br>
                      4.<a href="shopxphelp.asp?action=tiaokuan">交易条款</a></TD>
                          </TR>
                          <TR>
                            <TD bgColor=#cae8eb height=1></TD>
                          </TR>
                          <TR>
                            <TD height=21><a href="shopxphelp.asp?action=shouhoufuwu"><img 
                        src="img_shopxp/xiao/company_mn04.gif" border="0"></a></TD>
                          </TR>
                          <TR>
                            <TD bgColor=#e3e3e3 height=1></TD>
                          </TR>
                          <TR>
                            <TD height=21><img 
                        src="img_shopxp/xiao/company_mn05.gif"></TD>
                          </TR>
                          <TR>
                            <TD bgColor=#cae8eb height=1></TD>
                          </TR>
                          <TR>
                            <TD 
                      style="PADDING-RIGHT: 0px; PADDING-LEFT: 22px; PADDING-BOTTOM: 5px; PADDING-TOP: 5px" 
                      bgColor=#eff8fd height=21><a href="shopxphelp.asp?action=yunshushuoming">1.运输说明</a><br>
                                <a href="shopxphelp.asp?action=baomi">2.保密安全</a></TD>
                          </TR>
                          <TR>
                            <TD bgColor=#cae8eb height=1></TD>
                          </TR>
                          <TR>
                            <TD height=21><img 
                        src="img_shopxp/xiao/company_mn08.gif"></TD>
                          </TR>
                          <TR>
                            <TD bgColor=#cae8eb height=1></TD>
                          </TR>
                          <TR>
                            <TD 
                      style="PADDING-RIGHT: 0px; PADDING-LEFT: 22px; PADDING-BOTTOM: 5px; PADDING-TOP: 5px" 
                      bgColor=#eff8fd height=21><a href="shopxphelp.asp?action=jifen">1.积分奖励</a><br>
                                <a href="shopxphelp.asp?action=vip">2.VIP优惠</a></TD>
                          </TR>
                          <TR>
                            <TD bgColor=#cae8eb height=1></TD>
                          </TR>
                          <TR>
                            <TD height=21><a href="shopxphelp.asp?action=changjianwenti"><img 
                        src="img_shopxp/xiao/company_mn06.gif" border="0"></a></TD>
                          </TR>
                          <TR>
                            <TD bgColor=#e3e3e3 height=1></TD>
                          </TR>
                          <TR>
                            <TD height=21><a href="fankuixpliuyan.asp"><img 
                        src="img_shopxp/xiao/company_mn07.gif" border="0"></a></TD>
                          </TR>
                          <TR>
                            <TD bgColor=#e3e3e3 height=1></TD>
                          </TR>
                          <TR>
                            <TD height=15></TD>
                          </TR>
                        </TBODY>
                    </TABLE></TD>
                  </TR>
                  <TR>
                    <TD><img 
                  src="img_shopxp/xiao/rbox_bottom_04.gif" width="239" height="10"></TD>
                  </TR>
                  <TR>
                    <TD height=7></TD>
                  </TR>
                </TBODY>
            </TABLE></td>
          <TD class=b vAlign=top align=left ><%dim shopxpptid,action,i
action=request("action")
set rs=server.CreateObject("adodb.recordset")
rs.open "select count(*) as rec_count from shopxp_action where username='"&username&"' and zhuangtai=7",conn,1,1
if rs("rec_count")=0 then
response.write "<script language=javascript>alert('对不起，您购物车没有商品，请在购物后，再去“结算中心”！');window.close();</script>"
response.End
end if
rs.close
set rs=nothing
//////////////////////////////////
select case action
case ""

set rs=server.CreateObject("adodb.recordset")
rs.open "select shopxp_action.shopxpacid,shopxp_action.shopxpptid,shopxp_action.productcount,shopxp_action.zonger,shopxp_product.shopxpptname,shopxp_action.shjiaid,shopxp_product.shichangjia,shopxp_product.shopxphyjia,shopxp_product.shopxpvjia from shopxp_product inner join shopxp_action on shopxp_product.shopxpptid=shopxp_action.shopxpptid where shopxp_action.username='"&username&"' and shopxp_action.zhuangtai=7",conn,1,1
'------------------------------ ----------------------------------------
'文件属性：例如上传文件为c:\myfile\doc.txt
'FileName    文件名       字符串    "doc.txt"
'FileSize    文件大小     数值       1210
'FileType    文件类型     字符串    "text/plain"
'FileExt     文件扩展名   字符串    "txt"
'FilePath    文件原路径   字符串    "c:\myfile"
'使用时注意事项:
'由于Scripting.Dictionary区分大小写,所以在网页及ASP页的项目名都要相同的大小
'写,如果人习惯用大写或小写,为了防止出错的话,可以把
'sFormName = Mid (sinfo,iFindStart,iFindEnd-iFindStart)
'改为
'(小写者)sFormName = LCase(Mid (sinfo,iFindStart,iFindEnd-iFindStart))
'(大写者)sFormName = UCase(Mid (sinfo,iFindStart,iFindEnd-iFindStart))
'**********************************************************************
'----------------------------------------------------------------------
%>
              <table width="100%" height="37" border="0" align="center" cellpadding="0" cellspacing="0">
                <tr>
                  <td height=35 valign="bottom"><span class="style1"><span class="style4"><a href=index.asp><%=webname%></a> >>下定单</span></span></td>
                </tr>
              </table>
              <table width="100%" align="center" border="0" cellspacing="0" cellpadding="0">
                <tr>
                  <td bgColor=#ffffff colSpan=5 height=1></TD>
                </tr>
                <form name='form1' method='post' action=jsactionshopxp.asp?action=shop1>
                  <tr align="center">
                    <td width=25% height="40" background="img_shopxp/xiao/200309baskettitlebar.gif">商品名称 </td>
                    <td width=15% background="img_shopxp/xiao/200309baskettitlebar.gif">市场价</td>
                    <td width=15% background="img_shopxp/xiao/200309baskettitlebar.gif">单价
                        <%if request.Cookies("shopxp")("reglx")=2 then %>
                (VIP)
                <%else%>
                (会员)
                <%end if%></td>
                    <td width=15% background="img_shopxp/xiao/200309baskettitlebar.gif">数量</td>
                    <td width=10% background="img_shopxp/xiao/200309baskettitlebar.gif">总价</td>
                  </tr>

                  <tr>
                    <td bgColor=#cccccc colSpan=5 height=1></TD>
                  </tr>
                  <tr>
                    <td bgColor=#f1f1f1 colSpan=5 height=3></TD>
                  </tr>
                  <%shuliang=rs.recordcount
jianshu=0
zongji=0
do while not rs.eof%>
                  <tr bgcolor="#ffffff">
                    <td height="30" width="25%" class="table-xia"><%=rs("shopxpptname")%>
                        <input name=shopxpptid type=hidden value="<%=rs("shopxpptid")%>">
                        <input name=shopxpacid type=hidden value="<%=rs("shopxpacid")%>">
                    </td>
                    <td align="center" class="table-xia"><%=rs("shichangjia")%></td>
                    <td align="center" class="table-xia"><%
	if request.Cookies("shopxp")("reglx")=2 then 
	response.write rs("shopxpvjia")
	else
	response.write rs("shopxphyjia")
	end if%>
                元</td>
                    <td align="center" class="table-xia"><%=rs("productcount")%></td>
                    <td align="center" class="table-xia"><%=rs("zonger")%> 元</td>
                  </tr>
                  <%
jianshu=jianshu+rs("productcount")
zongji=zongji+rs("zonger")
rs.movenext
loop
rs.close
set rs=nothing%>
                  <tr bgcolor=#ffffff align=center>
                    <td height=30 colspan=5> 您的购物车里有商品：<%=shuliang%> 件　总数量：<%=jianshu%> 件　共计：<font color=red><%=zongji%></font> 元　您有预存款：<%=request.Cookies("shopxp")("yucun")%> 元 </td>
                  </tr>
                  <tr bgcolor=#ffffff align=center>
                    <td height=40 colspan=5><input class="go-wenbenkuang" type="button" name="Submit" value="修改购物车" onClick="this.form.action='xpbuy.asp?action=show';this.form.submit()">
                        <input class="go-wenbenkuang" type="submit" name="Submit3" value="OK,下一步">
                    </td>
                  </tr>
                  <%set Godbook=server.CreateObject("adodb.recordset")
	Godbook.open "select * from shopxp_action_jp where username='"&username&"' and zhuangtai=7",conn,1,1
	if Godbook.recordcount>0 then%>
                  <tr bgcolor="#ffffff">
                    <td colspan=5><table width="100%" border="0" cellspacing="1" cellpadding="1" bgcolor="#cccccc" align="center">
                        <tr bgcolor="#ffffff">
                          <td colspan="2" align="center" height="30">您已选择的奖品清单</td>
                        </tr>
                        <tr bgcolor="#cccccc" align="center">
                          <td height="30"><b><font color="#ffffff">奖品名称</font></b></td>
                          <td height="30"><b><font color="#ffffff">使用积分</font></b></td>
                        </tr>
                        <%while not Godbook.eof%>
                        <tr bgcolor="#ffffff">
                          <td><%
	set Godbook1=server.CreateObject("adodb.recordset")
	Godbook1.open "select * from shopxp_jiangpin where shopxpptid="&Godbook("shopxpptid"),conn,1,1
	if Godbook1.recordcount=1 then
	response.write "<font color=blue>"&Godbook1("shopxpptname")&"</font>"
	end if
	Godbook1.close
	set Godbook1=nothing%>
                          </td>
                          <td align="center"><%=Godbook("jifen")%></td>
                        </tr>
                        <%Godbook.movenext
wend%>
                    </table></td>
                  </tr>
                  <%end if
Godbook.close
set Godbook=nothing%>
                </form>
              </table>
              <%
/////////////////////////////////////////
case "shop1"
set rs=server.CreateObject("adodb.recordset")
rs.open "select * from [Dv_User] where username='"&username&"'",conn,1,1
userid=rs("userid")
%>
              <table width="100%" align="center" border="0" cellspacing="0" cellpadding="0">
                <tr>
                  <td height=33>　<span class="style4"><a href=index.asp><%=webname%></a> >> 填写收货信息</span></td>
                </tr>
              </table>
              <table width="660" align="center" border="0" cellspacing="0" cellpadding="0">
               <tr>
                  <td height="35" colspan="2" align="center"><table width="100%" height="39"  border="0" align="center" cellpadding="0" cellspacing="0" background="img_shopxp/xiao/200309baskettitlebar.gif">
                    <tr>
                      <td height="39"><div align="center">请正确填写以下收货信息</div></td>
                    </tr>
                  </table></td>
                </tr>
                  <form name="shouhuoxx" method="post" action="jsactionshopxp.asp?action=shop2" onSubmit="ssxx">
                  <tr bgcolor="#ffffff">
                    <td width="30%" height="30" align="right" class="table-xia">收货人真实姓名：</td>
                    <td width="70%" height="30" style="PADDING-LEFT: 20px" class="table-xia"><input name=userid type=hidden value="<%=userid%>">
                        <input name="shopxp_shiname" class="wenbenkuang" type="text" id="shopxp_shiname" size="16" value=<%=trim(rs("shopxp_shiname"))%>>
                性别：
                <select class="wenbenkuang" name="shousex" id="shousex">
                  <option value=1 <%if rs("sex")="1" then%>selected<%end if%>>男</option>
                  <option value=2 <%if rs("sex")="0" then%>selected<%end if%>>女</option>
                  <option value=0 <%if rs("sex")="2" then%>selected<%end if%>>保密</option>
                </select>
                    </td>
                  </tr>
                  <tr bgcolor="#ffffff">
                    <td width="30%" height="30" align="right" class="table-xia">详细地址：</td>
                    <td width="70%" height="30" style="PADDING-LEFT: 20px" class="table-xia"><input class="wenbenkuang" name="shopxp_shdz" type="text" id="shopxp_shdz" size="50" value=<%=trim(rs("shopxp_shdz"))%>>
                    </td>
                  </tr>
                  <tr bgcolor="#ffffff">
                    <td width="30%" height="30" align="right" class="table-xia">邮政编码：</td>
                    <td width="70%" height="30" style="PADDING-LEFT: 20px" class="table-xia"><input class="wenbenkuang" name="youbian" type="text" id="youbian" size="16" value="<%=rs("youbian")%>" ONKEYPRESS="event.returnValue=IsDigit();"></td>
                  </tr>
                  <tr bgcolor="#ffffff">
                    <td width="30%" height="30" align="right" class="table-xia">联系电话：</td>
                    <td width="70%" height="30" style="PADDING-LEFT: 20px" class="table-xia"><input class="wenbenkuang" name="usertel" type="text" id="usertel" size="16" value=<%=trim(rs("usertel"))%>>
                    </td>
                  </tr>
                  <tr bgcolor="#ffffff">
                    <td width="30%" height="30" align="right" class="table-xia">电子邮件：</td>
                    <td width="70%" height="30" style="PADDING-LEFT: 20px" class="table-xia"><input class="wenbenkuang" name="useremail" type="text" id="useremail" size="30" value=<%=trim(rs("useremail"))%>>
                    </td>
                  </tr>
                  <tr bgcolor="#ffffff">
                    <td width="30%" height="30" align="right" class="table-xia">送货方式：</td>
                    <td width="70%" height="30" style="PADDING-LEFT: 20px" class="table-xia"><%
          set rs2=server.CreateObject("adodb.recordset")
          rs2.Open "select * from shopxp_youbian where youbian='"&trim(request("youbian"))&"'",conn,1,1
          if rs2.recordcount=1 then
          shangmen=1
          else
          shangmen=0
          end if
          rs2.close
          set rs2=nothing
          '//////////判断送货方式
          set rs3=server.CreateObject("adodb.recordset")
          rs3.Open "select * from shopxp_songhuo where fangshi=0 order by songidorder",conn,1,1
          response.Write "<select name=shopxp_shfs size=5 style='width:180px'>"
          do while not rs3.EOF
          if not(shangmen=3 and trim(rs3("songid"))=3) then          '显示不显示“送货上门”
          	response.Write "<option value="&rs3("songid")
          	if int(rs("shopxp_shfs"))=int(rs3("songid")) then 
          	response.Write " selected>"
          	else
          	response.Write ">"
          	end if 
			response.Write trim(rs3("subject"))&" ["  
			response.Write trim(rs3("jsmoney"))&"元] </option>"        
			end if
			rs3.MoveNext
			loop
			response.Write "</select>"
			rs3.Close
			set rs3=nothing
			%>
                    </td>
                  </tr>
                  <tr bgcolor="#ffffff">
                    <td width="30%" height="30" align="right" class="table-xia">支付方式：</td>
                    <td width="70%" height="30" style="PADDING-LEFT: 20px" class="table-xia"><%
		'set rs2=server.CreateObject("adodb.recordset")
          'rs2.Open "select * from shopxp_songhuo where songid="&trim(request("shopxp_shfs")),conn,1,1
          if cint(request("shopxp_shfs"))=3 then
          fukuan=1
          else
          fukuan=0
          end if
          'rs2.close
          'set rs2=nothing
          '//////////判断支付方式
          set rs3=server.CreateObject("adodb.recordset")
          rs3.open "select * from shopxp_songhuo where fangshi=1 order by songidorder",conn,1,1
          response.Write "<select name=zhifufangshi size=5 style='width:180px'>"
          do while not rs3.eof
          if not(fukuan=4 and trim(rs3("songid"))=4) then	'显示不显示“货到付款”
          	response.Write "<option value="&rs3("songid")
          	if int(rs("zhifufangshi"))=int(rs3("songid")) then
          	response.Write " selected>"
          	else
          	response.Write ">"
          	end if
          	response.Write trim(rs3("subject"))&"</option>"
          end if
          rs3.movenext
          loop
          response.Write "</select>"
          rs3.close
          set rs3=nothing
		  %>
                    </td>
                  </tr>
                  <tr bgcolor="#ffffff">
                    <td height="40" colspan="2" align=center><input class="go-wenbenkuang" type="button" name="Submit2" value="上一步" onClick="javascript:history.go(-1)">
                        <input class="go-wenbenkuang" type="submit" name="Submit4" value="OK,下一步" onclick='return ssxx();'>
                    </td>
                  </tr>
                </form>
              </table>
              <SCRIPT LANGUAGE="JavaScript">
<!--
function IsDigit()
{
  return ((event.keyCode >= 48) && (event.keyCode <= 57));
}
function checkspace(checkstr) {
  var str = '';
  for(i = 0; i < checkstr.length; i++) {
    str = str + ' ';
  }
  return (str == checkstr);
}

function ssxx()
{
   if(checkspace(document.shouhuoxx.shopxp_shiname.value)) {
	document.shouhuoxx.shopxp_shiname.focus();
    alert("对不起，请填写收货人姓名！");
	return false;
  }
  if(checkspace(document.shouhuoxx.shopxp_shdz.value)) {
	document.shouhuoxx.shopxp_shdz.focus();
    alert("对不起，请填写收货人详细收货地址！");
	return false;
  }
  if(checkspace(document.shouhuoxx.youbian.value)) {
	document.shouhuoxx.youbian.focus();
    alert("对不起，请填写邮编！");
	return false;
  }
  if(document.shouhuoxx.youbian.value.length!=6) {
	document.shouhuoxx.youbian.focus();
    alert("对不起，请正确填写邮编！");
	return false;
  } 
    if(checkspace(document.shouhuoxx.usertel.value)) {
	document.shouhuoxx.usertel.focus();
    alert("对不起，请留下您的电话！");
	return false;
  }
    if(checkspace(document.shouhuoxx.shopxp_shfs.value)) {
	document.shouhuoxx.shopxp_shfs.focus();
    alert("对不起，请选择送货方式！");
	return false;
  }
  if(document.shouhuoxx.useremail.value.length!=0)
  {
    if (document.shouhuoxx.useremail.value.charAt(0)=="." ||        
         document.shouhuoxx.useremail.value.charAt(0)=="@"||       
         document.shouhuoxx.useremail.value.indexOf('@', 0) == -1 || 
         document.shouhuoxx.useremail.value.indexOf('.', 0) == -1 || 
         document.shouhuoxx.useremail.value.lastIndexOf("@")==document.shouhuoxx.useremail.value.length-1 || 
         document.shouhuoxx.useremail.value.lastIndexOf(".")==document.shouhuoxx.useremail.value.length-1)
     {
      alert("Email地址格式不正确！");
      document.shouhuoxx.useremail.focus();
      return false;
      }
   }
 else
  {
   alert("Email不能为空！");
   document.shouhuoxx.useremail.focus();
   return false;
   }
   
}
//-->
        </script>
              <%
rs.close
set rs=nothing
'/////////////////////////////////////////
case "shop2"
%>
              <table width="100%" height="45" border="0" align="center" cellpadding="0" cellspacing="0">
                <tr>
                  <td height=33 valign="bottom">　<span class="style5"><strong><a href=index.asp><%=webname%></a> >> 提交定单</strong></span></td>
                </tr>
              </table>
              <table width="660" align="center" border="0" cellspacing="0" cellpadding="0">
                <tr>
                  <td bgColor=#ffffff height=1></TD>
                </tr>
                <tr bgcolor="#ffffff">
                  <td height="40" align="center" background="img_shopxp/xiao/200309baskettitlebar.gif">请正确填写定单以便收货 </td>
                </tr>
                <tr>
                  <td bgColor=#cccccc height=1></TD>
                </tr>
                <tr>
                  <td height=11></TD>
                </tr>
                <tr>
                  <td><table width="660" border="0" align="center" cellpadding="0" cellspacing="0">
                      <tr bgcolor="#ffffff">
                        <td align="center" valign="top" height=50 colspan=2><%set rs=server.CreateObject("adodb.recordset")
rs.open "select shopxp_action.shopxpacid,shopxp_action.shopxpptid,shopxp_action.productcount,shopxp_action.zonger,shopxp_product.shopxpptname,shopxp_action.shjiaid,shopxp_product.shopxpbe_id,shopxp_product.banci,shopxp_product.shichangjia,shopxp_product.shopxphyjia,shopxp_product.shopxpvjia from shopxp_product inner join  shopxp_action on shopxp_product.shopxpptid=shopxp_action.shopxpptid where shopxp_action.username='"&username&"' and shopxp_action.zhuangtai=7 order by shopxp_product.shjiaid",conn,1,1 
%>
                            <br>
                            <table width=95% border=0 align=center cellpadding=2 cellspacing=1 bgcolor=#cccccc>
                              <tr align=center bgcolor=#f1f1f1>
                                <td width=25%>商品名称</td>
                                <td width=10%>市 场 价</td>
                                <td width=15%>单 价
                                    <%if request.Cookies("shopxp")("reglx")=2 then %>
                          (VIP)
                          <%else%>
                          (会员)
                          <%end if%>
                                </td>
                                <td width=10%>数 量</td>
                               <td width=15%>总 价</td>
                              </tr>

                              <%shuliang=rs.recordcount
jianshu=0
zongji=0
fudongjia=0
do while not rs.eof
%>
                              <tr align="center" bgcolor=#ffffff>
                                <td height="30" align="left"><%=rs("shopxpptname")%>
                                    <input name=bookid2 type=hidden value="<%=rs("shopxpptid")%>">
                                    <input name=shopxpacid2 type=hidden value="<%=rs("shopxpacid")%>">
                                </td>
                                <td><s><%=rs("shichangjia")%></s>元</td>
                                <td><%
	if request.Cookies("shopxp")("reglx")=2 then 
	response.write rs("shopxpvjia")
	else
	response.write rs("shopxphyjia")
	end if%>
                          元</td>
                                <td><%=rs("productcount")%></td>
                               <td><%=rs("zonger")%> 元</td>
                              </tr>
                              <%
jianshu=jianshu+rs("productcount")
zongji=zongji+rs("zonger")
'算每件商品的浮动价
set rs_s=server.CreateObject("adodb.recordset")
rs_s.open "select * from shopxp_fudong where id="&rs("banci"),conn,1,1 
fudongjia=fudongjia+rs("productcount")*fudongjia_dj
rs_s.close
set rs_s=nothing

firstshjid=rs("shjiaid")
rs.movenext
if not rs.eof then
nextshjid=rs("shjiaid")
end if
if rs.recordcount<>1 and firstshjid<>nextshjid then
response.write "<script language=javascript>alert('对不起，您选购的商品不属于同一个商家，请重新下订单！');window.close();</script>"
exit do
end if
loop
rs.close
set rs=nothing%>
                              <tr bgcolor=#ffffff>
                                <td height=30 colspan=6 align=center>货款总计：<font color=red><%=zongji%></font> 元&nbsp;&nbsp;&nbsp;&nbsp;
								
								</td>
                              </tr>
                              <%set Godbook=server.CreateObject("adodb.recordset")
Godbook.open "select * from shopxp_action_jp where username='"&username&"' and zhuangtai=7",conn,1,1
if Godbook.recordcount>0 then%>
                              <tr>
                                <td colspan=6 bgcolor=#ffffff><table width="95%" border="0" cellspacing="1" cellpadding="1" bgcolor="#cccccc" align="center">
                                    <tr bgcolor="#ffffff">
                                      <td colspan="2" align="center">您已选择的奖品清单</td>
                                    </tr>
                                    <tr align="center" bgcolor="#f1f1f1">
                                      <td>奖品名称</td>
                                      <td>使用积分</td>
                                    </tr>
                                    <%
while not Godbook.eof%>
                                    <tr bgcolor="#ffffff">
                                      <td align="center"><%
	set Godbook1=server.CreateObject("adodb.recordset")
	Godbook1.open "select * from shopxp_jiangpin where shopxpptid="&Godbook("shopxpptid"),conn,1,1
	if Godbook1.recordcount=1 then
	response.write "<font color=blue>"&Godbook1("shopxpptname")&"</font>"
	end if
	Godbook1.close
	set Godbook1=nothing%>
                                      </td>
                                      <td align="center"><%=Godbook("jifen")%></td>
                                    </tr>
                                    <%Godbook.movenext
wend%>
                                </table></td>
                              </tr>
                              <%end if
Godbook.close
set Godbook=nothing%>
                            </table>
                            <br>
                        </td>
                      </tr>
                      <tr bgcolor="#ffffff">
                        <td width="50%" align="center" valign="top"><table width="90%" border="0" cellpadding="2" cellspacing="1" bgcolor="#CCCCCC">
                            <tr>
                              <td colspan="2" height="24" bgcolor="#f1f1f1" align="center">您的订单信息</td>
                            </tr>
                            <tr bgcolor="ffffff">
                              <td width="30%" align="center">姓名：</td>
                              <td width="70%" style="PADDING-LEFT: 20px"><%=request("shopxp_shiname")%></td>
                            </tr>
                            <tr bgcolor="ffffff">
                              <td align="center">邮编：</td>
                              <td style="PADDING-LEFT: 20px"><%=request("youbian")%></td>
                            </tr>
                            <tr bgcolor="ffffff">
                              <td align="center">地址：</td>
                              <td style="PADDING-LEFT: 20px"><%=request("shopxp_shdz")%></td>
                            </tr>
                            <tr bgcolor="ffffff">
                              <td align="center">电话：</td>
                              <td style="PADDING-LEFT: 20px"><%=request("usertel")%></td>
                            </tr>
                            <tr bgcolor="ffffff">
                              <td align="center">邮箱：</td>
                              <td style="PADDING-LEFT: 20px"><%=request("useremail")%></td>
                            </tr>
                            <tr bgcolor="ffffff">
                              <td align="center">送货：</td>
                              <td style="PADDING-LEFT: 20px"><%
set rs=server.CreateObject("adodb.recordset")
rs.open "select * from shopxp_songhuo where songid="&request("shopxp_shfs"),conn,1,1
response.write rs("subject")
rs.close
set rs=nothing%>
                              </td>
                            </tr>
                            <tr bgcolor="ffffff">
                              <td align="center">支付：</td>
                              <td style="PADDING-LEFT: 20px"><%
set rs=server.CreateObject("adodb.recordset")
rs.open "select * from shopxp_songhuo where songid="&request("zhifufangshi"),conn,1,1
response.write rs("subject")
rs.close
set rs=nothing%>
                              </td>
                            </tr>
                        </table></td>
                        <td width="50%" align="center" valign="top"><table width="90%" border="0" cellpadding="2" cellspacing="1" bgcolor="#CCCCCC">
                            <tr>
                              <td colspan="2" height="24" bgcolor="#f1f1f1" align="center">送货费计算</td>
                            </tr>
                            <%
'计算费用
'先取出参数
set rs=server.CreateObject("adodb.recordset")
rs.open "select * from shopxp_sys ",conn,1,1
t_sm1=rs("sm1")
t_sm2=rs("sm2")
t_sm3=rs("sm3")
t_py1=rs("py1")
t_py2=rs("py2")
t_py3=rs("py3")
t_ems1=rs("ems1")
t_ems2=rs("ems2")
t_ems3=rs("ems3")

'先看是不是送货
set rs=server.CreateObject("adodb.recordset")
rs.open "select * from shopxp_songhuo where songid="&trim(request("shopxp_shfs")),conn,1,1
if cint(request("shopxp_shfs"))=3 then	'先看是不是送货
	rs.close
	if request.Cookies("shopxp")("reglx")=2 then
		if zongji>=t_sm3 then 
		jijia=0
		else
		jijia=t_sm1
		end if
	else
		if zongji>=t_sm2 then 
		jijia=0
		else
		jijia=t_sm1
		end if
	end if
	feiyong=jijia+fudongjia
else
	'不是送货上门的还要看是什么方式送货
	if cint(request("shopxp_shfs"))=1 then	'看是不是"普通平邮"
		rs.close
		if request.Cookies("shopxp")("reglx")=2 then
			if zongji>=t_py2 then 
			jijia=t_py1-t_py3
			else
			jijia=t_py1
			end if
			else
			jijia=t_py1
		end if
		else
		rs.close
		if request.Cookies("shopxp")("reglx")=2 then
			if zongji>=t_ems2 then 
			jijia=t_ems1-t_ems3
			else
			jijia=t_ems1
			end if
			else
			jijia=t_ems1
		end if
		end if
		'算商品基价+浮动价=费用
	
	feiyong=jijia+fudongjia
	if request("zhifufangshi")=17 then
          '得到预存款
          set rs2=server.CreateObject("adodb.recordset")
          rs2.Open "select yucun from [Dv_User] where username='"&username&"'",conn,1,1
          yucunkuan=rs2("yucun")
          rs2.close
          set rs2=nothing
	  if yucunkuan<feiyong+zongji then
	  	response.write "<script language=javascript>alert('您的预存款不足，请更换支付方式！');history.go(-1);</script>"
	end if
	end if
	end if
	zj=feiyong+zongji
	%>
                            <tr>
                              <td style="PADDING-right: 20px" align="right" bgcolor="ffffff"><%
set rs5=server.CreateObject("adodb.recordset")
rs5.open "select * from shopxp_songhuo where songid="&request("shopxp_shfs"),conn,1,1
response.write rs5("subject")&"&nbsp;"
response.write rs5("jsmoney")&"元"
jsmoney=rs5("jsmoney")
rs5.close
set rs5=nothing%>
                              &nbsp;</td>
                            </tr>
                            <tr>
                              <td style="PADDING-right: 20px" align="right" bgcolor="ffffff"><font color=red>您的订单总金额：<%=jsmoney+zongji%> 元 </font><%feiyong=jsmoney%></td>
                            </tr><% session("payall")=feiyong+zongji %>
                            <tr>
                              <td style="PADDING-right: 20px" align="right" bgcolor="ffffff"><a href="shopxphelp.asp?action=feiyong" >查看送货费用说明</a></td>
                            </tr>
                        </table></td>
                      </tr>
                      <form name="shouhuoxx" method="post" action="jsactionshopxp.asp?action=ok">
                        <tr bgcolor="#ffffff" align="center">
                          <td colspan="2"><table width="95%" border="0" cellspacing="0" cellpadding="2">
                              <tr>
                                <td width="20%"><input type="checkbox" name="fapiao" value="1">
                            是否要发票？
                              <input name="shopxp_shiname" type="hidden" value=<%=trim(request("shopxp_shiname"))%>>
                              <input name="shousex" type="hidden" value=<%=trim(request("shousex"))%>>
                              <input name="useremail" type="hidden" value=<%=trim(request("useremail"))%>>
                              <input name="shopxp_shdz" type="hidden" value=<%=trim(request("shopxp_shdz"))%>>
                              <input name="youbian" type="hidden" value=<%=trim(request("youbian"))%>>
                              <input name="usertel" type="hidden" value=<%=trim(request("usertel"))%>>
                              <input name="shopxp_shfs" type="hidden" value=<%=trim(request("shopxp_shfs"))%>>
                              <input name="zhifufangshi" type="hidden" value=<%=trim(request("zhifufangshi"))%>>
                              <input name="feiyong" type="hidden" value=<%=feiyong%>>
                              <input name="zongji" type="hidden" value=<%=zongji%>>
                              <input name=userid type=hidden value="<%=request("userid")%>" >
                                </td>
                                <td width="60%"><input class="wenbenkuang" type="text" name="liuyan" size="35" maxlength="30">
                            您对此订单的特殊说明(30字内) </td>
                                <td width="20%" align="center" height="60"><input class="go-wenbenkuang" type="button" name="Submit22" value="上一步" onClick="javascript:history.go(-1)">
                                    <input class="go-wenbenkuang" type="submit" name="Submit42" value="完　成">
                                </td>
                              </tr>
                          </table></td>
                        </tr>
                      </form>
                  </table></td>
                </tr>
              </table>
              <%
case "ok"
'/////////////////////////////////////////////////
function HTMLEncode2(fString)
	fString = Replace(fString, CHR(13), "")
	fString = Replace(fString, CHR(10) & CHR(10), "</P><P>")
	fString = Replace(fString, CHR(10), "<BR>")
	HTMLEncode2 = fString
end function

'修改用户的送货信息
set rs=server.CreateObject("adodb.recordset")
rs.open "select * from [Dv_User] where username='"&username&"'",conn,1,3
rs("shopxp_shiname")=trim(request("shopxp_shiname"))
rs("sex")=trim(request("shousex"))
rs("useremail")=trim(request("useremail"))
rs("shopxp_shdz")=trim(request("shopxp_shdz"))
rs("youbian")=trim(request("youbian"))
rs("usertel")=trim(request("usertel"))
rs("shopxp_shfs")=trim(request("shopxp_shfs"))
rs("zhifufangshi")=trim(request("zhifufangshi"))
rs.update
rs.close
set rs=nothing

if session("xiadan")<>minute(now) then
'再判断库存
'未写

dim shijian,dingdan
shijian=now()
'dingdan=year(shijian)&month(shijian)&day(shijian)&hour(shijian)&minute(shijian)&second(shijian)
'response.write shopxpptid
set rs=server.CreateObject("adodb.recordset")
rs.open "select * from shopxp_action where username='"&username&"' and zhuangtai=7",conn,1,3
if request.Cookies("shopxp")("username")<>"" then
'dingdan=year(shijian)&month(shijian)&day(shijian)&hour(shijian)&minute(shijian)&second(shijian)
dingdan=now()
dingdan=replace(trim(dingdan),"-","")
dingdan=replace(dingdan,":","")
dingdan=replace(dingdan," ","")
else
dingdan=username
end if
do while not rs.eof
'得到价格，减库存
set rs2=server.CreateObject("adodb.recordset")
rs2.open "select * from shopxp_product where shopxpptid="&rs("shopxpptid"),conn,1,3
if request.Cookies("shopxp")("reglx")=2 then 
danjia=rs2("shopxpvjia")
else
danjia=rs2("shopxphyjia")
end if
rs2("shopxpcjiao")=rs2("shopxpcjiao")+rs("productcount")
rs2("kucun")=rs2("kucun")-rs("productcount")
rs2.update
rs2.close
set rs2=nothing
'rs.addnew
'rs("username")=trim(request.cookies("bookshop")("username"))
'rs("shopxpptid")=rs2("shopxpptid")
rs("actiondate")=shijian
'rs("productcount")=CInt(Request("Godbook"&rs2("shopxpptid")))
if request("zhifufangshi")=17 then    '送货上门或预存款支付，直接改为订单完成（已收到款）
rs("zhuangtai")=3
else
rs("zhuangtai")=1
end if
rs("dingdan")=dingdan
rs("youbian")=int(request("youbian"))
rs("shouhuoname")=trim(request("shopxp_shiname"))
rs("shopxp_shdz")=trim(request("shopxp_shdz"))
rs("zhifufangshi")=int(request("zhifufangshi"))
rs("shopxp_shfs")=int(request("shopxp_shfs"))
rs("shousex")=int(request("shousex"))
rs("liuyan")=HTMLEncode2(trim(request("liuyan")))
'rs("zonger")=request("zongji")
rs("shopxp_shiname")=trim(request("shopxp_shiname"))
rs("useremail")=trim(request("useremail"))
rs("usertel")=trim(request("usertel"))
rs("userid")=request("userid")
'新增
if request("fapiao")<>1 then 
fapiao=0
else
fapiao=1
end if
rs("fapiao")=fapiao
rs("feiyong")=request("feiyong")
rs("danjia")=danjia
rs.update
'rs.close
'set rs=nothing
'conn.execute "delete from shopxp_action where username='"&request.cookies("bookshop")("username")&"' and shopxpptid in ("&shopxpptid&") and zhuangtai=6"
rs.movenext
loop
rs.close
set rs=nothing
'再改奖品
z_jifen=0
set rs=server.CreateObject("adodb.recordset")
rs.open "select * from shopxp_action_jp where username='"&username&"' and zhuangtai=7",conn,1,3
do while not rs.eof
rs("actiondate")=shijian
rs("zhuangtai")=5
rs("dingdan")=dingdan
rs("userid")=request("userid")
z_jifen=z_jifen+rs("jifen")
rs.update
rs.movenext
loop
rs.close
set rs=nothing
'减去积分
set rs=server.CreateObject("adodb.recordset")
rs.open "select * from [Dv_User] where username='"&username&"'",conn,1,3
rs("jifen")=rs("jifen")-z_jifen
'如果是在线支付，要扣预存款
if request("zhifufangshi")=17 then 
rs("yucun")=rs("yucun")-request("feiyong")-request("zongji")
end if
rs.update
rs.close
set rs=nothing

session("xiadan")=minute(now)
else
response.Write "<center>您不能重复提交！</center>"
response.End
end if

%>
              <table width="100%" height="44" border="0" align="center" cellpadding="0" cellspacing="0">
                <tr>
                  <td height=44 valign="bottom">　<strong><a href=index.asp><%=webname%></a> >>定单提交成功</strong></td>
                </tr>
              </table>
              <table width="650" align="center" border="0" cellspacing="0" cellpadding="0">
                <tr>
                  <td bgColor=#ffffff height=1></TD>
                </tr>
                <tr bgcolor="#ffffff">
                  <td height="39" align="center" background="img_shopxp/xiao/200309baskettitlebar.gif">您的订单已经成功提交，我们会在第一时间进行处理，请记清您的订单号以备查询。</td>
                </tr>
                <tr>
                  <td bgColor=#cccccc height=1></TD>
                </tr>
                <tr>
                  <td bgColor=#f1f1f1 height=2></TD>
                </tr>
                <tr>
                  <td height="30" bgcolor="ffffff" style="PADDING-LEFT: 100px">订单号：<font color=red><%=dingdan%></font></td>
                <%session("dingdan")=dingdan%>
				</tr>
											  				                                        <% sum2=0
			  sums2=0

mailbodys="<SPAN style='FONT-SIZE: 12px'>亲爱的客户"&username&"您好!"
mailbodys=mailbodys&"<br>"
mailbodys=mailbodys&"&nbsp;&nbsp;&nbsp;&nbsp; 您在"&webname&"下的订单号是:"&dingdan&"</span><table width='600' border='0' bgcolor='#cccccc' align='center' cellpadding='2' cellspacing='1'><tr bgcolor='#e0e0e0' align='center'>"
%>
                <%if request.Cookies("shopxp")("username")<>"" then%>
                <tr>
                  <td height="30" bgcolor="ffffff" style="PADDING-LEFT: 100px">订单查询：您可通过“<a href="javascript:;" onClick="javascript:window.open('xpuser.asp','','')">我的专区</a>”&gt;&gt;“<a href="javascript:;" onClick="javascript:window.open('xpuser.asp?action=dingdan','','')">我的订单</a>”查询您的订单状态。</td>
                </tr>
                <tr>
                  <td height="30" bgcolor="ffffff" style="PADDING-LEFT: 100px">购物积分：请在收货后通过“<a href="javascript:;" onClick="javascript:window.open('xpuser.asp','','')">我的专区</a>”&gt;&gt;“<a href="javascript:;" onClick="javascript:window.open('xpuser.asp?action=dingdan','','')">我的订单</a>”及时更改您的订单状态为“完成”，因为每笔订单的积分只有在订单完成后才能累计到您的购物积分中。 </td>
                </tr>
                <%else%>
                <tr>
                  <td height="30" bgcolor="ffffff" style="PADDING-LEFT: 100px">订单查询：因为您不是我们的会员，所以您不能查询您的订单状态。</td>
                </tr>
                <tr>
                  <td height="30" bgcolor="ffffff" style="PADDING-LEFT: 100px">购物积分：因为您不是我们的会员，所以您不能获得积分奖励。 </td>
                </tr>
                <%
		  end if
		  if request("zhifufangshi")=17 then %>
                <tr>
                  <td height="30" bgcolor="ffffff" style="PADDING-LEFT: 100px">您是通过预存款支付的，我们会尽快地给你发货的！</td>
                  <script language=javascript>alert('您是通过预存款支付的，我们会尽快地给你发货的！');</script>
                </tr>
                <%else
set rs=server.CreateObject("adodb.recordset")
rs.open "select * from shopxp_songhuo where songid="&trim(request("zhifufangshi")),conn,1,1
if trim(rs("subject"))="货到付款" then
rs.close
set rs=nothing
%>
                <tr>
                  <td height="30" bgcolor="ffffff" style="PADDING-LEFT: 100px">您是选择的“货到付款”，我们会尽快给您送货的！</td>
                  <script language=javascript>alert('您是选择的“货到付款”，请确认您的订单，我们会尽快给您送货的！');</script>
                </tr>
                <%else
rs.close
set rs=nothing%>
                <tr>
                  <td height="30" bgcolor="ffffff" style="PADDING-LEFT: 100px">请您在一周内依照您选择的支付方式进行汇款，汇款时请注明您的<font color="#FF0000">订单号</font>！</td>
               
                </tr>
                <%end if%>
                <%end if%>
                <tr>
                  <td height="30" bgcolor="ffffff" style='PADDING-LEFT: 100px' align="right"><a href="#" onClick=javascript:window.close()> 关闭窗口</a><font color="#999999">　订单提交完成 创建时间：<%=shijian%>&nbsp;</font> </td>
                </tr>
              </table>
              <table width="100%" height="46"  border="0" cellpadding="0" cellspacing="0">
          <tr>
            <td width="50%"><div align="center" class="style1"><a href="xpChecklist1xp.asp" target="_blank" class="style3"><img src="img_shopxp/zhifu_wangyin.gif" width="237" height="81" border="0"></a> 　</a> </div></td>
            <td width="50%">　
                    <%


set rsb=server.CreateObject("adodb.recordset")
rsb.open "select * from shopxp_sys ",conn,1,3

dim sj
sj=now()
sj=replace(trim(sj),"-","")
sj=replace(sj,":","")
sj=replace(sj," ","")

	Dim goodsBid,ordinaryFee,expressFee,sellerEmail,goodsTitle,securityCode,Cmd,Subject,Body
	Dim myAlipayObj,ResponseTxt1,ResponseTxt2,ResponseTxt3
	
	'六个必要参数,您可以设置成表单或链接提交表单/请求链接的方式
	
	goodsBid			= session("payall")	'商品价格
	
	'ordinaryFee 			= rsb("py1")	'平邮费用
	'expressFee			= rsb("ems1")  	'快递费用
	sellerEmail			= alipayid	'您的支付宝认证Email,必须通过支付宝认证才可以
	goodsTitle			= sj  '订单编号
	securityCode		= alipaymd5  '安全校验码,在支付宝网站“商家工具”那里可以获得
	Cmd					= "0001"' 命令编号
	Subject				= "订单号"&session("dingdan")		'商品名称
	Body				= "此订单来自--"&webname	'商品描述

	 '  创建一个myAlipay实例,并初始化myAlipay_Initialize()
	Set myAlipayObj		= New myAlipay
	myAlipayObj.myAlipay_Initialize()

	'ResponseTxt1为请求i_link处理链接后生成的支付链接
	ResponseTxt1		= myAlipayObj.getTradeButtonURL(goodsBid,ordinaryFee,expressFee,sellerEmail,goodsTitle,securityCode)
	'ResponseTxt2为采用MD5等方法自动组合生成的支付链接,支持商品中文名称
	ResponseTxt2		= myAlipayObj.generateTradeButtonURL(goodsBid,ordinaryFee,expressFee,sellerEmail,goodsTitle,securityCode)
	'ResponseTxt3为采用MD5等方法自动组合生成的payto支付链接,支持商品中文名称
	ResponseTxt3		= myAlipayObj.generatePaytoURL(goodsBid,ordinaryFee,expressFee,sellerEmail,goodsTitle,securityCode,Cmd,Subject,Body)
%>
                    <a href="<%=ResponseTxt3%>" target="_blank"> <img src="img_shopxp/zhifu_zhfb.gif" width="237" height="81" border="0"></td>
          </tr>
        </table>
			  <%
		response.Cookies("shopxp")("dingdanusername")=""
		end select%></TD>
          <td width="1" background="img_shopxp/xiao/bgbg.gif"></td>
        </TR>
      </TBODY>
    </TABLE>                
</td>
	</tr>
</table>
<tr>
  <td width="759" rowspan="2" valign="top"><table width="985"  border="0" align="center" cellpadding="0" cellspacing="0">
    <tr>
      <td><!--#include file="copyright_shopxp.asp"-->
      </table>
  
</body>
</html>
<script language=javascript>
<!--
function regInput(obj, reg, inputStr)
{
	var docSel	= document.selection.createRange()
	if (docSel.parentElement().tagName != "INPUT")	return false
	oSel = docSel.duplicate()
	oSel.text = ""
	var srcRange	= obj.createTextRange()
	oSel.setEndPoint("StartToStart", srcRange)
	var str = oSel.text + inputStr + srcRange.text.substr(oSel.text.length)
	return reg.test(str)
}
function checkspace(checkstr) {
  var str = '';
  for(i = 0; i < checkstr.length; i++) {
    str = str + ' ';
  }
  return (str == checkstr);
}
   //-->
</script> 




